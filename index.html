<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>교회 사랑방 출석체크</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #f9fafb; min-height: 100vh; }

    .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1.5rem 1rem; position: sticky; top: 0; z-index: 100; }
    .header-content { max-width: 1200px; margin: 0 auto; position: relative; }
    .header-title { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    h1 { font-size: 1.5rem; color: #111827; }
    .subtitle { color: #6b7280; font-size: 0.875rem; }

    .admin-button { position: absolute; top: 0; right: 0; background: #6b7280; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: 0.875rem; }
    .admin-button:hover { background: #4b5563; }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }

    /* 홈 팀 카드 */
    .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .team-card { background: white; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s; }
    .team-card:hover { border-color: #2563eb; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .team-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .team-number { width: 3rem; height: 3rem; background: #dbeafe; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: #2563eb; font-weight: bold; font-size: 1.25rem; }
    .team-card:hover .team-number { background: #2563eb; color: white; }
    .member-count { background: #f3f4f6; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; color: #6b7280; }
    .team-name { font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 0.25rem; }

    .back-button { display: flex; align-items: center; gap: 0.5rem; color: #6b7280; background: none; border: none; cursor: pointer; font-size: 1rem; margin-bottom: 1rem; padding: 0.5rem; }
    .back-button:hover { color: #111827; }

    /* 날짜/요약 */
    .date-section { background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1.25rem; }
    .date-label { font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
    .date-input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 16px; } /* 모바일 확대 방지 */

    .summary-box { background: #eff6ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #bfdbfe; margin-bottom: 1rem; }
    .summary-content { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .summary-count { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
    .progress-bar { background: #e5e7eb; border-radius: 9999px; height: 0.5rem; overflow: hidden; }
    .progress-fill { background: #2563eb; height: 100%; transition: width 0.3s; }

    /* 검색 + 그리드(스크롤 최적화) */
    .search-section { background: white; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1rem; }
    .search-input { width: 100%; padding: 0.65rem 0.9rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 16px; } /* 모바일 확대 방지 */

    .member-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    @media (min-width: 768px) {
      .member-list { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    }

    .member-item { background: white; padding: 0.85rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; transition: all 0.2s; }
    .member-item.checked { background: #eff6ff; border-color: #2563eb; }

    .member-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; gap: 0.5rem; }
    .member-name { font-size: 1rem; font-weight: 700; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .checkbox { width: 1.75rem; height: 1.75rem; border-radius: 9999px; border: 2px solid #d1d5db; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .member-item.checked .checkbox { background: #2563eb; border-color: #2563eb; }
    .checkmark { display: none; color: white; font-weight: bold; font-size: 0.95rem; }
    .member-item.checked .checkmark { display: block; }

    /* 특이사항(아래 고정) */
    .note-section { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; }
    .note-label { font-size: 0.8rem; font-weight: 700; color: #6b7280; margin-bottom: 0.35rem; }
    .note-input { width: 100%; padding: 0.55rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 16px; } /* 모바일 확대 방지 */

    /* 건의사항 */
    .suggestion-section { background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
    .suggestion-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 16px; min-height: 80px; } /* 모바일 확대 방지 */

    /* 하단 저장바 */
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    .sticky-actions {
      position: sticky;
      bottom: 0;
      background: rgba(249, 250, 251, 0.95);
      border-top: 1px solid #e5e7eb;
      padding: 0.75rem 0 calc(0.75rem + var(--safe-bottom)) 0;
      backdrop-filter: blur(6px);
    }
    .save-button { width: 100%; background: #2563eb; color: white; padding: 0.95rem; border-radius: 0.5rem; border: none; font-size: 1.05rem; font-weight: 800; cursor: pointer; }
    .save-button:hover { background: #1d4ed8; }

    .message { padding: 0.85rem 1rem; border-radius: 0.5rem; text-align: center; font-weight: 700; margin-top: 0.75rem; }
    .message.success { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
    .message.error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

    /* 관리자 대시보드 */
    .dashboard-tabs { display: flex; gap: 1rem; margin-bottom: 1.25rem; border-bottom: 2px solid #e5e7eb; }
    .tab-button { padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px; font-weight: 700; }
    .tab-button.active { color: #2563eb; border-bottom-color: #2563eb; }

    .admin-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
    }
    @media (max-width: 640px) {
      .dashboard-tabs { flex-wrap: wrap; gap: 0.5rem; border-bottom: 1px solid #e5e7eb; }
      .tab-button { flex: 1 1 140px; text-align: center; padding: 0.65rem 0.75rem; }
      .admin-summary { grid-template-columns: 1fr; }
      .container { padding: 1rem 1rem; }
      .header { padding: 1rem 1rem; }
    }

    .admin-summary-card { background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
    .admin-summary-label { font-size: 0.875rem; color: #6b7280; font-weight: 700; margin-bottom: 0.25rem; }
    .admin-summary-value { font-size: 1.6rem; font-weight: 900; color: #111827; }
    .admin-summary-note { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }

    .attendance-table, .notes-table { background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb; overflow-x: auto; }
    .attendance-table table, .notes-table table { width: 100%; border-collapse: collapse; }
    .attendance-table th, .notes-table th { background: #f9fafb; padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 800; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
    .attendance-table td, .notes-table td { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; vertical-align: top; }

    .suggestion-list { background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb; padding: 1rem; }
    .suggestion-item { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
    .suggestion-team { font-weight: 900; color: #111827; }

    .hidden { display: none; }

    /* 비밀번호 모달 */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 999;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      background: white;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    .modal-header {
      padding: 1rem 1rem 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-title { font-size: 1.1rem; font-weight: 900; color: #111827; }
    .modal-subtitle { margin-top: 0.25rem; font-size: 0.9rem; color: #6b7280; }
    .modal-body { padding: 1rem; }
    .modal-input {
      width: 100%;
      padding: 0.8rem 0.9rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 16px;
    }
    .modal-error { margin-top: 0.75rem; color: #b91c1c; font-weight: 700; font-size: 0.9rem; }
    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      padding: 0 1rem 1rem 1rem;
    }
    .modal-btn {
      border: none;
      border-radius: 0.5rem;
      padding: 0.85rem 0.9rem;
      font-weight: 900;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .modal-btn.primary { background: #2563eb; color: white; }
    .modal-btn.primary:hover { background: #1d4ed8; }
    .modal-btn.ghost { background: #f3f4f6; color: #111827; }
    .modal-btn.ghost:hover { background: #e5e7eb; }
  </style>
</head>

<body>
  <!-- 홈 -->
  <div id="homePage">
    <div class="header">
      <div class="header-content">
        <button class="admin-button" onclick="openAdminPassword()">관리자</button>
        <div class="header-title"><h1>사랑방 출석체크</h1></div>
        <p class="subtitle">사랑방을 선택해주세요</p>
      </div>
    </div>
    <div class="container">
      <div class="team-grid" id="teamGrid"></div>
    </div>
  </div>

  <!-- 출석 페이지 -->
  <div id="attendancePage" class="hidden">
    <div class="header">
      <div class="header-content">
        <button class="back-button" onclick="goHome()">← 돌아가기</button>
        <h1 id="selectedTeamName"></h1>
        <p class="subtitle" id="selectedTeamLeader"></p>
      </div>
    </div>

    <div class="container">
      <div class="date-section">
        <div class="date-label">날짜 선택</div>
        <input type="date" class="date-input" id="dateInput" />
      </div>

      <div class="summary-box">
        <div class="summary-content">
          <span>출석 현황</span>
          <span class="summary-count" id="attendanceCount">0 / 0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="search-section">
        <input id="memberSearch" class="search-input" placeholder="이름 검색 (예: 홍길동)" />
      </div>

      <div class="member-list" id="memberList"></div>

      <div class="suggestion-section">
        <div class="date-label">건의사항 (선택)</div>
        <textarea class="suggestion-textarea" id="suggestionInput" placeholder="건의사항을 작성해주세요"></textarea>
      </div>

      <div class="sticky-actions">
        <button class="save-button" onclick="saveAttendance()">출석 정보 저장</button>
        <div id="messageBox" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- 관리자 대시보드 -->
  <div id="adminDashboard" class="hidden">
    <div class="header">
      <div class="header-content">
        <button class="back-button" onclick="goHome()">← 돌아가기</button>
        <h1>관리자 대시보드</h1>
      </div>
    </div>

    <div class="container">
      <div class="dashboard-tabs">
        <button class="tab-button active" onclick="switchAdminTab('stats')">출석 현황</button>
        <button class="tab-button" onclick="switchAdminTab('notes')">특이사항</button>
        <button class="tab-button" onclick="switchAdminTab('suggestions')">건의사항</button>
      </div>

      <div id="adminStatsTab">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminDateInput" />
        </div>

        <div class="admin-summary">
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 출석</div>
            <div class="admin-summary-value" id="adminTotalPresent">0명</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 결석</div>
            <div class="admin-summary-value" id="adminTotalAbsent">0명</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 출석률</div>
            <div class="admin-summary-value" id="adminTotalRate">0%</div>
          </div>
        </div>
        <div class="admin-summary-note" id="adminSummaryNote"></div>

        <div class="attendance-table" id="attendanceTable"></div>
      </div>

      <div id="adminNotesTab" class="hidden">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminNotesDateInput" />
        </div>
        <div class="notes-table" id="notesTable"></div>
      </div>

      <div id="adminSuggestionsTab" class="hidden">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminSugDateInput" />
        </div>
        <div class="suggestion-list" id="suggestionsList"></div>
      </div>
    </div>
  </div>

  <!-- 비밀번호 모달 -->
  <div id="passwordModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">비밀번호 입력</div>
        <div class="modal-subtitle" id="modalSubtitle"></div>
      </div>
      <div class="modal-body">
        <input type="password" id="modalPassword" class="modal-input" placeholder="비밀번호" />
        <div id="modalError" class="modal-error hidden"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn ghost" onclick="closePasswordModal()">취소</button>
        <button class="modal-btn primary" onclick="submitPasswordModal()">확인</button>
      </div>
    </div>
  </div>

  <script>
    // ====== 설정 ======
    var GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';

    // 관리자 비밀번호
    var ADMIN_PASSWORD = 'newwave2026';

    // 사랑방 정보 + 사랑방별 비밀번호(password) 추가
    // ✅ 여기 password를 실제 값으로 변경하세요
    var TEAMS = [
      {id:1,name:'권준형 사랑방',leader:'방장: 권준형',password:'1111',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:2,name:'김나림 사랑방',leader:'방장: 김나림',password:'2222',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:3,name:'문유안 사랑방',leader:'방장: 문유안',password:'3333',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:4,name:'벡에스더 사랑방',leader:'방장: 벡에스더',password:'4444',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:5,name:'이예정 사랑방',leader:'방장: 이예정',password:'5555',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:6,name:'이지빈 사랑방',leader:'방장: 이지빈',password:'6666',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:7,name:'이하은 사랑방',leader:'방장: 이하은',password:'7777',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:8,name:'이희진 사랑방',leader:'방장: 이희진',password:'8888',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:9,name:'임사랑 사랑방',leader:'방장: 임사랑',password:'9999',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:10,name:'장하늘 사랑방',leader:'방장: 장하늘',password:'1010',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:11,name:'하재영 사랑방',leader:'방장: 하재영',password:'1110',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:12,name:'Wee팀',leader:'방장: Wee팀',password:'1212',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']}
    ];

    // ===== 상태 =====
    var selectedTeam = null;
    var attendance = {};
    var memberNotes = {};

    // 날짜 기본값
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').value = today;
    document.getElementById('adminDateInput').value = today;
    document.getElementById('adminNotesDateInput').value = today;
    document.getElementById('adminSugDateInput').value = today;

    // 로컬 저장 키
    var STORAGE_PREFIX = 'nw_attendance_v1';
    function storageKey(teamId, date) { return STORAGE_PREFIX + ':' + teamId + ':' + date; }
    function submittedKey(teamId, date) { return storageKey(teamId, date) + ':submitted'; }

    function safeParseJSON(s) { try { return JSON.parse(s); } catch(e) { return null; } }
    function cssEsc(v) { if (window.CSS && CSS.escape) return CSS.escape(v); return String(v).replace(/["\\]/g, '\\$&'); }

    // ===== 비밀번호 모달 =====
    var modalState = { mode: null, team: null };

    function openPasswordModal(opts) {
      modalState.mode = opts.mode || null;
      modalState.team = opts.team || null;

      document.getElementById('modalTitle').textContent = opts.title || '비밀번호 입력';
      document.getElementById('modalSubtitle').textContent = opts.subtitle || '';
      document.getElementById('modalPassword').value = '';
      document.getElementById('modalError').classList.add('hidden');
      document.getElementById('modalError').textContent = '';

      document.getElementById('passwordModal').classList.remove('hidden');
      setTimeout(function(){ document.getElementById('modalPassword').focus(); }, 0);
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.add('hidden');
      modalState.mode = null;
      modalState.team = null;
    }

    function setModalError(msg) {
      var el = document.getElementById('modalError');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function submitPasswordModal() {
      var pw = document.getElementById('modalPassword').value || '';

      if (modalState.mode === 'admin') {
        if (pw === ADMIN_PASSWORD) {
          sessionStorage.setItem('admin_auth', '1');
          closePasswordModal();
          showAdminDashboard();
        } else {
          setModalError('비밀번호가 틀렸습니다.');
        }
        return;
      }

      if (modalState.mode === 'team' && modalState.team) {
        if (pw === modalState.team.password) {
          sessionStorage.setItem('team_auth:' + modalState.team.id, '1');
          closePasswordModal();
          selectTeam(modalState.team);
        } else {
          setModalError('비밀번호가 틀렸습니다.');
        }
        return;
      }
    }

    // Enter 키로 확인
    document.getElementById('modalPassword').addEventListener('keydown', function(e){
      if (e.key === 'Enter') submitPasswordModal();
      if (e.key === 'Escape') closePasswordModal();
    });

    // ===== 접근 로직 =====
    function openAdminPassword() {
      openPasswordModal({
        mode: 'admin',
        title: '관리자 탭 비밀번호',
        subtitle: '관리자 대시보드에 प्रवेश하려면 비밀번호를 입력하세요.'
      });
    }

    function attemptEnterTeam(team) {
      // 이미 인증된 세션이면 바로 입장
      if (sessionStorage.getItem('team_auth:' + team.id) === '1') {
        selectTeam(team);
        return;
      }
      openPasswordModal({
        mode: 'team',
        team: team,
        title: team.name + ' 비밀번호',
        subtitle: '해당 사랑방장만 출석/특이사항을 수정할 수 있습니다.'
      });
    }

    // ===== 로컬 저장/복원 =====
    function persistLocal() {
      if (!selectedTeam) return;
      var date = document.getElementById('dateInput').value;
      var payload = {
        attendance: attendance || {},
        notes: memberNotes || {},
        suggestion: document.getElementById('suggestionInput').value || ''
      };
      localStorage.setItem(storageKey(selectedTeam.id, date), JSON.stringify(payload));
    }

    function restoreLocal() {
      if (!selectedTeam) return;
      var date = document.getElementById('dateInput').value;
      var saved = safeParseJSON(localStorage.getItem(storageKey(selectedTeam.id, date)));

      attendance = (saved && saved.attendance) ? saved.attendance : {};
      memberNotes = (saved && saved.notes) ? saved.notes : {};
      document.getElementById('suggestionInput').value = (saved && saved.suggestion) ? saved.suggestion : '';

      selectedTeam.members.forEach(function(name) {
        var item = document.querySelector('.member-item[data-name="' + cssEsc(name) + '"]');
        if (!item) return;
        item.classList.toggle('checked', !!attendance[name]);

        var input = item.querySelector('.note-input');
        if (input) input.value = memberNotes[name] || '';
      });

      updateCount();
    }

    // ===== 홈 렌더링 =====
    function initTeamGrid(){
      var g = document.getElementById('teamGrid');
      g.innerHTML = '';
      TEAMS.forEach(function(t){
        var c = document.createElement('div');
        c.className = 'team-card';
        c.onclick = function(){ attemptEnterTeam(t); };
        c.innerHTML =
          '<div class="team-card-header">' +
            '<div class="team-number">' + t.id + '</div>' +
            '<div class="member-count">' + t.members.length + '명</div>' +
          '</div>' +
          '<div class="team-name">' + t.name + '</div>' +
          '<p style="font-size:0.875rem;color:#6b7280;">' + t.leader + '</p>';
        g.appendChild(c);
      });
    }

    // ===== 출석 페이지 =====
    function selectTeam(t){
      selectedTeam = t;
      attendance = {};
      memberNotes = {};

      document.getElementById('selectedTeamName').textContent = t.name;
      document.getElementById('selectedTeamLeader').textContent = t.leader;

      var m = document.getElementById('memberList');
      m.innerHTML = '';

      t.members.forEach(function(n){
        var item = document.createElement('div');
        item.className = 'member-item';
        item.setAttribute('data-name', n);

        var header = document.createElement('div');
        header.className = 'member-header';
        header.setAttribute('data-name', n);

        var nameSpan = document.createElement('span');
        nameSpan.className = 'member-name';
        nameSpan.textContent = n;

        var checkbox = document.createElement('div');
        checkbox.className = 'checkbox';
        var mark = document.createElement('span');
        mark.className = 'checkmark';
        mark.textContent = '✓';
        checkbox.appendChild(mark);

        header.appendChild(nameSpan);
        header.appendChild(checkbox);

        var note = document.createElement('div');
        note.className = 'note-section';

        var noteLabel = document.createElement('div');
        noteLabel.className = 'note-label';
        noteLabel.textContent = '특이사항';

        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'note-input';
        input.placeholder = '특이사항 입력';
        input.setAttribute('data-name', n);

        note.appendChild(noteLabel);
        note.appendChild(input);

        item.appendChild(header);
        item.appendChild(note);
        m.appendChild(item);
      });

      document.getElementById('memberSearch').value = '';
      restoreLocal();
      applyMemberFilter('');

      hideAll();
      document.getElementById('attendancePage').classList.remove('hidden');
    }

    function toggleMember(n){
      attendance[n] = !attendance[n];
      var item = document.querySelector('.member-item[data-name="' + cssEsc(n) + '"]');
      if (item) item.classList.toggle('checked', !!attendance[n]);
      updateCount();
      persistLocal();
    }

    function updateCount(){
      var c = 0;
      for (var k in attendance) if (attendance[k]) c++;
      var t = selectedTeam ? selectedTeam.members.length : 0;
      document.getElementById('attendanceCount').textContent = c + ' / ' + t;
      document.getElementById('progressFill').style.width = (t > 0 ? (c / t) * 100 : 0) + '%';
    }

    function showMsg(type, text) {
      var box = document.getElementById('messageBox');
      box.className = 'message ' + (type || '');
      box.textContent = text || '';
      box.classList.remove('hidden');
      setTimeout(function(){ box.classList.add('hidden'); }, 2500);
    }

    function saveAttendance(){
      if (!selectedTeam) return;
      var dateVal = document.getElementById('dateInput').value;

      var d = {
        team: selectedTeam.name,
        leader: selectedTeam.leader,
        date: dateVal,
        suggestion: document.getElementById('suggestionInput').value,
        attendance: selectedTeam.members.map(function(m){
          return { name: m, present: attendance[m] || false, note: memberNotes[m] || '' };
        }),
        timestamp: new Date().toISOString()
      };

      // 로컬 저장 + 제출 표시(관리자 집계 기준)
      persistLocal();
      localStorage.setItem(submittedKey(selectedTeam.id, dateVal), new Date().toISOString());

      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(d)
      }).then(function(){
        showMsg('success', '저장되었습니다!');
      }).catch(function(){
        // no-cors라서 에러가 잡히지 않는 환경도 있어 메시지는 로컬 기준으로 안내
        showMsg('success', '저장되었습니다!');
      });
    }

    // ===== 검색 필터 =====
    function applyMemberFilter(q){
      q = (q || '').trim().toLowerCase();
      var items = document.querySelectorAll('#memberList .member-item');
      for (var i=0; i<items.length; i++){
        var name = (items[i].getAttribute('data-name') || '').toLowerCase();
        items[i].style.display = name.indexOf(q) >= 0 ? '' : 'none';
      }
    }

    // ===== 관리자 대시보드 =====
    function showAdminDashboard() {
      hideAll();
      document.getElementById('adminDashboard').classList.remove('hidden');
      loadAdminData();
    }

    function switchAdminTab(tab){
      var buttons = document.querySelectorAll('.tab-button');
      for (var i=0; i<buttons.length; i++) buttons[i].classList.remove('active');

      // 버튼 활성화
      if (tab === 'stats') buttons[0].classList.add('active');
      if (tab === 'notes') buttons[1].classList.add('active');
      if (tab === 'suggestions') buttons[2].classList.add('active');

      // 탭 표시
      document.getElementById('adminStatsTab').classList.toggle('hidden', tab !== 'stats');
      document.getElementById('adminNotesTab').classList.toggle('hidden', tab !== 'notes');
      document.getElementById('adminSuggestionsTab').classList.toggle('hidden', tab !== 'suggestions');

      loadAdminData();
    }

    function loadAdminData(){
      renderAdminStats(document.getElementById('adminDateInput').value || today);
      renderAdminNotes(document.getElementById('adminNotesDateInput').value || today);
      renderAdminSuggestions(document.getElementById('adminSugDateInput').value || today);
    }

    function renderAdminStats(date) {
      var totalPresent = 0;
      var totalMembers = 0;
      var submittedTeams = 0;
      var rows = '';

      TEAMS.forEach(function(team) {
        var payload = safeParseJSON(localStorage.getItem(storageKey(team.id, date)));
        var submittedAt = localStorage.getItem(submittedKey(team.id, date));

        var present = 0;
        var absent = 0;
        var rateStr = '-';
        var status = '미제출';

        if (submittedAt && payload && payload.attendance) {
          status = '제출';
          submittedTeams++;

          present = team.members.reduce(function(acc, name) {
            return acc + (payload.attendance[name] ? 1 : 0);
          }, 0);
          absent = team.members.length - present;

          totalPresent += present;
          totalMembers += team.members.length;

          var rate = team.members.length > 0 ? (present / team.members.length) * 100 : 0;
          rateStr = rate.toFixed(1) + '%';
        } else if (payload && payload.attendance) {
          status = '임시저장';
          present = team.members.reduce(function(acc, name) {
            return acc + (payload.attendance[name] ? 1 : 0);
          }, 0);
          absent = team.members.length - present;

          var tmpRate = team.members.length > 0 ? (present / team.members.length) * 100 : 0;
          rateStr = tmpRate.toFixed(1) + '%';
        }

        rows +=
          '<tr>' +
            '<td>' + team.name + '</td>' +
            '<td>' + team.leader + '</td>' +
            '<td>' + (status === '미제출' ? '-' : present) + '</td>' +
            '<td>' + (status === '미제출' ? '-' : absent) + '</td>' +
            '<td>' + (status === '미제출' ? '-' : rateStr) + '</td>' +
            '<td>' + status + '</td>' +
          '</tr>';
      });

      var totalAbsent = totalMembers - totalPresent;
      var totalRate = totalMembers > 0 ? (totalPresent / totalMembers) * 100 : 0;

      document.getElementById('adminTotalPresent').textContent = totalPresent + '명';
      document.getElementById('adminTotalAbsent').textContent = totalAbsent + '명';
      document.getElementById('adminTotalRate').textContent = totalRate.toFixed(1) + '%';
      document.getElementById('adminSummaryNote').textContent =
        '집계 기준: ' + date + ' / 제출된 사랑방 ' + submittedTeams + '개 / 집계 인원 ' + totalMembers + '명 (※ 미제출/임시저장은 전체 집계에 포함되지 않습니다)';

      document.getElementById('attendanceTable').innerHTML =
        '<table>' +
          '<thead><tr><th>사랑방</th><th>방장</th><th>출석</th><th>결석</th><th>출석률</th><th>상태</th></tr></thead>' +
          '<tbody>' + (rows || '<tr><td colspan="6" style="text-align:center;color:#6b7280;">데이터가 없습니다.</td></tr>') + '</tbody>' +
        '</table>';
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ✅ 특이사항 탭: 사랑방/방원/특이사항을 쭉 테이블로
    function renderAdminNotes(date) {
      var rows = '';
      var count = 0;

      TEAMS.forEach(function(team){
        var payload = safeParseJSON(localStorage.getItem(storageKey(team.id, date)));
        var submittedAt = localStorage.getItem(submittedKey(team.id, date));
        if (!submittedAt || !payload) return;

        var notes = payload.notes || {};
        team.members.forEach(function(member){
          var note = (notes[member] || '').trim();
          if (!note) return;
          count++;
          rows +=
            '<tr>' +
              '<td>' + team.name + '</td>' +
              '<td>' + member + '</td>' +
              '<td style="white-space:pre-wrap;">' + escapeHtml(note) + '</td>' +
            '</tr>';
        });
      });

      document.getElementById('notesTable').innerHTML =
        '<table>' +
          '<thead><tr><th>사랑방</th><th>방원</th><th>특이사항</th></tr></thead>' +
          '<tbody>' +
            (rows || '<tr><td colspan="3" style="text-align:center;color:#6b7280;">특이사항이 없습니다.</td></tr>') +
          '</tbody>' +
        '</table>';
    }

    function renderAdminSuggestions(date) {
      var items = [];

      TEAMS.forEach(function(team) {
        var payload = safeParseJSON(localStorage.getItem(storageKey(team.id, date)));
        var submittedAt = localStorage.getItem(submittedKey(team.id, date));
        if (!submittedAt || !payload) return;

        var s = (payload.suggestion || '').trim();
        if (!s) return;

        items.push(
          '<div class="suggestion-item">' +
            '<div class="suggestion-team">' + team.name + ' (' + team.leader + ')</div>' +
            '<div style="margin-top:0.5rem; color:#374151; white-space:pre-wrap;">' + escapeHtml(s) + '</div>' +
          '</div>'
        );
      });

      document.getElementById('suggestionsList').innerHTML =
        items.length
          ? items.join('')
          : '<div style="text-align:center;color:#6b7280;padding:2rem;">건의사항이 없습니다.</div>';
    }

    // ===== 네비게이션 =====
    function goHome(){
      hideAll();
      document.getElementById('homePage').classList.remove('hidden');
    }

    function hideAll(){
      document.getElementById('homePage').classList.add('hidden');
      document.getElementById('attendancePage').classList.add('hidden');
      document.getElementById('adminDashboard').classList.add('hidden');
    }

    // ===== 이벤트 =====
    document.getElementById('memberList').addEventListener('click', function(e){
      if (e.target && e.target.classList.contains('note-input')) return; // 입력칸 클릭 시 토글 방지
      var header = e.target.closest('.member-header');
      if (!header) return;
      toggleMember(header.getAttribute('data-name'));
    });

    document.getElementById('memberList').addEventListener('input', function(e){
      if (!e.target.classList.contains('note-input')) return;
      var name = e.target.getAttribute('data-name');
      memberNotes[name] = e.target.value;
      persistLocal();
    });

    document.getElementById('suggestionInput').addEventListener('input', function(){
      persistLocal();
    });

    document.getElementById('dateInput').addEventListener('change', function(){
      restoreLocal();
      applyMemberFilter(document.getElementById('memberSearch').value);
    });

    document.getElementById('memberSearch').addEventListener('input', function(){
      applyMemberFilter(this.value);
    });

    document.getElementById('adminDateInput').addEventListener('change', loadAdminData);
    document.getElementById('adminNotesDateInput').addEventListener('change', loadAdminData);
    document.getElementById('adminSugDateInput').addEventListener('change', loadAdminData);

    // 모달 바깥 클릭 시 닫기
    document.getElementById('passwordModal').addEventListener('click', function(e){
      if (e.target.id === 'passwordModal') closePasswordModal();
    });

    // 시작
    initTeamGrid();
  </script>
</body>
</html>
