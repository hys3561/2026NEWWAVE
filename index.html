<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‰´ì›¨ì´ë¸Œ ì²­ë…„1ë¶€ ì‚¬ë‘ë°© ì¶œì„ì²´í¬</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#f9fafb; min-height:100vh; }
    .hidden { display:none !important; }

    .header { background:#fff; border-bottom:1px solid #e5e7eb; padding:1.25rem 1rem; position:sticky; top:0; z-index:100; }
    .header-content { max-width:1200px; margin:0 auto; position:relative; }
    h1 { font-size:1.5rem; color:#111827; }
    .subtitle { color:#6b7280; font-size:0.9rem; font-weight:800; margin-top:0.35rem; }

    .admin-button { position:absolute; top:0; right:0; background:#6b7280; color:#fff; padding:0.5rem 1rem; border-radius:0.85rem; border:none; cursor:pointer; font-size:0.875rem; font-weight:900; }
    .admin-button:hover { background:#4b5563; }

    .container { max-width:1200px; margin:0 auto; padding:1.5rem 1rem; }

    /* í™ˆ: íŒ€ ì¹´ë“œ */
    .team-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1rem; }
    .team-card { background:#fff; padding:1.5rem; border-radius:0.95rem; border:2px solid #e5e7eb; cursor:pointer; transition:all .2s; }
    .team-card:hover { border-color:#2563eb; box-shadow:0 10px 15px -3px rgba(0,0,0,.1); }
    .team-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; }
    .team-number { width:2.5rem; height:2.5rem; background:#dbeafe; border-radius:0.9rem; display:flex; align-items:center; justify-content:center; color:#2563eb; font-weight:950; font-size:1rem; }
    .team-card:hover .team-number { background:#2563eb; color:#fff; }
    .member-count { background:#f3f4f6; padding:.25rem .75rem; border-radius:9999px; font-size:.875rem; color:#6b7280; font-weight:900; }
    .team-name { font-size:1.65rem; font-weight:950; color:#111827; margin-bottom:.25rem; }
    .team-leader { font-size:.9rem; color:#6b7280; font-weight:800; }

    .back-button { display:flex; align-items:center; gap:.5rem; color:#6b7280; background:none; border:none; cursor:pointer; font-size:1rem; padding:.5rem .25rem; font-weight:900; }
    .back-button:hover { color:#111827; }

    /* ë‚ ì§œ/ìš”ì•½ */
    .date-section { background:#fff; padding:1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .date-label { font-size:.875rem; font-weight:950; color:#374151; margin-bottom:.5rem; }
    .date-input {
      width:100%;
      padding:.75rem 1rem;
      border:1px solid #d1d5db;
      border-radius:.9rem;
      font-size:16px;
      -webkit-appearance:none; appearance:none;
      background:#fff;
    }

    .summary-box { background:#eff6ff; padding:1rem; border-radius:.95rem; border:1px solid #bfdbfe; margin-bottom:1rem; }
    .summary-content { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .summary-title { font-weight:950; color:#111827; }
    .summary-count { font-size:1.5rem; font-weight:950; color:#2563eb; }
    .progress-bar { background:#e5e7eb; border-radius:9999px; height:.5rem; overflow:hidden; }
    .progress-fill { background:#2563eb; height:100%; transition:width .3s; }

    .search-section { background:#fff; padding:.75rem 1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .search-input { width:100%; padding:.65rem .9rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; }

    .member-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:.75rem; margin-bottom:1rem; }
    @media (min-width:768px){ .member-list{ grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); } }

    .member-item { background:#fff; padding:.9rem; border-radius:.95rem; border:2px solid #e5e7eb; transition:all .2s; }
    .member-item.checked { background:#eff6ff; border-color:#2563eb; }

    .member-header { display:flex; justify-content:space-between; align-items:flex-start; cursor:pointer; gap:.5rem; }
    .member-name { font-size:1rem; font-weight:950; color:#374151; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .member-meta { margin-top:.2rem; font-size:.85rem; font-weight:900; color:#6b7280; }
    .checkbox { width:1.75rem; height:1.75rem; border-radius:9999px; border:2px solid #d1d5db; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:.1rem; }
    .member-item.checked .checkbox { background:#2563eb; border-color:#2563eb; }
    .checkmark { display:none; color:#fff; font-weight:950; font-size:.95rem; }
    .member-item.checked .checkmark { display:block; }

    .note-section { margin-top:.75rem; padding-top:.75rem; border-top:1px solid #e5e7eb; }
    .note-label { font-size:.8rem; font-weight:950; color:#6b7280; margin-bottom:.35rem; }
    .note-input { width:100%; padding:.55rem .65rem; border:1px solid #d1d5db; border-radius:.85rem; font-size:16px; }

    .suggestion-section { background:#fff; padding:1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .suggestion-textarea { width:100%; padding:.75rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; min-height:90px; }

    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    .sticky-actions { position:sticky; bottom:0; background:rgba(249,250,251,.95); border-top:1px solid #e5e7eb; padding:.75rem 0 calc(.75rem + var(--safe-bottom)) 0; backdrop-filter:blur(6px); }
    .save-button { width:100%; background:#2563eb; color:#fff; padding:.95rem; border-radius:.95rem; border:none; font-size:1.05rem; font-weight:950; cursor:pointer; }
    .save-button:hover { background:#1d4ed8; }

    .message { padding:.85rem 1rem; border-radius:.95rem; text-align:center; font-weight:950; margin-top:.75rem; }
    .message.success { background:#f0fdf4; color:#15803d; border:1px solid #bbf7d0; }
    .message.error { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .message.info  { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }

    /* ê´€ë¦¬ì */
    .dashboard-tabs { display:flex; gap:1rem; margin-bottom:1.25rem; border-bottom:2px solid #e5e7eb; flex-wrap:wrap; }
    .tab-button { padding:.75rem 1.25rem; background:none; border:none; cursor:pointer; color:#6b7280; border-bottom:2px solid transparent; margin-bottom:-2px; font-weight:950; }
    .tab-button.active { color:#2563eb; border-bottom-color:#2563eb; }

    .admin-summary { display:grid; grid-template-columns:repeat(3, 1fr); gap:.75rem; margin:1rem 0; }
    .admin-summary-card { background:#fff; border:1px solid #e5e7eb; border-radius:.95rem; padding:1rem; }
    .admin-summary-label { font-size:.875rem; color:#6b7280; font-weight:950; margin-bottom:.25rem; }
    .admin-summary-value { font-size:1.6rem; font-weight:950; color:#111827; }
    .admin-summary-note { font-size:.9rem; color:#6b7280; margin-bottom:1rem; font-weight:800; }

    .attendance-table, .notes-table { background:#fff; border-radius:.95rem; border:1px solid #e5e7eb; overflow-x:auto; }
    .attendance-table table, .notes-table table { width:100%; border-collapse:collapse; }
    .attendance-table th, .notes-table th { background:#f9fafb; padding:.75rem; text-align:left; font-size:.875rem; font-weight:950; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
    .attendance-table td, .notes-table td { padding:.75rem; border-bottom:1px solid #e5e7eb; font-size:.875rem; vertical-align:top; }

    .suggestion-list { background:#fff; border-radius:.95rem; border:1px solid #e5e7eb; padding:1rem; }
    .suggestion-item { padding:1rem; border-bottom:1px solid #e5e7eb; }
    .suggestion-team { font-weight:950; color:#111827; }

    /* ê´€ë¦¬ì ì¶œì„í˜„í™©: í–‰ ì•„ë˜ í† ê¸€ ìƒì„¸ */
    .team-row { cursor: pointer; }
    .team-row:hover td { background: #f9fafb; }
    .detail-row td { padding: 0 !important; background: #f9fafb; }
    .detail-panel { padding: 1rem; border-top: 1px solid #e5e7eb; }

    .detail-grid { display: grid; gap: .75rem; grid-template-columns: 1fr; }
    @media (min-width: 768px){ .detail-grid { grid-template-columns: 1fr 1fr; } }
    .detail-card { background: #fff; border: 1px solid #e5e7eb; border-radius: .95rem; padding: .9rem; }
    .detail-title { font-weight: 950; color: #111827; margin-bottom: .5rem; }
    .detail-sub { font-size: .9rem; font-weight: 900; color: #6b7280; margin-bottom: .4rem; }

    .chips { display:flex; flex-wrap:wrap; gap:.35rem; }
    .chip { padding: .25rem .55rem; border-radius: 9999px; font-size: .85rem; font-weight: 900; background: #eef2ff; color: #1d4ed8; }
    .chip.absent { background:#fef2f2; color:#b91c1c; }

    .note-list { display:flex; flex-direction:column; gap:.35rem; }
    .note-item { border: 1px solid #e5e7eb; background: #fff; border-radius: .75rem; padding: .6rem .7rem; font-weight: 800; color: #374151; white-space: pre-wrap; }
    .note-name { font-weight: 950; color:#111827; }
    .note-badge { font-size:.8rem; font-weight:950; color:#6b7280; margin-left:.4rem; }

    /* ê°œì¸ ì¶œì„ë¥  íƒ­ */
    .member-tools { display:grid; grid-template-columns:1fr; gap:.75rem; margin-bottom:1rem; }
    @media (min-width: 768px){ .member-tools { grid-template-columns: 1fr 1fr 1fr; } }
    .select-input { width:100%; padding:.75rem 1rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; background:#fff; }
    .member-result { margin-top: .75rem; }
    .member-table { background:#fff; border-radius:.95rem; border:1px solid #e5e7eb; overflow-x:auto; }
    .member-table table { width:100%; border-collapse:collapse; }
    .member-table th { background:#f9fafb; padding:.75rem; text-align:left; font-size:.875rem; font-weight:950; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
    .member-table td { padding:.75rem; border-bottom:1px solid #e5e7eb; font-size:.875rem; vertical-align:top; }
    .badge-ok { font-weight:950; color:#15803d; }
    .badge-no { font-weight:950; color:#b91c1c; }

    .chart-card { background:#fff; border:1px solid #e5e7eb; border-radius:.95rem; padding:1rem; margin-top: .75rem; }
    .chart-title { font-weight:950; color:#111827; margin-bottom:.35rem; }
    .chart-sub { font-size:.9rem; font-weight:900; color:#6b7280; margin-bottom:.75rem; }
    canvas { width:100%; height:220px; display:block; }

    .btn-row { display:flex; gap:.5rem; flex-wrap:wrap; margin-top: .75rem; }
    .ghost-btn { border:none; background:#f3f4f6; color:#111827; font-weight:950; border-radius:.9rem; padding:.75rem 1rem; cursor:pointer; }
    .ghost-btn:hover { background:#e5e7eb; }

    /* ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ */
    .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.55); display:flex; align-items:center; justify-content:center; padding:1rem; z-index:999; }
    .modal { width:100%; max-width:420px; background:#fff; border-radius:1rem; border:1px solid #e5e7eb; box-shadow:0 20px 25px -5px rgba(0,0,0,.15); overflow:hidden; }
    .modal-header { padding:1rem 1rem .75rem 1rem; border-bottom:1px solid #e5e7eb; }
    .modal-title { font-size:1.1rem; font-weight:950; color:#111827; }
    .modal-subtitle { margin-top:.25rem; font-size:.9rem; color:#6b7280; font-weight:800; }
    .modal-body { padding:1rem; }
    .modal-input { width:100%; padding:.8rem .9rem; border:1px solid #d1d5db; border-radius:.95rem; font-size:16px; }
    .modal-error { margin-top:.75rem; color:#b91c1c; font-weight:950; font-size:.9rem; }
    .modal-actions { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; padding:0 1rem 1rem 1rem; }
    .modal-btn { border:none; border-radius:.95rem; padding:.85rem .9rem; font-weight:950; cursor:pointer; font-size:.95rem; }
    .modal-btn.primary { background:#2563eb; color:#fff; }
    .modal-btn.primary:hover { background:#1d4ed8; }
    .modal-btn.ghost { background:#f3f4f6; color:#111827; }
    .modal-btn.ghost:hover { background:#e5e7eb; }

    @media (max-width:640px){
      .header{ padding:1rem 1rem; }
      h1{ font-size:1.25rem; }
      .container{ padding:1rem 1rem; }
      .admin-button{ padding:.45rem .8rem; font-size:.8rem; }
      .admin-summary{ grid-template-columns:1fr; }
      .team-grid{ grid-template-columns:1fr; }
      .member-list{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
      .team-name{ font-size:1.5rem; }
    }
  </style>
</head>

<body>
  <div id="homePage">
    <div class="header">
      <div class="header-content">
        <button type="button" class="admin-button" id="adminBtn">ê´€ë¦¬ì</button>
        <h1>ë‰´ì›¨ì´ë¸Œ ì²­ë…„1ë¶€ ì‚¬ë‘ë°© ì¶œì„ì²´í¬</h1>
        <p class="subtitle">ì‚¬ë‘ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
      </div>
    </div>
    <div class="container">
      <div class="team-grid" id="teamGrid"></div>
    </div>
  </div>

  <div id="attendancePage" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="teamBackBtn">â† ëŒì•„ê°€ê¸°</button>
        <h1 id="selectedTeamName"></h1>
        <p class="subtitle" id="selectedTeamLeader"></p>
      </div>
    </div>

    <div class="container">
      <div class="date-section">
        <div class="date-label">ë‚ ì§œ ì„ íƒ</div>
        <input type="date" class="date-input" id="dateInput" />
      </div>

      <div class="summary-box">
        <div class="summary-content">
          <span class="summary-title">ì¶œì„ í˜„í™©</span>
          <span class="summary-count" id="attendanceCount">0 / 0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="search-section">
        <input id="memberSearch" class="search-input" placeholder="ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: í™ê¸¸ë™)" />
      </div>

      <div class="member-list" id="memberList"></div>

      <div class="suggestion-section">
        <div class="date-label">ê±´ì˜ì‚¬í•­ (ì„ íƒ)</div>
        <textarea class="suggestion-textarea" id="suggestionInput" placeholder="ê±´ì˜ì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
      </div>

      <div class="sticky-actions">
        <button type="button" class="save-button" id="saveBtn">ì¶œì„ ì •ë³´ ì €ì¥</button>
        <div id="messageBox" class="hidden"></div>
      </div>
    </div>
  </div>

  <div id="adminDashboard" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="adminBackBtn">â† ëŒì•„ê°€ê¸°</button>
        <h1>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <p class="subtitle">ë‚ ì§œ/ê°œì¸ ì„ íƒìœ¼ë¡œ ì¶œì„ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>

    <div class="container">
      <div class="dashboard-tabs">
        <button type="button" class="tab-button active" data-tab="stats">ì¶œì„ í˜„í™©</button>
        <button type="button" class="tab-button" data-tab="notes">íŠ¹ì´ì‚¬í•­</button>
        <button type="button" class="tab-button" data-tab="suggestions">ê±´ì˜ì‚¬í•­</button>
        <button type="button" class="tab-button" data-tab="members">ê°œì¸ ì¶œì„ë¥ </button>
      </div>

      <div id="adminStatsTab">
        <div class="date-section">
          <div class="date-label">ë‚ ì§œ ì„ íƒ</div>
          <input type="date" class="date-input" id="adminDateInput" />
        </div>

        <div class="admin-summary">
          <div class="admin-summary-card">
            <div class="admin-summary-label">ì „ì²´ ì¶œì„</div>
            <div class="admin-summary-value" id="adminTotalPresent">0ëª…</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">ì „ì²´ ê²°ì„</div>
            <div class="admin-summary-value" id="adminTotalAbsent">0ëª…</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">ì „ì²´ ì¶œì„ë¥ </div>
            <div class="admin-summary-value" id="adminTotalRate">0%</div>
          </div>
        </div>

        <div class="admin-summary-note" id="adminSummaryNote"></div>
        <div class="attendance-table" id="attendanceTable"></div>
      </div>

      <div id="adminNotesTab" class="hidden">
        <div class="date-section">
          <div class="date-label">ë‚ ì§œ ì„ íƒ</div>
          <input type="date" class="date-input" id="adminNotesDateInput" />
        </div>
        <div class="notes-table" id="notesTable"></div>
      </div>

      <div id="adminSuggestionsTab" class="hidden">
        <div class="date-section">
          <div class="date-label">ë‚ ì§œ ì„ íƒ</div>
          <input type="date" class="date-input" id="adminSugDateInput" />
        </div>
        <div class="suggestion-list" id="suggestionsList"></div>
      </div>

      <div id="adminMembersTab" class="hidden">
        <div class="date-section">
          <div class="date-label">ì¡°íšŒ ë²”ìœ„ (ê¸°ë³¸: ìµœê·¼ 1ë…„)</div>
          <div class="member-tools">
            <input type="date" class="date-input" id="memberStartDate" />
            <input type="date" class="date-input" id="memberEndDate" />
            <select class="select-input" id="memberSelect">
              <option value="">ì‚¬ëŒ ì„ íƒ</option>
            </select>
          </div>
          <div style="font-size:.9rem;color:#6b7280;font-weight:800;">
            * ë™ëª…ì´ì¸ì€ â€œì´ë¦„+ë˜ë˜â€ë¡œ ë¶„ë¦¬ë©ë‹ˆë‹¤. (ì˜ˆ: í™ê¸¸ë™ (01))
          </div>
          <div class="btn-row">
            <button type="button" class="ghost-btn" id="downloadCsvBtn">ğŸ“Š ê¸°ê°„ë³„ ì „ì²´ ì¶œì„ë¥  CSV ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>

        <div class="admin-summary">
          <div class="admin-summary-card">
            <div class="admin-summary-label">ì¶œì„</div>
            <div class="admin-summary-value" id="memberPresent">0íšŒ</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">ì´ ì¶œì„ì²´í¬</div>
            <div class="admin-summary-value" id="memberTotal">0íšŒ</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">ì¶œì„ë¥ </div>
            <div class="admin-summary-value" id="memberRate">0%</div>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-title">ì›”ë³„ ì¶œì„ë¥ </div>
          <div class="chart-sub">ì„ íƒí•œ ê¸°ê°„ì„ ì›” ë‹¨ìœ„ë¡œ ì§‘ê³„í•©ë‹ˆë‹¤.</div>
          <canvas id="memberChart" width="900" height="260"></canvas>
        </div>

        <div class="member-result member-table" id="memberHistoryTable"></div>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</div>
        <div class="modal-subtitle" id="modalSubtitle"></div>
      </div>
      <div class="modal-body">
        <input type="password" id="modalPassword" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸" />
        <div id="modalError" class="modal-error hidden"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn ghost" id="modalCancelBtn">ì·¨ì†Œ</button>
        <button type="button" class="modal-btn primary" id="modalOkBtn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * âœ… Apps Script Web App URL (ìœ¤í˜¸ë‹˜ì´ ì¤€ ì£¼ì†Œ)
     ************************************************************/
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykIFil8qB7FgHxqEW2kWHU6lCoR1Xb_u0c8c8jk-IAniGTKX06fGSs9rTZBphrPUHXVA/exec";

    /************************************************************
     * âœ… ë¹„ë°€ë²ˆí˜¸
     ************************************************************/
    const ADMIN_PASSWORD = "newwave2026";
    const TEAM_PASSWORDS = {
      "1": "pw1111","2": "pw2222","3": "pw3333","4": "pw4444",
      "5": "pw5555","6": "pw6666","7": "pw7777","8": "pw8888",
      "9": "pw9999","10":"pw1010","11":"pw1110","12":"pw1212"
    };

    /************************************************************
     * âœ… ì‚¬ë‘ë°© ëª©ë¡ (ì›ë³µ + ë˜ë˜ ì§€ì›)
     * - membersëŠ” ì•„ë˜ 2ê°€ì§€ í˜•íƒœ ëª¨ë‘ ì§€ì›
     * 1) "í™ê¸¸ë™" (cohortê°€ ì—†ìœ¼ë©´ ""ë¡œ ì €ì¥ë¨)
     * 2) { name:"í™ê¸¸ë™", cohort:"01" }
     ************************************************************/
    const TEAMS = [
      { id: 1, name: "ê¶Œì¤€í˜• ì‚¬ë‘ë°©", leader: "ë°©ì¥: ê¶Œì¤€í˜•", members: [
        {name:"ë°©ì›1", cohort:"99"}, {name:"ë°©ì›2", cohort:"00"}, {name:"ë°©ì›3", cohort:"01"}, {name:"ë°©ì›4", cohort:"01"}
      ] },
      { id: 2, name: "ê¹€ë‚˜ë¦¼ ì‚¬ë‘ë°©", leader: "ë°©ì¥: ê¹€ë‚˜ë¦¼", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 3, name: "ë¬¸ìœ ì•ˆ ì‚¬ë‘ë°©", leader: "ë°©ì¥: ë¬¸ìœ ì•ˆ", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 4, name: "ë²¡ì—ìŠ¤ë” ì‚¬ë‘ë°©", leader: "ë°©ì¥: ë²¡ì—ìŠ¤ë”", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 5, name: "ì´ì˜ˆì • ì‚¬ë‘ë°©", leader: "ë°©ì¥: ì´ì˜ˆì •", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 6, name: "ì´ì§€ë¹ˆ ì‚¬ë‘ë°©", leader: "ë°©ì¥: ì´ì§€ë¹ˆ", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 7, name: "ì´í•˜ì€ ì‚¬ë‘ë°©", leader: "ë°©ì¥: ì´í•˜ì€", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 8, name: "ì´í¬ì§„ ì‚¬ë‘ë°©", leader: "ë°©ì¥: ì´í¬ì§„", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 9, name: "ì„ì‚¬ë‘ ì‚¬ë‘ë°©", leader: "ë°©ì¥: ì„ì‚¬ë‘", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 10, name: "ì¥í•˜ëŠ˜ ì‚¬ë‘ë°©", leader: "ë°©ì¥: ì¥í•˜ëŠ˜", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 11, name: "í•˜ì¬ì˜ ì‚¬ë‘ë°©", leader: "ë°©ì¥: í•˜ì¬ì˜", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] },
      { id: 12, name: "WeeíŒ€", leader: "ë°©ì¥: ê¶Œí•˜ê²½, ìµœìˆ˜ì¸", members: ["ë°©ì›1","ë°©ì›2","ë°©ì›3"] }
    ];

    /************************************************************
     * ìƒíƒœ
     ************************************************************/
    let selectedTeam = null;
    let attendance = {};   // key -> boolean
    let memberNotes = {};  // key -> string
    let adminAuthed = false;

    /************************************************************
     * ìœ í‹¸
     ************************************************************/
    function showPage(pageId){
      document.getElementById("homePage").classList.add("hidden");
      document.getElementById("attendancePage").classList.add("hidden");
      document.getElementById("adminDashboard").classList.add("hidden");
      document.getElementById(pageId).classList.remove("hidden");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showMsg(type, text){
      const box = document.getElementById("messageBox");
      box.className = "message " + (type || "");
      box.textContent = text || "";
      box.classList.remove("hidden");
      setTimeout(()=> box.classList.add("hidden"), 2500);
    }

    function formatISODate(d){
      return new Date(d).toISOString().split("T")[0];
    }

    function normCohort(c){ return String(c ?? "").trim(); }
    function normName(n){ return String(n ?? "").trim(); }

    // âœ… ê°œì¸ ì‹ë³„í‚¤ = name||cohort
    function memberKey(name, cohort){
      return `${normName(name)}||${normCohort(cohort)}`;
    }

    function displayMember(name, cohort){
      const c = normCohort(cohort);
      return c ? `${name} (${c})` : `${name}`;
    }

    function normalizeMemberObj(m){
      if (typeof m === "string") return { name: normName(m), cohort: "" };
      if (m && typeof m === "object") return { name: normName(m.name), cohort: normCohort(m.cohort) };
      return { name: "", cohort: "" };
    }

    /************************************************************
     * JSONP(GET) - ê´€ë¦¬ì/ë¶ˆëŸ¬ì˜¤ê¸° í•µì‹¬
     ************************************************************/
    function jsonp(url, params){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
        params = params || {};
        params.callback = cb;

        const qs = Object.keys(params).map(k => encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join("&");
        const script = document.createElement("script");
        script.src = url + (url.includes("?") ? "&" : "?") + qs;

        const t = setTimeout(()=>{
          cleanup();
          reject(new Error("JSONP timeout"));
        }, 12000);

        function cleanup(){
          clearTimeout(t);
          if (script && script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cb]; } catch(e){ window[cb] = undefined; }
        }

        window[cb] = (data)=>{ cleanup(); resolve(data); };
        script.onerror = ()=>{ cleanup(); reject(new Error("JSONP network error")); };
        document.body.appendChild(script);
      });
    }

    function apiGet(action, params){
      params = params || {};
      params.action = action;
      return jsonp(GOOGLE_SCRIPT_URL, params);
    }

    /************************************************************
     * ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬
     ************************************************************/
    const modal = document.getElementById("passwordModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubtitle = document.getElementById("modalSubtitle");
    const modalPassword = document.getElementById("modalPassword");
    const modalError = document.getElementById("modalError");

    let modalState = { mode:null, teamId:null }; // mode: "team" | "admin"

    function openPasswordModal({mode, teamId, title, subtitle}){
      modalState = { mode, teamId: teamId ?? null };
      modalTitle.textContent = title || "ë¹„ë°€ë²ˆí˜¸ ì…ë ¥";
      modalSubtitle.textContent = subtitle || "";
      modalPassword.value = "";
      modalError.textContent = "";
      modalError.classList.add("hidden");
      modal.classList.remove("hidden");
      setTimeout(()=> modalPassword.focus(), 0);
    }

    function closePasswordModal(){
      modal.classList.add("hidden");
      modalState = { mode:null, teamId:null };
    }

    function setModalError(msg){
      modalError.textContent = msg;
      modalError.classList.remove("hidden");
    }

    function submitPassword(){
      const pw = modalPassword.value || "";

      if (modalState.mode === "admin") {
        if (pw !== ADMIN_PASSWORD) { setModalError("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
        adminAuthed = true;
        closePasswordModal();
        showAdminDashboard();
        return;
      }

      if (modalState.mode === "team") {
        const teamId = String(modalState.teamId || "");
        const expected = TEAM_PASSWORDS[teamId] ?? "";
        if (!expected) { setModalError("ì´ ì‚¬ë‘ë°©ì€ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
        if (pw !== expected) { setModalError("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }

        const team = TEAMS.find(t => String(t.id) === teamId);
        if (!team) { setModalError("ì‚¬ë‘ë°© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

        closePasswordModal();
        selectTeam(team);
        return;
      }
    }

    document.getElementById("modalCancelBtn").addEventListener("click", closePasswordModal);
    document.getElementById("modalOkBtn").addEventListener("click", submitPassword);
    modalPassword.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); submitPassword(); }
      if (e.key === "Escape") closePasswordModal();
    });
    modal.addEventListener("click", (e)=>{ if (e.target.id === "passwordModal") closePasswordModal(); });

    /************************************************************
     * í™ˆ: íŒ€ ì¹´ë“œ
     ************************************************************/
    function initTeamGrid(){
      const grid = document.getElementById("teamGrid");
      grid.innerHTML = "";

      TEAMS.forEach(team=>{
        const members = (team.members || []).map(normalizeMemberObj).filter(x=>x.name);
        const card = document.createElement("div");
        card.className = "team-card";
        card.innerHTML = `
          <div class="team-card-header">
            <div class="team-number">${team.id}</div>
            <div class="member-count">${members.length}ëª…</div>
          </div>
          <div class="team-name">${escapeHtml(team.name)}</div>
          <div class="team-leader">${escapeHtml(team.leader)}</div>
        `;

        card.addEventListener("click", (e)=>{
          e.preventDefault();
          openPasswordModal({
            mode:"team",
            teamId: team.id,
            title: team.name + " ë¹„ë°€ë²ˆí˜¸",
            subtitle: "í•´ë‹¹ ì‚¬ë‘ë°©ì¥ë§Œ ì¶œì„/íŠ¹ì´ì‚¬í•­ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          });
        });

        grid.appendChild(card);
      });
    }

    /************************************************************
     * ì¶œì„ í˜ì´ì§€
     ************************************************************/
    const today = new Date().toISOString().split("T")[0];
    const dateInput = document.getElementById("dateInput");
    dateInput.value = today;

    function resetStateForTeam(team){
      attendance = {};
      memberNotes = {};
      document.getElementById("suggestionInput").value = "";

      const members = (team.members || []).map(normalizeMemberObj).filter(x=>x.name);
      members.forEach(m => {
        const k = memberKey(m.name, m.cohort);
        attendance[k] = false;
        memberNotes[k] = "";
      });
    }

    function buildMemberList(team){
      const list = document.getElementById("memberList");
      list.innerHTML = "";

      const members = (team.members || []).map(normalizeMemberObj).filter(x=>x.name);

      members.forEach(m=>{
        const k = memberKey(m.name, m.cohort);

        const item = document.createElement("div");
        item.className = "member-item";
        item.dataset.key = k;
        item.dataset.name = m.name;
        item.dataset.cohort = m.cohort;

        item.innerHTML = `
          <div class="member-header">
            <div>
              <div class="member-name">${escapeHtml(m.name)}</div>
              <div class="member-meta">ë˜ë˜: ${escapeHtml(m.cohort || "-")}</div>
            </div>
            <div class="checkbox"><span class="checkmark">âœ“</span></div>
          </div>
          <div class="note-section">
            <div class="note-label">íŠ¹ì´ì‚¬í•­</div>
            <input class="note-input" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥" />
          </div>
        `;
        list.appendChild(item);
      });
    }

    // [ë³µì›ëœ ë¶€ë¶„]
    function updateCount(){
      if (!selectedTeam) return;
      const members = (selectedTeam.members || []).map(normalizeMemberObj).filter(x=>x.name);
      const total = members.length;
      let present = 0;

      members.forEach(m => {
        const k = memberKey(m.name, m.cohort);
        const item = document.querySelector(`#memberList [data-key="${k}"]`);

        if(attendance[k]){
          present++;
          if(item) item.classList.add("checked");
        } else {
          if(item) item.classList.remove("checked");
        }
      });

      const rate = total > 0 ? Math.round((present / total) * 100) : 0;

      document.getElementById("attendanceCount").textContent = `${present} / ${total}`;
      document.getElementById("progressFill").style.width = `${rate}%`;
    }

    function toggleAttendance(key){
      attendance[key] = !attendance[key];
      updateCount();
    }

    function saveNote(key, note){
      memberNotes[key] = note;
    }

    async function loadAttendance(){
      if (!selectedTeam) return;
      const date = dateInput.value;
      const teamId = selectedTeam.id;

      try {
        const data = await apiGet("loadAttendance", { teamId, date });
        
        // 1. ìƒíƒœ ì´ˆê¸°í™”
        const members = (selectedTeam.members || []).map(normalizeMemberObj).filter(x=>x.name);
        members.forEach(m => {
          const k = memberKey(m.name, m.cohort);
          attendance[k] = false;
          memberNotes[k] = "";
        });

        if(data && data.status === "success" && data.data){
          const loaded = data.data;

          // 2. ë¡œë“œëœ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          if (loaded.attendance) {
            loaded.attendance.forEach(att => {
              const k = memberKey(att.name, att.cohort);
              if (att.isPresent) attendance[k] = true;
              if (att.note) memberNotes[k] = att.note;
            });
          }

          document.getElementById("suggestionInput").value = loaded.suggestion || "";
          showMsg("info", `[${date}] ì €ì¥ëœ ì¶œì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        } else {
          document.getElementById("suggestionInput").value = "";
          showMsg("info", `[${date}] ì €ì¥ëœ ì¶œì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì‘ì„±í•©ë‹ˆë‹¤.`);
        }
        
        // 3. UI ì—…ë°ì´íŠ¸
        document.querySelectorAll("#memberList .member-item").forEach(item => {
          const k = item.dataset.key;
          item.classList.toggle("checked", attendance[k]);
          const noteInput = item.querySelector(".note-input");
          if(noteInput) noteInput.value = memberNotes[k] || "";
        });

        updateCount();

      } catch(e) {
        console.error("ì¶œì„ ë¡œë“œ ì˜¤ë¥˜:", e);
        showMsg("error", "ì¶œì„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function saveAttendance(){
      if (!selectedTeam) return;

      const date = dateInput.value;
      const teamId = selectedTeam.id;
      const teamName = selectedTeam.name;
      const leader = selectedTeam.leader;
      const suggestion = document.getElementById("suggestionInput").value;

      const members = (selectedTeam.members || []).map(normalizeMemberObj).filter(x=>x.name);
      
      const attendanceData = members.map(m => {
        const k = memberKey(m.name, m.cohort);
        return {
          name: m.name,
          cohort: m.cohort,
          isPresent: attendance[k] || false,
          note: memberNotes[k] || ""
        };
      });

      try {
        document.getElementById("saveBtn").textContent = "ì €ì¥ ì¤‘...";
        document.getElementById("saveBtn").disabled = true;

        const result = await apiGet("saveAttendance", {
          teamId,
          teamName,
          leader,
          date,
          attendance: JSON.stringify(attendanceData),
          suggestion
        });

        if (result && result.status === "success") {
          showMsg("success", "ì¶œì„ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } else {
          showMsg("error", "ì €ì¥ ì‹¤íŒ¨: " + (result?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      } catch(e) {
        console.error("ì¶œì„ ì €ì¥ ì˜¤ë¥˜:", e);
        showMsg("error", "ì¶œì„ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        document.getElementById("saveBtn").textContent = "ì¶œì„ ì •ë³´ ì €ì¥";
        document.getElementById("saveBtn").disabled = false;
      }
    }

    function selectTeam(team){
      selectedTeam = team;
      document.getElementById("selectedTeamName").textContent = team.name;
      document.getElementById("selectedTeamLeader").textContent = team.leader;
      
      resetStateForTeam(team);
      buildMemberList(team);
      showPage("attendancePage");

      // ë‚ ì§œ ë³€ê²½ ì‹œì—ë„ ì¶œì„ ë¡œë“œ
      dateInput.value = today;
      loadAttendance();
    }

    // ì¶œì„ í˜ì´ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.getElementById("teamBackBtn").addEventListener("click", ()=>{
      selectedTeam = null;
      showPage("homePage");
    });
    
    dateInput.addEventListener("change", loadAttendance);
    document.getElementById("saveBtn").addEventListener("click", saveAttendance);

    document.getElementById("memberList").addEventListener("click", (e)=>{
      const item = e.target.closest(".member-item");
      if (!item) return;
      
      // íŠ¹ì´ì‚¬í•­ ì…ë ¥ í•„ë“œ í´ë¦­ ì‹œì—ëŠ” í† ê¸€ ë§‰ê¸°
      if (e.target.closest(".note-input")) {
        e.target.focus();
        return;
      }

      const key = item.dataset.key;
      toggleAttendance(key);
    });

    document.getElementById("memberList").addEventListener("input", (e)=>{
      const input = e.target.closest(".note-input");
      if (!input) return;

      const item = input.closest(".member-item");
      if (!item) return;

      const key = item.dataset.key;
      saveNote(key, input.value);
    });

    document.getElementById("memberSearch").addEventListener("input", (e)=>{
      const query = normName(e.target.value).toLowerCase();
      document.querySelectorAll("#memberList .member-item").forEach(item => {
        const name = normName(item.dataset.name).toLowerCase();
        item.classList.toggle("hidden", name.indexOf(query) === -1);
      });
    });


    /************************************************************
     * ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
     ************************************************************/
    function showAdminDashboard(){
      if (!adminAuthed) {
        openPasswordModal({ mode: "admin", title: "ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸", subtitle: "ê´€ë¦¬ì ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
        return;
      }
      showPage("adminDashboard");
      initAdminTabs();
    }

    document.getElementById("adminBtn").addEventListener("click", ()=>{
        if (adminAuthed) {
             showAdminDashboard();
        } else {
             openPasswordModal({ mode: "admin", title: "ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸", subtitle: "ê´€ë¦¬ì ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
        }
    });
    document.getElementById("adminBackBtn").addEventListener("click", ()=>{ adminAuthed=false; showPage("homePage"); });

    // íƒ­ ë° ì»¨í…ì¸  ìš”ì†Œ ì„¤ì •
    const adminTabs = document.querySelectorAll(".dashboard-tabs .tab-button");
    const adminTabContents = {
      "stats": document.getElementById("adminStatsTab"),
      "notes": document.getElementById("adminNotesTab"),
      "suggestions": document.getElementById("adminSuggestionsTab"),
      "members": document.getElementById("adminMembersTab")
    };
    
    function initAdminTabs() {
      // íƒ­ ì „í™˜ í•¸ë“¤ëŸ¬
      adminTabs.forEach(btn => {
        btn.addEventListener("click", function() {
          adminTabs.forEach(b => b.classList.remove("active"));
          this.classList.add("active");
          
          const targetTab = this.dataset.tab;
          Object.values(adminTabContents).forEach(content => content.classList.add("hidden"));
          adminTabContents[targetTab].classList.remove("hidden");

          // ê° íƒ­ë³„ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
          if(targetTab === 'stats') loadAdminStats();
          else if(targetTab === 'notes') loadAdminNotes();
          else if(targetTab === 'suggestions') loadAdminSuggestions();
          else if(targetTab === 'members') loadAdminMembers();
        });
      });
      // ì´ˆê¸° íƒ­ ì„¤ì •
      // ë‚ ì§œ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById("adminDateInput").value = today;
      document.getElementById("adminNotesDateInput").value = today;
      document.getElementById("adminSugDateInput").value = today;
      
      // ì²« ë²ˆì§¸ íƒ­ ê°•ì œ í´ë¦­
      adminTabs[0].click(); 
    }

    // --- ê´€ë¦¬ì ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (Apps Scriptì™€ ì—°ë™ í•„ìš”) ---

    // í—¬í¼: í…Œì´ë¸” UI ìƒì„±
    function buildAttendanceTable(data) {
        let html = `<table><thead><tr>
          <th>ì‚¬ë‘ë°©</th><th>ì´ì›</th><th>ì¶œì„</th><th>ê²°ì„</th><th>ì¶œì„ë¥ </th>
        </tr></thead><tbody>`;
        
        let totalPresent = 0;
        let totalAbsent = 0;
        let totalMembers = 0;

        if (data && data.teamStats) {
            data.teamStats.forEach(stat => {
                const total = stat.present + stat.absent;
                const rate = total > 0 ? Math.round((stat.present / total) * 100) : 0;
                html += `<tr class="team-row" data-team-id="${stat.teamId}">
                    <td>${escapeHtml(stat.teamName)}</td>
                    <td>${total}</td>
                    <td>${stat.present}</td>
                    <td>${stat.absent}</td>
                    <td>${rate}%</td>
                </tr>
                <tr class="detail-row hidden" data-team-detail="${stat.teamId}"><td colspan="5">
                    <div class="detail-panel" id="detailPanel-${stat.teamId}">ë¡œë”© ì¤‘...</div>
                </td></tr>`;
                totalPresent += stat.present;
                totalAbsent += stat.absent;
                totalMembers += total;
            });
        }
        html += `</tbody></table>`;
        
        document.getElementById("adminTotalPresent").textContent = `${totalPresent}ëª…`;
        document.getElementById("adminTotalAbsent").textContent = `${totalAbsent}ëª…`;
        const totalRate = totalMembers > 0 ? Math.round((totalPresent / totalMembers) * 100) : 0;
        document.getElementById("adminTotalRate").textContent = `${totalRate}%`;
        document.getElementById("adminSummaryNote").textContent = `ì´ ${totalMembers}ëª… ì¤‘ ${totalPresent}ëª… ì¶œì„`;

        return html;
    }
    
    // ì¶œì„ í˜„í™© ë¡œë“œ
    async function loadAdminStats() { 
      const date = document.getElementById("adminDateInput").value;
      const tableDiv = document.getElementById("attendanceTable");
      tableDiv.innerHTML = `<div class="message info">ì¶œì„ í˜„í™© ë¡œë“œ ì¤‘...</div>`;

      try {
          // Apps Scriptì—ì„œ í•´ë‹¹ ë‚ ì§œì˜ ì „ì²´ íŒ€ í†µê³„ë¥¼ ê°€ì ¸ì˜´
          const data = await apiGet("getStatsByDate", { date });
          
          if (data && data.status === "success" && data.data) {
            tableDiv.innerHTML = buildAttendanceTable(data.data);
            attachDetailToggleListeners(date);
          } else {
            tableDiv.innerHTML = `<div class="message info">ë‚ ì§œ: ${date}ì— ëŒ€í•œ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          }

      } catch (e) {
          console.error("Admin Stats Load Error:", e);
          tableDiv.innerHTML = `<div class="message error">í†µê³„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨</div>`;
      }
    }
    document.getElementById("adminDateInput").addEventListener("change", loadAdminStats);
    
    // ìƒì„¸ ì •ë³´ ë¡œë“œ ë° í† ê¸€ ë¦¬ìŠ¤ë„ˆ
    function attachDetailToggleListeners(date) {
        document.querySelectorAll(".team-row").forEach(row => {
            row.addEventListener('click', async function() {
                const teamId = this.dataset.teamId;
                const detailRow = document.querySelector(`.detail-row[data-team-detail="${teamId}"]`);
                const detailPanel = document.getElementById(`detailPanel-${teamId}`);
                
                if (detailRow.classList.contains('hidden')) {
                    // ìƒì„¸ ì •ë³´ ë¡œë“œ
                    detailPanel.innerHTML = `<div class="message info">ìƒì„¸ ì •ë³´ ë¡œë“œ ì¤‘...</div>`;
                    detailRow.classList.remove('hidden');

                    try {
                        const data = await apiGet("loadAttendance", { teamId, date });
                        if (data && data.status === "success" && data.data) {
                            detailPanel.innerHTML = buildDetailPanel(data.data);
                        } else {
                            detailPanel.innerHTML = `<div class="message info">ì´ ë‚ ì§œì— ëŒ€í•œ ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                        }
                    } catch(e) {
                        detailPanel.innerHTML = `<div class="message error">ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨</div>`;
                    }
                } else {
                    detailRow.classList.add('hidden');
                }
            });
        });
    }

    // í—¬í¼: ìƒì„¸ ì •ë³´ íŒ¨ë„ UI ìƒì„±
    function buildDetailPanel(data) {
        const presentChips = (data.attendance || [])
            .filter(a => a.isPresent)
            .map(a => `<span class="chip">${displayMember(a.name, a.cohort)}</span>`)
            .join("");

        const absentChips = (data.attendance || [])
            .filter(a => !a.isPresent)
            .map(a => `<span class="chip absent">${displayMember(a.name, a.cohort)}</span>`)
            .join("");

        const notesList = (data.attendance || [])
            .filter(a => a.note)
            .map(a => `<div class="note-item"><span class="note-name">${displayMember(a.name, a.cohort)}:</span> ${escapeHtml(a.note)}</div>`)
            .join("");
            
        let html = `<div class="detail-grid">`;
        
        // 1. ì¶œì„/ê²°ì„
        html += `<div class="detail-card">
            <div class="detail-title">ì¶œì„ (${(data.attendance || []).filter(a => a.isPresent).length}ëª…)</div>
            <div class="chips">${presentChips || 'ì¶œì„ ê¸°ë¡ ì—†ìŒ'}</div>
            <div class="detail-title" style="margin-top:1rem;">ê²°ì„ (${(data.attendance || []).filter(a => !a.isPresent).length}ëª…)</div>
            <div class="chips">${absentChips || 'ê²°ì„ ê¸°ë¡ ì—†ìŒ'}</div>
        </div>`;
        
        // 2. íŠ¹ì´ì‚¬í•­/ê±´ì˜ì‚¬í•­
        html += `<div class="detail-card">
            <div class="detail-title">íŠ¹ì´ì‚¬í•­ (${(data.attendance || []).filter(a => a.note).length}ê±´)</div>
            <div class="note-list">${notesList || 'íŠ¹ì´ì‚¬í•­ ê¸°ë¡ ì—†ìŒ'}</div>
            <div class="detail-title" style="margin-top:1rem;">ê±´ì˜ì‚¬í•­</div>
            <div class="note-item">${data.suggestion ? escapeHtml(data.suggestion) : 'ê±´ì˜ì‚¬í•­ ì—†ìŒ'}</div>
        </div>`;

        html += `</div>`;
        return html;
    }

    // íŠ¹ì´ì‚¬í•­ íƒ­ ë¡œë“œ
    async function loadAdminNotes() {
        const date = document.getElementById("adminNotesDateInput").value;
        const notesDiv = document.getElementById("notesTable");
        notesDiv.innerHTML = `<div class="message info">íŠ¹ì´ì‚¬í•­ ë¡œë“œ ì¤‘...</div>`;

        try {
            const data = await apiGet("getNotesByDate", { date });
            if (data && data.status === "success" && data.data) {
                let tableHtml = `<table><thead><tr><th>ì‚¬ë‘ë°©</th><th>ì´ë¦„ (ë˜ë˜)</th><th>íŠ¹ì´ì‚¬í•­</th></tr></thead><tbody>`;
                data.data.forEach(note => {
                    tableHtml += `<tr>
                        <td>${escapeHtml(note.teamName)}</td>
                        <td>${displayMember(note.name, note.cohort)}</td>
                        <td>${escapeHtml(note.note).replaceAll('\n', '<br>')}</td>
                    </tr>`;
                });
                tableHtml += `</tbody></table>`;
                notesDiv.innerHTML = tableHtml;
            } else {
                notesDiv.innerHTML = `<div class="message info">ë‚ ì§œ: ${date}ì— ê¸°ë¡ëœ íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        } catch(e) {
            notesDiv.innerHTML = `<div class="message error">íŠ¹ì´ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨</div>`;
        }
    }
    document.getElementById("adminNotesDateInput").addEventListener("change", loadAdminNotes);
    
    // ê±´ì˜ì‚¬í•­ íƒ­ ë¡œë“œ
    async function loadAdminSuggestions() {
        const date = document.getElementById("adminSugDateInput").value;
        const sugDiv = document.getElementById("suggestionsList");
        sugDiv.innerHTML = `<div class="message info">ê±´ì˜ì‚¬í•­ ë¡œë“œ ì¤‘...</div>`;

        try {
            const data = await apiGet("getSuggestionsByDate", { date });
            if (data && data.status === "success" && data.data) {
                let html = ``;
                data.data.forEach(sug => {
                    html += `<div class="suggestion-item">
                        <div class="suggestion-team">${escapeHtml(sug.teamName)}</div>
                        <p style="margin-top:.5rem; white-space:pre-wrap;">${escapeHtml(sug.suggestion)}</p>
                    </div>`;
                });
                sugDiv.innerHTML = html;
            } else {
                sugDiv.innerHTML = `<div class="message info">ë‚ ì§œ: ${date}ì— ê¸°ë¡ëœ ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        } catch(e) {
            sugDiv.innerHTML = `<div class="message error">ê±´ì˜ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨</div>`;
        }
    }
    document.getElementById("adminSugDateInput").addEventListener("change", loadAdminSuggestions);

    // ê°œì¸ ì¶œì„ë¥  íƒ­ ë¡œë“œ (ì´ˆê¸° ë°ì´í„° ì¤€ë¹„)
    async function loadAdminMembers() {
        // ì´ ë¶€ë¶„ì€ Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•˜ë©°, Apps Scriptì—ì„œ ëª¨ë“  ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ selectì— ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
        const memberSelect = document.getElementById("memberSelect");
        memberSelect.innerHTML = '<option value="">ì‚¬ëŒ ì„ íƒ</option>';

        // Apps Scriptì—ì„œ ëª¨ë“  ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¨ë‹¤ê³  ê°€ì •
        try {
            const allMembers = await apiGet("getAllMembers"); // ê°€ì •ëœ API í˜¸ì¶œ
            if (allMembers && allMembers.status === "success" && allMembers.data) {
                allMembers.data.forEach(m => {
                    const key = memberKey(m.name, m.cohort);
                    const displayName = displayMember(m.name, m.cohort);
                    memberSelect.innerHTML += `<option value="${key}">${escapeHtml(displayName)}</option>`;
                });
            }
        } catch(e) {
             console.error("ë©¤ë²„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
             memberSelect.innerHTML += `<option value="" disabled>ë©¤ë²„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</option>`;
        }
        
        // ë‚ ì§œ ë²”ìœ„ ì´ˆê¸°í™” (ì˜ˆ: ìµœê·¼ 1ë…„)
        const end = new Date();
        const start = new Date(end);
        start.setFullYear(end.getFullYear() - 1);

        document.getElementById("memberEndDate").value = formatISODate(end);
        document.getElementById("memberStartDate").value = formatISODate(start);
        
        // ì—¬ê¸°ì— ì´ˆê¸° ê·¸ë˜í”„ ë° ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œì´ í•„ìš”í•©ë‹ˆë‹¤.
        // loadMemberAttendance(); // ì˜ˆì‹œ í•¨ìˆ˜
    }

    // ì´ˆê¸°í™” ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • ë° ê·¸ë¦¬ë“œ ë¡œë“œ
    document.addEventListener("DOMContentLoaded", ()=>{
      initTeamGrid();
    });
    
  </script>
</body>
</html>
