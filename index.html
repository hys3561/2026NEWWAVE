<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>뉴웨이브 청년1부 사랑방 출석체크</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#f9fafb; min-height:100vh; }
    .hidden { display:none !important; }

    .header { background:#fff; border-bottom:1px solid #e5e7eb; padding:1.15rem 1rem; position:sticky; top:0; z-index:100; }
    .header-content { max-width:1200px; margin:0 auto; position:relative; }
    h1 { font-size:1.45rem; color:#111827; }
    .subtitle { color:#6b7280; font-size:0.9rem; font-weight:800; margin-top:0.35rem; }

    .admin-button { position:absolute; top:0; right:0; background:#6b7280; color:#fff; padding:0.5rem 1rem; border-radius:0.85rem; border:none; cursor:pointer; font-size:0.875rem; font-weight:900; }
    .admin-button:hover { background:#4b5563; }

    .container { max-width:1200px; margin:0 auto; padding:1.5rem 1rem; }

    /* 홈: 팀 카드 */
    .team-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1rem; }
    .team-card { background:#fff; padding:1.5rem; border-radius:0.95rem; border:2px solid #e5e7eb; cursor:pointer; transition:all .2s; }
    .team-card:hover { border-color:#2563eb; box-shadow:0 10px 15px -3px rgba(0,0,0,.1); }
    .team-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; }

    /* ✅ 요청: 숫자(팀번호) 크게 보이지 않게, 사랑방 이름은 더 크게 */
    .team-number { width:2.5rem; height:2.5rem; background:#dbeafe; border-radius:0.9rem; display:flex; align-items:center; justify-content:center; color:#2563eb; font-weight:950; font-size:1.0rem; }
    .team-card:hover .team-number { background:#2563eb; color:#fff; }

    .member-count { background:#f3f4f6; padding:.25rem .75rem; border-radius:9999px; font-size:.875rem; color:#6b7280; font-weight:900; }
    .team-name { font-size:1.65rem; font-weight:950; color:#111827; margin-bottom:.25rem; }
    .team-leader { font-size:.9rem; color:#6b7280; font-weight:800; }

    .back-button { display:flex; align-items:center; gap:.5rem; color:#6b7280; background:none; border:none; cursor:pointer; font-size:1rem; padding:.5rem .25rem; font-weight:900; }
    .back-button:hover { color:#111827; }

    /* 날짜/요약 */
    .date-section { background:#fff; padding:1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .date-label { font-size:.875rem; font-weight:950; color:#374151; margin-bottom:.5rem; }
    .date-input {
      width:100%;
      padding:.75rem 1rem;
      border:1px solid #d1d5db;
      border-radius:.9rem;
      font-size:16px; /* 모바일 줌/깨짐 방지 */
      -webkit-appearance:none; appearance:none;
      background:#fff;
    }

    .summary-box { background:#eff6ff; padding:1rem; border-radius:.95rem; border:1px solid #bfdbfe; margin-bottom:1rem; }
    .summary-content { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .summary-title { font-weight:950; color:#111827; }
    .summary-count { font-size:1.5rem; font-weight:950; color:#2563eb; }
    .progress-bar { background:#e5e7eb; border-radius:9999px; height:.5rem; overflow:hidden; }
    .progress-fill { background:#2563eb; height:100%; transition:width .3s; }

    .search-section { background:#fff; padding:.75rem 1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .search-input { width:100%; padding:.65rem .9rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; }

    .member-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:.75rem; margin-bottom:1rem; }
    @media (min-width:768px){ .member-list{ grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); } }

    .member-item { background:#fff; padding:.9rem; border-radius:.95rem; border:2px solid #e5e7eb; transition:all .2s; }
    .member-item.checked { background:#eff6ff; border-color:#2563eb; }

    .member-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; gap:.5rem; }
    .member-name { font-size:1rem; font-weight:950; color:#374151; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .checkbox { width:1.75rem; height:1.75rem; border-radius:9999px; border:2px solid #d1d5db; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .member-item.checked .checkbox { background:#2563eb; border-color:#2563eb; }
    .checkmark { display:none; color:#fff; font-weight:950; font-size:.95rem; }
    .member-item.checked .checkmark { display:block; }

    /* 특이사항: 아래로 */
    .note-section { margin-top:.75rem; padding-top:.75rem; border-top:1px solid #e5e7eb; }
    .note-label { font-size:.8rem; font-weight:950; color:#6b7280; margin-bottom:.35rem; }
    .note-input { width:100%; padding:.55rem .65rem; border:1px solid #d1d5db; border-radius:.85rem; font-size:16px; }

    .suggestion-section { background:#fff; padding:1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .suggestion-textarea { width:100%; padding:.75rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; min-height:90px; }

    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    .sticky-actions { position:sticky; bottom:0; background:rgba(249,250,251,.95); border-top:1px solid #e5e7eb; padding:.75rem 0 calc(.75rem + var(--safe-bottom)) 0; backdrop-filter:blur(6px); }
    .save-button { width:100%; background:#2563eb; color:#fff; padding:.95rem; border-radius:.95rem; border:none; font-size:1.05rem; font-weight:950; cursor:pointer; }
    .save-button:hover { background:#1d4ed8; }

    .message { padding:.85rem 1rem; border-radius:.95rem; text-align:center; font-weight:950; margin-top:.75rem; }
    .message.success { background:#f0fdf4; color:#15803d; border:1px solid #bbf7d0; }
    .message.error { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .message.info  { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }

    /* 관리자 */
    .dashboard-tabs { display:flex; gap:1rem; margin-bottom:1.25rem; border-bottom:2px solid #e5e7eb; flex-wrap:wrap; }
    .tab-button { padding:.75rem 1.25rem; background:none; border:none; cursor:pointer; color:#6b7280; border-bottom:2px solid transparent; margin-bottom:-2px; font-weight:950; }
    .tab-button.active { color:#2563eb; border-bottom-color:#2563eb; }

    .admin-summary { display:grid; grid-template-columns:repeat(3, 1fr); gap:.75rem; margin:1rem 0; }
    .admin-summary-card { background:#fff; border:1px solid #e5e7eb; border-radius:.95rem; padding:1rem; }
    .admin-summary-label { font-size:.875rem; color:#6b7280; font-weight:950; margin-bottom:.25rem; }
    .admin-summary-value { font-size:1.6rem; font-weight:950; color:#111827; }
    .admin-summary-note { font-size:.9rem; color:#6b7280; margin-bottom:1rem; font-weight:800; }

    .attendance-table, .notes-table { background:#fff; border-radius:.95rem; border:1px solid #e5e7eb; overflow-x:auto; }
    .attendance-table table, .notes-table table { width:100%; border-collapse:collapse; }
    .attendance-table th, .notes-table th { background:#f9fafb; padding:.75rem; text-align:left; font-size:.875rem; font-weight:950; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
    .attendance-table td, .notes-table td { padding:.75rem; border-bottom:1px solid #e5e7eb; font-size:.875rem; vertical-align:top; }

    .suggestion-list { background:#fff; border-radius:.95rem; border:1px solid #e5e7eb; padding:1rem; }
    .suggestion-item { padding:1rem; border-bottom:1px solid #e5e7eb; }
    .suggestion-team { font-weight:950; color:#111827; }

    /* ✅ 관리자 출석현황: 행 아래 토글 상세 */
    .team-row { cursor: pointer; }
    .team-row:hover td { background: #f9fafb; }
    
    .detail-row td { padding: 0 !important; background: #f9fafb; }
    .detail-panel { padding: 1rem; border-top: 1px solid #e5e7eb; }
    
    .detail-grid { display: grid; gap: .75rem; grid-template-columns: 1fr; }
    @media (min-width: 768px){
      .detail-grid { grid-template-columns: 1fr 1fr; }
    }
    
    .detail-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .95rem;
      padding: .9rem;
    }
    
    .detail-title { font-weight: 950; color: #111827; margin-bottom: .5rem; }
    .detail-sub { font-size: .9rem; font-weight: 900; color: #6b7280; margin-bottom: .4rem; }
    
    .chips { display:flex; flex-wrap:wrap; gap:.35rem; }
    .chip {
      padding: .25rem .55rem;
      border-radius: 9999px;
      font-size: .85rem;
      font-weight: 900;
      background: #eef2ff;
      color: #1d4ed8;
    }
    .chip.absent { background:#fef2f2; color:#b91c1c; }
    .chip.note   { background:#f0fdf4; color:#15803d; }
    
    .note-list { display:flex; flex-direction:column; gap:.35rem; }
    .note-item {
      border: 1px solid #e5e7eb;
      background: #fff;
      border-radius: .75rem;
      padding: .6rem .7rem;
      font-weight: 800;
      color: #374151;
      white-space: pre-wrap;
    }
    .note-name { font-weight: 950; color:#111827; }
    .note-badge { font-size:.8rem; font-weight:950; color:#6b7280; margin-left:.4rem; }


    /* 비밀번호 모달 */
    .modal-overlay { position:fixed; inset:0; background:rgba(17,24,39,.55); display:flex; align-items:center; justify-content:center; padding:1rem; z-index:999; }
    .modal { width:100%; max-width:420px; background:#fff; border-radius:1rem; border:1px solid #e5e7eb; box-shadow:0 20px 25px -5px rgba(0,0,0,.15); overflow:hidden; }
    .modal-header { padding:1rem 1rem .75rem 1rem; border-bottom:1px solid #e5e7eb; }
    .modal-title { font-size:1.1rem; font-weight:950; color:#111827; }
    .modal-subtitle { margin-top:.25rem; font-size:.9rem; color:#6b7280; font-weight:800; }
    .modal-body { padding:1rem; }
    .modal-input { width:100%; padding:.8rem .9rem; border:1px solid #d1d5db; border-radius:.95rem; font-size:16px; }
    .modal-error { margin-top:.75rem; color:#b91c1c; font-weight:950; font-size:.9rem; }
    .modal-actions { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; padding:0 1rem 1rem 1rem; }
    .modal-btn { border:none; border-radius:.95rem; padding:.85rem .9rem; font-weight:950; cursor:pointer; font-size:.95rem; }
    .modal-btn.primary { background:#2563eb; color:#fff; }
    .modal-btn.primary:hover { background:#1d4ed8; }
    .modal-btn.ghost { background:#f3f4f6; color:#111827; }
    .modal-btn.ghost:hover { background:#e5e7eb; }

    @media (max-width:640px){
      .header{ padding:1rem 1rem; }
      h1{ font-size:1.25rem; }
      .container{ padding:1rem 1rem; }
      .admin-button{ padding:.45rem .8rem; font-size:.8rem; }
      .admin-summary{ grid-template-columns:1fr; }
      .team-grid{ grid-template-columns:1fr; }
      .member-list{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
      .team-name{ font-size:1.5rem; }
    }
  </style>
</head>

<body>
  <!-- 홈 -->
  <div id="homePage">
    <div class="header">
      <div class="header-content">
        <button type="button" class="admin-button" id="adminBtn">관리자</button>
        <h1>뉴웨이브 청년1부 사랑방 출석체크</h1>
        <p class="subtitle">사랑방을 선택해주세요</p>
      </div>
    </div>
    <div class="container">
      <div class="team-grid" id="teamGrid"></div>
    </div>
  </div>

  <!-- 출석 페이지 -->
  <div id="attendancePage" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="teamBackBtn">← 돌아가기</button>
        <h1 id="selectedTeamName"></h1>
        <p class="subtitle" id="selectedTeamLeader"></p>
      </div>
    </div>

    <div class="container">
      <div class="date-section">
        <div class="date-label">날짜 선택</div>
        <input type="date" class="date-input" id="dateInput" />
      </div>

      <div class="summary-box">
        <div class="summary-content">
          <span class="summary-title">출석 현황</span>
          <span class="summary-count" id="attendanceCount">0 / 0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="search-section">
        <input id="memberSearch" class="search-input" placeholder="이름 검색 (예: 홍길동)" />
      </div>

      <div class="member-list" id="memberList"></div>

      <div class="suggestion-section">
        <div class="date-label">건의사항 (선택)</div>
        <textarea class="suggestion-textarea" id="suggestionInput" placeholder="건의사항을 작성해주세요"></textarea>
      </div>

      <div class="sticky-actions">
        <button type="button" class="save-button" id="saveBtn">출석 정보 저장</button>
        <div id="messageBox" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- 관리자 대시보드 -->
  <div id="adminDashboard" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="adminBackBtn">← 돌아가기</button>
        <h1>관리자 대시보드</h1>
        <p class="subtitle">날짜를 선택하면 전체 현황/특이사항/건의사항/개인 출석률을 확인할 수 있습니다.</p>
      </div>
    </div>

    <div class="container">
      <div class="dashboard-tabs">
        <button type="button" class="tab-button active" data-tab="stats">출석 현황</button>
        <button type="button" class="tab-button" data-tab="notes">특이사항</button>
        <button type="button" class="tab-button" data-tab="suggestions">건의사항</button>
        <button type="button" class="tab-button" data-tab="members">개인 출석률</button>
      </div>

      <div id="adminStatsTab">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminDateInput" />
        </div>

        <div class="admin-summary">
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 출석</div>
            <div class="admin-summary-value" id="adminTotalPresent">0명</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 결석</div>
            <div class="admin-summary-value" id="adminTotalAbsent">0명</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 출석률</div>
            <div class="admin-summary-value" id="adminTotalRate">0%</div>
          </div>
        </div>

        <div class="admin-summary-note" id="adminSummaryNote"></div>
        <div class="attendance-table" id="attendanceTable"></div>

        <!-- ✅ 사랑방 행 클릭 시 상세 -->
        <div id="adminTeamDetail" class="hidden" style="margin-top:1rem;">
          <div class="admin-summary-note" id="adminTeamDetailTitle" style="margin-bottom:.75rem;"></div>

          <div class="admin-summary">
            <div class="admin-summary-card">
              <div class="admin-summary-label">출석</div>
              <div class="admin-summary-value" id="teamDetailPresent">0명</div>
            </div>
            <div class="admin-summary-card">
              <div class="admin-summary-label">결석</div>
              <div class="admin-summary-value" id="teamDetailAbsent">0명</div>
            </div>
            <div class="admin-summary-card">
              <div class="admin-summary-label">출석률</div>
              <div class="admin-summary-value" id="teamDetailRate">0%</div>
            </div>
          </div>

          <div class="notes-table" id="teamDetailTable"></div>
        </div>
      </div>

      <div id="adminNotesTab" class="hidden">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminNotesDateInput" />
        </div>
        <div class="notes-table" id="notesTable"></div>
      </div>

      <div id="adminSuggestionsTab" class="hidden">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminSugDateInput" />
        </div>
        <div class="suggestion-list" id="suggestionsList"></div>
      </div>

      <div id="adminMembersTab" class="hidden">
        <div class="date-section">
          <div class="date-label">연도 선택 (예: 2026, 비우면 전체)</div>
          <input type="number" class="date-input" id="adminMemberYear" min="2000" max="2100" placeholder="2026" />
        </div>

        <div class="date-section">
          <div class="date-label">사람 선택</div>
          <select class="date-input" id="adminMemberSelect"></select>
        </div>

        <div class="admin-summary">
          <div class="admin-summary-card">
            <div class="admin-summary-label">총 집계 횟수</div>
            <div class="admin-summary-value" id="memberTotalSessions">0회</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">출석</div>
            <div class="admin-summary-value" id="memberPresent">0회</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">출석률</div>
            <div class="admin-summary-value" id="memberRate">0%</div>
          </div>
        </div>

        <div class="notes-table" id="memberHistoryTable"></div>
      </div>
    </div>
  </div>

  <!-- 비밀번호 모달 -->
  <div id="passwordModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">비밀번호 입력</div>
        <div class="modal-subtitle" id="modalSubtitle"></div>
      </div>
      <div class="modal-body">
        <input type="password" id="modalPassword" class="modal-input" placeholder="비밀번호" />
        <div id="modalError" class="modal-error hidden"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn ghost" id="modalCancelBtn">취소</button>
        <button type="button" class="modal-btn primary" id="modalOkBtn">확인</button>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * ✅ Apps Script Web App URL (/exec)
     * - 반드시 본인 배포 URL로 교체
     ************************************************************/
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw4mWKbTPNBpS6tIRnr90LIPVH4eW9gggRnlx-vpoL0f1r4y59loC_GKJziULOwpJU8Kg/exec";

    /************************************************************
     * ✅ 비밀번호(HTML 저장)
     * - 보안상 완전하지 않습니다(코드에서 볼 수 있음).
     * - 윤호님 요청대로 프론트에서만 체크합니다.
     ************************************************************/
    const ADMIN_PASSWORD = "newwave2026";
    const TEAM_PASSWORDS = {
      "1": "pw1111",
      "2": "pw2222",
      "3": "pw3333",
      "4": "pw4444",
      "5": "pw5555",
      "6": "pw6666",
      "7": "pw7777",
      "8": "pw8888",
      "9": "pw9999",
      "10": "pw1010",
      "11": "pw1110",
      "12": "pw1212"
    };

    /************************************************************
     * ✅ 사랑방 목록 (members를 직접 수정 가능)
     * - 여기 members를 “실명 명단”으로 쭉 작성하시면 됩니다.
     ************************************************************/
    const TEAMS = [
      { id: 1, name: "권준형 사랑방", leader: "방장: 권준형", members: ["방원1","방원2","방원3","방원4"] },
      { id: 2, name: "김나림 사랑방", leader: "방장: 김나림", members: ["방원1","방원2","방원3"] },
      { id: 3, name: "문유안 사랑방", leader: "방장: 문유안", members: ["방원1","방원2","방원3"] },
      { id: 4, name: "벡에스더 사랑방", leader: "방장: 벡에스더", members: ["방원1","방원2","방원3"] },
      { id: 5, name: "이예정 사랑방", leader: "방장: 이예정", members: ["방원1","방원2","방원3"] },
      { id: 6, name: "이지빈 사랑방", leader: "방장: 이지빈", members: ["방원1","방원2","방원3"] },
      { id: 7, name: "이하은 사랑방", leader: "방장: 이하은", members: ["방원1","방원2","방원3"] },
      { id: 8, name: "이희진 사랑방", leader: "방장: 이희진", members: ["방원1","방원2","방원3"] },
      { id: 9, name: "임사랑 사랑방", leader: "방장: 임사랑", members: ["방원1","방원2","방원3"] },
      { id: 10, name: "장하늘 사랑방", leader: "방장: 장하늘", members: ["방원1","방원2","방원3"] },
      { id: 11, name: "하재영 사랑방", leader: "방장: 하재영", members: ["방원1","방원2","방원3"] },
      { id: 12, name: "Wee팀", leader: "방장: 권하경, 최수인", members: ["방원1","방원2","방원3"] }
    ];

    /************************************************************
     * 상태
     ************************************************************/
    let selectedTeam = null;
    let attendance = {};
    let memberNotes = {};
    let adminAuthed = false;

    /************************************************************
     * 페이지 전환
     ************************************************************/
    function showPage(pageId){
      document.getElementById("homePage").classList.add("hidden");
      document.getElementById("attendancePage").classList.add("hidden");
      document.getElementById("adminDashboard").classList.add("hidden");
      document.getElementById(pageId).classList.remove("hidden");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showMsg(type, text){
      const box = document.getElementById("messageBox");
      box.className = "message " + (type || "");
      box.textContent = text || "";
      box.classList.remove("hidden");
      setTimeout(()=> box.classList.add("hidden"), 2500);
    }

    /************************************************************
     * JSONP(GET)
     ************************************************************/
    function jsonp(url, params){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
        params = params || {};
        params.callback = cb;

        const qs = Object.keys(params).map(k => encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join("&");
        const script = document.createElement("script");
        script.src = url + (url.includes("?") ? "&" : "?") + qs;

        const t = setTimeout(()=>{
          cleanup();
          reject(new Error("JSONP timeout"));
        }, 12000);

        function cleanup(){
          clearTimeout(t);
          if (script && script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cb]; } catch(e){ window[cb] = undefined; }
        }

        window[cb] = (data)=>{ cleanup(); resolve(data); };
        script.onerror = ()=>{ cleanup(); reject(new Error("JSONP network error")); };
        document.body.appendChild(script);
      });
    }

    function apiGet(action, params){
      params = params || {};
      params.action = action;
      return jsonp(GOOGLE_SCRIPT_URL, params);
    }

    /************************************************************
     * 비밀번호 모달
     ************************************************************/
    const modal = document.getElementById("passwordModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubtitle = document.getElementById("modalSubtitle");
    const modalPassword = document.getElementById("modalPassword");
    const modalError = document.getElementById("modalError");

    let modalState = { mode:null, teamId:null }; // mode: "team" | "admin"

    function openPasswordModal({mode, teamId, title, subtitle}){
      modalState = { mode, teamId: teamId ?? null };
      modalTitle.textContent = title || "비밀번호 입력";
      modalSubtitle.textContent = subtitle || "";
      modalPassword.value = "";
      modalError.textContent = "";
      modalError.classList.add("hidden");
      modal.classList.remove("hidden");
      setTimeout(()=> modalPassword.focus(), 0);
    }

    function closePasswordModal(){
      modal.classList.add("hidden");
      modalState = { mode:null, teamId:null };
    }

    function setModalError(msg){
      modalError.textContent = msg;
      modalError.classList.remove("hidden");
    }

    function submitPassword(){
      const pw = modalPassword.value || "";

      if (modalState.mode === "admin") {
        if (pw !== ADMIN_PASSWORD) { setModalError("비밀번호가 틀렸습니다."); return; }
        adminAuthed = true;
        closePasswordModal();
        showAdminDashboard();
        return;
      }

      if (modalState.mode === "team") {
        const teamId = String(modalState.teamId || "");
        const expected = TEAM_PASSWORDS[teamId] ?? "";
        if (!expected) { setModalError("이 사랑방은 비밀번호가 설정되어 있지 않습니다."); return; }
        if (pw !== expected) { setModalError("비밀번호가 틀렸습니다."); return; }

        const team = TEAMS.find(t => String(t.id) === teamId);
        if (!team) { setModalError("사랑방 정보를 찾을 수 없습니다."); return; }

        closePasswordModal();
        selectTeam(team); // ✅ 출석 화면으로 이동
        return;
      }
    }

    document.getElementById("modalCancelBtn").addEventListener("click", closePasswordModal);
    document.getElementById("modalOkBtn").addEventListener("click", submitPassword);
    modalPassword.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); submitPassword(); }
      if (e.key === "Escape") closePasswordModal();
    });
    modal.addEventListener("click", (e)=>{ if (e.target.id === "passwordModal") closePasswordModal(); });

    /************************************************************
     * 홈: 팀 카드
     ************************************************************/
    function initTeamGrid(){
      const grid = document.getElementById("teamGrid");
      grid.innerHTML = "";

      TEAMS.forEach(team=>{
        const card = document.createElement("div");
        card.className = "team-card";
        card.innerHTML = `
          <div class="team-card-header">
            <div class="team-number">${team.id}</div>
            <div class="member-count">${team.members.length}명</div>
          </div>
          <div class="team-name">${escapeHtml(team.name)}</div>
          <div class="team-leader">${escapeHtml(team.leader)}</div>
        `;

        // ✅ 홈 진입 시가 아니라, "카드 클릭 시"만 비번 모달
        card.addEventListener("click", (e)=>{
          e.preventDefault();
          openPasswordModal({
            mode:"team",
            teamId: team.id,
            title: team.name + " 비밀번호",
            subtitle: "해당 사랑방장만 출석/특이사항을 수정할 수 있습니다."
          });
        });

        grid.appendChild(card);
      });
    }

    /************************************************************
     * 출석 페이지
     ************************************************************/
    const today = new Date().toISOString().split("T")[0];
    const dateInput = document.getElementById("dateInput");
    dateInput.value = today;

    function resetStateForTeam(team){
      attendance = {};
      memberNotes = {};
      document.getElementById("suggestionInput").value = "";
      team.members.forEach(n => { attendance[n] = false; memberNotes[n] = ""; });
    }

    function buildMemberList(team){
      const list = document.getElementById("memberList");
      list.innerHTML = "";

      team.members.forEach(name=>{
        const item = document.createElement("div");
        item.className = "member-item";
        item.dataset.name = name;

        item.innerHTML = `
          <div class="member-header">
            <span class="member-name">${escapeHtml(name)}</span>
            <div class="checkbox"><span class="checkmark">✓</span></div>
          </div>
          <div class="note-section">
            <div class="note-label">특이사항</div>
            <input class="note-input" placeholder="특이사항 입력" />
          </div>
        `;
        list.appendChild(item);
      });
    }

    function updateCount(){
      let present = 0;
      if (!selectedTeam) return;
      selectedTeam.members.forEach(n=>{ if (attendance[n]) present++; });
      const total = selectedTeam.members.length;
      document.getElementById("attendanceCount").textContent = `${present} / ${total}`;
      document.getElementById("progressFill").style.width = (total>0 ? (present/total)*100 : 0) + "%";
    }

    function applyMemberFilter(q){
      q = (q || "").trim().toLowerCase();
      document.querySelectorAll("#memberList .member-item").forEach(item=>{
        const name = (item.dataset.name || "").toLowerCase();
        item.style.display = name.includes(q) ? "" : "none";
      });
    }

    async function loadTeamDataFromServer(team, date){
      try {
        const res = await apiGet("getTeamSubmission", { teamId:String(team.id), date });
        if (!res || !res.ok) { showMsg("error", "데이터 로드 실패"); return; }

        resetStateForTeam(team);

        // ✅ 이전 저장 데이터가 있으면 그대로 복원
        if (res.found && res.submission && Array.isArray(res.submission.attendance)) {
          res.submission.attendance.forEach(r=>{
            if (!r || !r.name) return;
            attendance[r.name] = !!r.present;
            memberNotes[r.name] = String(r.note || "");
          });
          document.getElementById("suggestionInput").value = String(res.submission.suggestion || "");
        }

        // UI 반영
        document.querySelectorAll("#memberList .member-item").forEach(item=>{
          const n = item.dataset.name;
          item.classList.toggle("checked", !!attendance[n]);
          const input = item.querySelector(".note-input");
          if (input) input.value = memberNotes[n] || "";
        });

        updateCount();
      } catch(e){
        showMsg("error", "서버 연결 실패 (Apps Script URL/배포 설정 확인)");
      }
    }

    function selectTeam(team){
      selectedTeam = team;

      document.getElementById("selectedTeamName").textContent = team.name;
      document.getElementById("selectedTeamLeader").textContent = team.leader;

      buildMemberList(team);
      resetStateForTeam(team);

      showPage("attendancePage"); // ✅ 강제 이동

      document.getElementById("memberSearch").value = "";
      applyMemberFilter("");

      showMsg("info", "데이터를 불러오는 중입니다...");
      loadTeamDataFromServer(team, dateInput.value || today);
    }

    // 멤버 체크/특이사항
    document.getElementById("memberList").addEventListener("click", (e)=>{
      const header = e.target.closest(".member-header");
      if (!header || !selectedTeam) return;

      const item = header.closest(".member-item");
      if (!item) return;
      const name = item.dataset.name;

      attendance[name] = !attendance[name];
      item.classList.toggle("checked", !!attendance[name]);
      updateCount();
    });

    document.getElementById("memberList").addEventListener("input", (e)=>{
      if (!e.target.classList.contains("note-input")) return;
      const item = e.target.closest(".member-item");
      if (!item) return;
      const name = item.dataset.name;
      memberNotes[name] = e.target.value || "";
    });

    document.getElementById("memberSearch").addEventListener("input", (e)=>{
      applyMemberFilter(e.target.value);
    });

    // ✅ 날짜 변경 시에도 서버에서 저장본을 재로드
    dateInput.addEventListener("change", ()=>{
      if (!selectedTeam) return;
      showMsg("info", "데이터를 불러오는 중입니다...");
      loadTeamDataFromServer(selectedTeam, dateInput.value || today);
    });

    // 저장
    async function saveAttendance(){
      if (!selectedTeam) return;

      const payload = {
        action: "submit",
        teamId: String(selectedTeam.id),
        date: dateInput.value || today,
        teamName: selectedTeam.name,
        leader: selectedTeam.leader,
        suggestion: document.getElementById("suggestionInput").value || "",
        attendance: selectedTeam.members.map(m => ({
          name: m,
          present: !!attendance[m],
          note: memberNotes[m] || ""
        }))
      };

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        showMsg("success", "저장되었습니다!");
        // ✅ 저장 직후 재조회(최신 데이터 반영)
        loadTeamDataFromServer(selectedTeam, dateInput.value || today);
      } catch(e){
        showMsg("error", "저장 실패 (네트워크/URL 확인)");
      }
    }

    document.getElementById("saveBtn").addEventListener("click", saveAttendance);

    /************************************************************
     * 관리자
     ************************************************************/
    const adminDateInput = document.getElementById("adminDateInput");
    const adminNotesDateInput = document.getElementById("adminNotesDateInput");
    const adminSugDateInput = document.getElementById("adminSugDateInput");
    adminDateInput.value = today;
    adminNotesDateInput.value = today;
    adminSugDateInput.value = today;

    function showAdminDashboard(){
      showPage("adminDashboard");
      loadAdminAll();
    }

    async function fetchAdminByDate(date){
      const res = await apiGet("getSubmissionsByDate", { date });
      if (!res || !res.ok) throw new Error("admin fetch failed");
      return res;
    }

  // ✅ 관리자 상세 캐시 (date|teamId)
  const adminDetailCache = {}; // key: `${date}|${teamId}` -> submission
  
  async function renderAdminStats(date){
    const data = await fetchAdminByDate(date);
  
    // 팀 요약 (제출 여부/출석수/결석수/총원)
    const map = {};
    (data.teams || []).forEach(t => { map[String(t.teamId)] = t; });
  
    let totalPresent = 0;
    let totalMembers = 0;
    let submittedCount = 0;
  
    // ✅ 방장 컬럼 삭제: (사랑방 / 출석 / 결석 / 출석률 / 상태)
    let rows = "";
    TEAMS.forEach(team=>{
      const sub = map[String(team.id)];
  
      if (sub) {
        submittedCount++;
        totalPresent += Number(sub.present || 0);
        totalMembers += Number(sub.total || 0);
        const rate = (Number(sub.total) > 0) ? (Number(sub.present)/Number(sub.total))*100 : 0;
  
        rows += `
          <tr class="team-row" data-teamid="${team.id}" data-submitted="1">
            <td style="font-weight:950;">${escapeHtml(team.name)}</td>
            <td>${Number(sub.present||0)}</td>
            <td>${Number(sub.absent||0)}</td>
            <td>${rate.toFixed(1)}%</td>
            <td style="font-weight:950;color:#15803d;">제출</td>
          </tr>
          <tr class="detail-row hidden" data-detailfor="${team.id}">
            <td colspan="5">
              <div class="detail-panel" id="detail-${team.id}">
                <div style="font-weight:950;color:#6b7280;">행을 클릭하면 상세가 표시됩니다.</div>
              </div>
            </td>
          </tr>
        `;
      } else {
        rows += `
          <tr class="team-row" data-teamid="${team.id}" data-submitted="0">
            <td style="font-weight:950;">${escapeHtml(team.name)}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td style="font-weight:950;color:#b91c1c;">미제출</td>
          </tr>
          <tr class="detail-row hidden" data-detailfor="${team.id}">
            <td colspan="5">
              <div class="detail-panel" id="detail-${team.id}">
                <div style="font-weight:950;color:#6b7280;">미제출 사랑방입니다.</div>
              </div>
            </td>
          </tr>
        `;
      }
    });
  
    const totalAbsent = totalMembers - totalPresent;
    const totalRate = totalMembers > 0 ? (totalPresent/totalMembers)*100 : 0;
  
    document.getElementById("adminTotalPresent").textContent = totalPresent + "명";
    document.getElementById("adminTotalAbsent").textContent = totalAbsent + "명";
    document.getElementById("adminTotalRate").textContent = totalRate.toFixed(1) + "%";
    document.getElementById("adminSummaryNote").textContent =
      `집계 기준: ${date} / 제출 ${submittedCount}개 사랑방 / 집계 인원 ${totalMembers}명 (미제출은 집계에서 제외)`;
  
    document.getElementById("attendanceTable").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>사랑방</th>
            <th>출석</th>
            <th>결석</th>
            <th>출석률</th>
            <th>상태</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  
    // ✅ 이벤트 바인딩(중복 방지 위해 매 렌더 시 한번만)
    bindAdminRowToggle_();
  }
  
  let adminRowToggleBound = false;
  function bindAdminRowToggle_(){
    if (adminRowToggleBound) return;
    adminRowToggleBound = true;
  
    document.getElementById("attendanceTable").addEventListener("click", async (e)=>{
      const row = e.target.closest("tr.team-row");
      if (!row) return;
  
      const teamId = row.dataset.teamid;
      const submitted = row.dataset.submitted === "1";
      const date = adminDateInput.value || today;
  
      // 다른 열려있는 detail 닫기(원하시면 제거 가능)
      document.querySelectorAll('tr.detail-row').forEach(dr=>{
        if (dr.dataset.detailfor !== teamId) dr.classList.add("hidden");
      });
  
      const detailRow = document.querySelector(`tr.detail-row[data-detailfor="${teamId}"]`);
      if (!detailRow) return;
  
      // 토글
      const willOpen = detailRow.classList.contains("hidden");
      detailRow.classList.toggle("hidden", !willOpen);
  
      if (!willOpen) return; // 닫는 경우 종료
  
      const panel = document.getElementById(`detail-${teamId}`);
      if (!panel) return;
  
      if (!submitted) {
        panel.innerHTML = `<div style="font-weight:950;color:#6b7280;">미제출 사랑방입니다.</div>`;
        return;
      }
  
      // 캐시 먼저 확인
      const cacheKey = `${date}|${teamId}`;
      if (adminDetailCache[cacheKey]) {
        renderTeamDetailPanel_(panel, adminDetailCache[cacheKey]);
        return;
      }
  
      panel.innerHTML = `<div style="font-weight:950;color:#6b7280;">상세 불러오는 중...</div>`;
  
      try {
        const res = await apiGet("getTeamSubmission", { teamId: String(teamId), date });
        if (!res || !res.ok || !res.found || !res.submission) {
          panel.innerHTML = `<div style="font-weight:950;color:#b91c1c;">상세 데이터를 찾을 수 없습니다.</div>`;
          return;
        }
        adminDetailCache[cacheKey] = res.submission;
        renderTeamDetailPanel_(panel, res.submission);
  
      } catch(err) {
        panel.innerHTML = `<div style="font-weight:950;color:#b91c1c;">상세 조회 실패(네트워크/스크립트 배포 확인)</div>`;
      }
    });
  }
  
  function renderTeamDetailPanel_(panel, submission){
    const att = Array.isArray(submission.attendance) ? submission.attendance : [];
  
    const presentNames = [];
    const absentNames = [];
    const notes = [];
  
    att.forEach(a=>{
      const name = String(a?.name || "").trim();
      if (!name) return;
  
      const isPresent = !!a.present;
      const note = String(a?.note || "").trim();
  
      if (isPresent) presentNames.push(name);
      else absentNames.push(name);
  
      if (note) notes.push({ name, note, present: isPresent });
    });
  
    const total = att.length;
    const present = presentNames.length;
    const absent = total - present;
    const rate = total > 0 ? (present/total)*100 : 0;
  
    const presentChips = presentNames.length
      ? presentNames.map(n=>`<span class="chip">${escapeHtml(n)}</span>`).join("")
      : `<span style="font-weight:950;color:#6b7280;">없음</span>`;
  
    const absentChips = absentNames.length
      ? absentNames.map(n=>`<span class="chip absent">${escapeHtml(n)}</span>`).join("")
      : `<span style="font-weight:950;color:#6b7280;">없음</span>`;
  
    const notesHtml = notes.length
      ? `<div class="note-list">
          ${notes.map(x=>`
            <div class="note-item">
              <span class="note-name">${escapeHtml(x.name)}</span>
              <span class="note-badge">(${x.present ? "출석" : "결석"})</span><br/>
              ${escapeHtml(x.note)}
            </div>
          `).join("")}
        </div>`
      : `<div style="font-weight:950;color:#6b7280;">특이사항이 없습니다.</div>`;
  
    panel.innerHTML = `
      <div class="detail-grid">
        <div class="detail-card">
          <div class="detail-title">요약</div>
          <div class="detail-sub">출석률</div>
          <div style="font-size:1.35rem;font-weight:950;color:#2563eb;">${rate.toFixed(1)}%</div>
          <div style="margin-top:.4rem;font-weight:900;color:#6b7280;">
            출석 ${present}명 · 결석 ${absent}명 · 총 ${total}명
          </div>
        </div>
  
        <div class="detail-card">
          <div class="detail-title">출석자</div>
          <div class="chips">${presentChips}</div>
        </div>
  
        <div class="detail-card">
          <div class="detail-title">결석자</div>
          <div class="chips">${absentChips}</div>
        </div>
  
        <div class="detail-card">
          <div class="detail-title">특이사항</div>
          ${notesHtml}
        </div>
      </div>
    `;
  }


      const totalAbsent = totalMembers - totalPresent;
      const totalRate = totalMembers > 0 ? (totalPresent/totalMembers)*100 : 0;

      document.getElementById("adminTotalPresent").textContent = totalPresent + "명";
      document.getElementById("adminTotalAbsent").textContent = totalAbsent + "명";
      document.getElementById("adminTotalRate").textContent = totalRate.toFixed(1) + "%";
      document.getElementById("adminSummaryNote").textContent =
        `집계 기준: ${date} / 제출 ${submittedCount}개 사랑방 / 집계 인원 ${totalMembers}명 (미제출은 집계에서 제외)`;

      document.getElementById("attendanceTable").innerHTML = `
        <table>
          <thead>
            <tr><th>사랑방</th><th>출석</th><th>결석</th><th>출석률</th><th>상태</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      bindAdminTeamRowClicks_(date);
      document.getElementById("adminTeamDetail").classList.add("hidden");
    }

    function bindAdminTeamRowClicks_(date){
      document.querySelectorAll(".admin-team-row").forEach(tr=>{
        tr.addEventListener("click", async ()=>{
          const teamId = tr.dataset.teamid;
          await showAdminTeamDetail_(teamId, date);
        });
      });
    }

    async function showAdminTeamDetail_(teamId, date){
      const panel = document.getElementById("adminTeamDetail");
      const title = document.getElementById("adminTeamDetailTitle");
      const presentEl = document.getElementById("teamDetailPresent");
      const absentEl = document.getElementById("teamDetailAbsent");
      const rateEl = document.getElementById("teamDetailRate");
      const tableEl = document.getElementById("teamDetailTable");

      try {
        const res = await apiGet("getTeamSubmission", { teamId:String(teamId), date });
        const team = TEAMS.find(t => String(t.id) === String(teamId));
        const teamName = team ? team.name : ("Team " + teamId);

        if (!res || !res.ok || !res.found) {
          title.textContent = `${teamName} (${date}) : 제출된 데이터가 없습니다.`;
          presentEl.textContent = "0명";
          absentEl.textContent = "0명";
          rateEl.textContent = "0%";
          tableEl.innerHTML = `
            <table><tbody>
              <tr><td style="text-align:center;color:#6b7280;font-weight:950;">저장된 출석 데이터가 없습니다.</td></tr>
            </tbody></table>
          `;
          panel.classList.remove("hidden");
          return;
        }

        const sub = res.submission;
        const att = Array.isArray(sub.attendance) ? sub.attendance : [];
        const presentList = att.filter(a=>a && a.present===true).map(a=>a.name);
        const absentList  = att.filter(a=>a && a.present!==true).map(a=>a.name);

        const total = att.length;
        const present = presentList.length;
        const absent = total - present;
        const rate = total>0 ? (present/total)*100 : 0;

        title.textContent = `${teamName} (${date}) / ${escapeHtml(sub.leader || "")}`;
        presentEl.textContent = present + "명";
        absentEl.textContent = absent + "명";
        rateEl.textContent = rate.toFixed(1) + "%";

        const presentHtml = presentList.length
          ? presentList.map(n=>`<div style="padding:.25rem 0;font-weight:900;">✅ ${escapeHtml(n)}</div>`).join("")
          : `<div style="color:#6b7280;font-weight:900;">없음</div>`;

        const absentHtml  = absentList.length
          ? absentList.map(n=>`<div style="padding:.25rem 0;font-weight:900;">❌ ${escapeHtml(n)}</div>`).join("")
          : `<div style="color:#6b7280;font-weight:900;">없음</div>`;

        const notes = att.filter(a=>a && String(a.note||"").trim() !== "");
        const notesHtml = notes.length
          ? notes.map(a=>`<div style="padding:.25rem 0;"><span style="font-weight:950;">${escapeHtml(a.name)}</span> — <span style="white-space:pre-wrap;">${escapeHtml(a.note)}</span></div>`).join("")
          : `<div style="color:#6b7280;font-weight:900;">특이사항 없음</div>`;

        tableEl.innerHTML = `
          <table>
            <thead><tr><th>출석</th><th>결석</th><th>특이사항</th></tr></thead>
            <tbody>
              <tr>
                <td style="width:30%;">${presentHtml}</td>
                <td style="width:30%;">${absentHtml}</td>
                <td style="width:40%;">${notesHtml}</td>
              </tr>
            </tbody>
          </table>
        `;

        panel.classList.remove("hidden");
        panel.scrollIntoView({ behavior:"smooth", block:"start" });

      } catch(e){
        title.textContent = `상세 조회 실패: ${String(e)}`;
        panel.classList.remove("hidden");
      }
    }

    async function renderAdminNotes(date){
      const data = await fetchAdminByDate(date);
      const notesFlat = data.notesFlat || [];

      let rows = "";
      notesFlat.forEach(n=>{
        rows += `
          <tr>
            <td>${escapeHtml(n.teamName || "")}</td>
            <td>${escapeHtml(n.member || "")}</td>
            <td style="white-space:pre-wrap;">${escapeHtml(n.note || "")}</td>
          </tr>
        `;
      });

      document.getElementById("notesTable").innerHTML = `
        <table>
          <thead><tr><th>사랑방</th><th>방원</th><th>특이사항</th></tr></thead>
          <tbody>
            ${rows || `<tr><td colspan="3" style="text-align:center;color:#6b7280;font-weight:950;">특이사항이 없습니다.</td></tr>`}
          </tbody>
        </table>
      `;
    }

    async function renderAdminSuggestions(date){
      const data = await fetchAdminByDate(date);
      const list = data.suggestions || [];

      const html = list.length ? list.map(s=>`
        <div class="suggestion-item">
          <div class="suggestion-team">${escapeHtml(s.teamName||"")} (${escapeHtml(s.leader||"")})</div>
          <div style="margin-top:.5rem;color:#374151;white-space:pre-wrap;font-weight:800;">${escapeHtml(s.suggestion||"")}</div>
        </div>
      `).join("") : `<div style="text-align:center;color:#6b7280;padding:2rem;font-weight:950;">건의사항이 없습니다.</div>`;

      document.getElementById("suggestionsList").innerHTML = html;
    }

    /************************************************************
     * 개인 출석률
     ************************************************************/
    function getUniqueMembers_(){
      const set = new Set();
      TEAMS.forEach(t => (t.members||[]).forEach(m => set.add(m)));
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'ko'));
    }

    function initMemberSelect_(){
      const sel = document.getElementById("adminMemberSelect");
      if (!sel) return;
      const members = getUniqueMembers_();
      sel.innerHTML = members.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");
    }

    async function renderMemberStats_(){
      const yearEl = document.getElementById("adminMemberYear");
      const sel = document.getElementById("adminMemberSelect");
      const year = String(yearEl.value || "").trim();
      const member = String(sel.value || "").trim();
      if (!member) return;

      const res = await apiGet("getMemberHistory", { member, year });
      if (!res || !res.ok) {
        document.getElementById("memberHistoryTable").innerHTML =
          `<table><tbody><tr><td style="text-align:center;color:#b91c1c;font-weight:950;">조회 실패</td></tr></tbody></table>`;
        return;
      }

      document.getElementById("memberTotalSessions").textContent = (res.totalSessions||0) + "회";
      document.getElementById("memberPresent").textContent = (res.present||0) + "회";
      document.getElementById("memberRate").textContent = (Number(res.rate||0)).toFixed(1) + "%";

      const history = Array.isArray(res.history) ? res.history.slice().reverse() : []; // 최신이 위
      const rows = history.map(h=>`
        <tr>
          <td>${escapeHtml(h.date||"")}</td>
          <td>${escapeHtml(h.teamName||"")}</td>
          <td style="font-weight:950;color:${h.present ? "#15803d":"#b91c1c"};">${h.present ? "출석":"결석"}</td>
          <td style="white-space:pre-wrap;">${escapeHtml(h.note||"")}</td>
        </tr>
      `).join("");

      document.getElementById("memberHistoryTable").innerHTML = `
        <table>
          <thead><tr><th>날짜</th><th>사랑방</th><th>상태</th><th>특이사항</th></tr></thead>
          <tbody>
            ${rows || `<tr><td colspan="4" style="text-align:center;color:#6b7280;font-weight:950;">기록이 없습니다.</td></tr>`}
          </tbody>
        </table>
      `;
    }

    /************************************************************
     * 관리자 탭 로드
     ************************************************************/
    async function loadAdminAll(){
      if (!adminAuthed) return;
      const activeTab = document.querySelector(".tab-button.active")?.dataset?.tab || "stats";
      if (activeTab === "stats") await renderAdminStats(adminDateInput.value || today);
      if (activeTab === "notes") await renderAdminNotes(adminNotesDateInput.value || today);
      if (activeTab === "suggestions") await renderAdminSuggestions(adminSugDateInput.value || today);
      if (activeTab === "members") await renderMemberStats_();
    }

    document.querySelectorAll(".tab-button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.dataset.tab;
        document.getElementById("adminStatsTab").classList.toggle("hidden", tab !== "stats");
        document.getElementById("adminNotesTab").classList.toggle("hidden", tab !== "notes");
        document.getElementById("adminSuggestionsTab").classList.toggle("hidden", tab !== "suggestions");
        document.getElementById("adminMembersTab").classList.toggle("hidden", tab !== "members");

        loadAdminAll();
      });
    });

    adminDateInput.addEventListener("change", ()=> adminAuthed && renderAdminStats(adminDateInput.value || today));
    adminNotesDateInput.addEventListener("change", ()=> adminAuthed && renderAdminNotes(adminNotesDateInput.value || today));
    adminSugDateInput.addEventListener("change", ()=> adminAuthed && renderAdminSuggestions(adminSugDateInput.value || today));

    /************************************************************
     * 버튼 바인딩
     ************************************************************/
    document.getElementById("adminBtn").addEventListener("click", ()=>{
      openPasswordModal({
        mode:"admin",
        title:"관리자 탭 비밀번호",
        subtitle:"관리자 대시보드에 들어가려면 비밀번호를 입력하세요."
      });
    });

    document.getElementById("teamBackBtn").addEventListener("click", ()=>{
      closePasswordModal();
      selectedTeam = null;
      showPage("homePage");
    });

    document.getElementById("adminBackBtn").addEventListener("click", ()=>{
      adminAuthed = false;
      closePasswordModal();
      showPage("homePage");
    });

    /************************************************************
     * 초기화
     ************************************************************/
    initTeamGrid();
    showPage("homePage");

    // 개인 출석률 초기화
    initMemberSelect_();
    document.getElementById("adminMemberSelect").addEventListener("change", ()=> adminAuthed && renderMemberStats_());
    document.getElementById("adminMemberYear").addEventListener("change", ()=> adminAuthed && renderMemberStats_());
  </script>
</body>
</html>
