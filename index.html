<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>뉴웨이브 청년1부 사랑방 출석체크</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* CSS 스타일은 동일하게 유지 (지면 관계상 생략하지만, 기존 스타일을 그대로 사용합니다) */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#f9fafb; min-height:100vh; }
    .hidden { display:none !important; }
    .header { background:#fff; border-bottom:1px solid #e5e7eb; padding:1.25rem 1rem; position:sticky; top:0; z-index:100; }
    .header-content { max-width:1200px; margin:0 auto; position:relative; }
    h1 { font-size:1.5rem; color:#111827; }
    .subtitle { color:#6b7280; font-size:0.9rem; font-weight:800; margin-top:0.35rem; }
    .admin-button { position:absolute; top:0; right:0; background:#6b7280; color:#fff; padding:0.5rem 1rem; border-radius:0.85rem; border:none; cursor:pointer; font-size:0.875rem; font-weight:900; }
    .container { max-width:1200px; margin:0 auto; padding:1.5rem 1rem; }
    .team-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1rem; }
    .team-card { background:#fff; padding:1.5rem; border-radius:0.95rem; border:2px solid #e5e7eb; cursor:pointer; transition:all .2s; }
    .team-card:hover { border-color:#2563eb; box-shadow:0 10px 15px -3px rgba(0,0,0,.1); }
    .team-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; }
    .team-number { width:2.5rem; height:2.5rem; background:#dbeafe; border-radius:0.9rem; display:flex; align-items:center; justify-content:center; color:#2563eb; font-weight:950; font-size:1rem; }
    .team-name { font-size:1.65rem; font-weight:950; color:#111827; margin-bottom:.25rem; }
    .team-leader { font-size:.9rem; color:#6b7280; font-weight:800; }
    .member-count { background:#f3f4f6; padding:.25rem .75rem; border-radius:9999px; font-size:.875rem; color:#6b7280; font-weight:900; }
    .back-button { display:flex; align-items:center; gap:.5rem; color:#6b7280; background:none; border:none; cursor:pointer; font-size:1rem; padding:.5rem .25rem; font-weight:900; }
    .date-section { background:#fff; padding:1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .date-row { display: flex; gap: 0.5rem; align-items: center; }
    .date-label { font-size:.875rem; font-weight:950; color:#374151; margin-bottom:.5rem; }
    .date-input { flex: 1; padding:.75rem 1rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; background:#fff; display: block; }
    .load-button { background:#4b5563; color:white; border:none; padding:0 1.2rem; border-radius:.9rem; font-weight:900; cursor:pointer; font-size:0.9rem; height: 45px; }
    .summary-box { background:#eff6ff; padding:1rem; border-radius:.95rem; border:1px solid #bfdbfe; margin-bottom:1rem; }
    .summary-content { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .summary-title { font-weight:950; color:#111827; }
    .summary-count { font-size:1.5rem; font-weight:950; color:#2563eb; }
    .progress-bar { background:#e5e7eb; border-radius:9999px; height:.5rem; overflow:hidden; }
    .progress-fill { background:#2563eb; height:100%; transition:width .3s; }
    .search-input { width:100%; padding:.65rem .9rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; margin-bottom: 1rem; }
    .member-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:.75rem; margin-bottom:1rem; }
    .member-item { background:#fff; padding:.9rem; border-radius:.95rem; border:2px solid #e5e7eb; transition:all .2s; }
    .member-item.checked { background:#eff6ff; border-color:#2563eb; }
    .member-header { display:flex; justify-content:space-between; align-items:flex-start; cursor:pointer; gap:.5rem; }
    .member-name { font-size:1rem; font-weight:950; color:#374151; }
    .member-meta { margin-top:.2rem; font-size:.85rem; font-weight:900; color:#6b7280; }
    .checkbox { width:1.75rem; height:1.75rem; border-radius:9999px; border:2px solid #d1d5db; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:.1rem; }
    .member-item.checked .checkbox { background:#2563eb; border-color:#2563eb; }
    .checkmark { display:none; color:#fff; font-weight:950; font-size:.95rem; }
    .member-item.checked .checkmark { display:block; }
    .note-section { margin-top:.75rem; padding-top:.75rem; border-top:1px solid #e5e7eb; }
    .note-input { width:100%; padding:.55rem .65rem; border:1px solid #d1d5db; border-radius:.85rem; font-size:16px; }
    .suggestion-textarea { width:100%; padding:.75rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; min-height:90px; }
    .sticky-actions { position:sticky; bottom:0; background:rgba(249,250,251,.95); border-top:1px solid #e5e7eb; padding:.75rem 0 1rem 0; backdrop-filter:blur(6px); }
    .save-button { width:100%; background:#2563eb; color:#fff; padding:.95rem; border-radius:.95rem; border:none; font-size:1.05rem; font-weight:950; cursor:pointer; }
    .message { padding:.85rem 1rem; border-radius:.95rem; text-align:center; font-weight:950; margin-top:.75rem; }
    .message.success { background:#f0fdf4; color:#15803d; border:1px solid #bbf7d0; }
    .message.error { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .message.info { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
    .dashboard-tabs { display:flex; gap:1rem; margin-bottom:1.25rem; border-bottom:2px solid #e5e7eb; overflow-x:auto; }
    .tab-button { padding:0.75rem 1.25rem; font-size:1rem; background:none; border:none; cursor:pointer; color:#6b7280; border-bottom:2px solid transparent; margin-bottom:-2px; font-weight:950; white-space:nowrap; }
    .tab-button.active { color:#2563eb; border-bottom-color:#2563eb; }
    .admin-summary { display:grid; grid-template-columns:repeat(3, 1fr); gap:.75rem; margin:1rem 0; }
    .admin-summary-card { background:#fff; border:1px solid #e5e7eb; border-radius:.95rem; padding:1rem; }
    .admin-summary-value { font-size:1.6rem; font-weight:950; color:#111827; }
    .admin-summary-label { font-size:.875rem; color:#6b7280; font-weight:950; }
    .attendance-table { background:#fff; border-radius:.95rem; border:1px solid #e5e7eb; overflow-x: auto; }
    table { width:100%; border-collapse:collapse; }
    th { background:#f9fafb; padding:1rem; text-align:left; font-size:.95rem; font-weight:950; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
    td { padding:1rem; border-bottom:1px solid #e5e7eb; font-size:.95rem; vertical-align:middle; white-space:nowrap; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:999; }
    .modal { background:#fff; width:90%; max-width:400px; padding:1.5rem; border-radius:1rem; }
    .modal-actions { display:flex; gap:0.5rem; margin-top:1rem; }
    .modal-btn { flex:1; padding:0.8rem; border-radius:0.5rem; border:none; font-weight:bold; cursor:pointer; }
    .modal-btn.primary { background:#2563eb; color:#fff; }
  </style>
</head>

<body>
  <div id="homePage">
    <div class="header">
      <div class="header-content">
        <button type="button" class="admin-button" id="adminBtn">관리자</button>
        <h1>뉴웨이브 청년1부</h1>
        <p class="subtitle">출석 체크를 위해 사랑방을 선택해주세요</p>
      </div>
    </div>
    <div class="container">
      <div class="team-grid" id="teamGrid"></div>
    </div>
  </div>

  <div id="attendancePage" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="teamBackBtn">← 뒤로가기</button>
        <h1 id="selectedTeamName"></h1>
        <p class="subtitle" id="selectedTeamLeader"></p>
      </div>
    </div>
    <div class="container">
      <div class="date-section">
        <div class="date-label">날짜 선택</div>
        <div class="date-row">
          <input type="date" class="date-input" id="dateInput" />
          <button type="button" class="load-button" id="forceLoadBtn">불러오기</button>
        </div>
      </div>
      <div class="summary-box">
        <div class="summary-content">
          <span class="summary-title">출석률</span>
          <span class="summary-count" id="attendanceCount">0 / 0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      </div>
      <input id="memberSearch" class="search-input" placeholder="이름 검색..." />
      <div class="member-list" id="memberList"></div>
      <div class="suggestion-section" style="margin-bottom:1rem;">
        <div class="date-label">건의사항 (선택)</div>
        <textarea class="suggestion-textarea" id="suggestionInput" placeholder="건의사항을 입력하세요"></textarea>
      </div>
      <div class="sticky-actions">
        <button type="button" class="save-button" id="saveBtn">출석 정보 저장</button>
        <div id="messageBox" class="hidden"></div>
      </div>
    </div>
  </div>

  <div id="adminDashboard" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="adminBackBtn">← 홈으로</button>
        <h1>관리자 대시보드</h1>
      </div>
    </div>
    <div class="container">
      <div class="dashboard-tabs">
        <button class="tab-button active" data-tab="stats">출석 현황</button>
        <button class="tab-button" data-tab="notes">특이사항</button>
        <button class="tab-button" data-tab="suggestions">건의사항</button> 
        <button class="tab-button" data-tab="members">개인별 조회</button>
      </div>
      <div id="adminStatsTab">
        <div class="date-section"><input type="date" class="date-input" id="adminDateInput" /></div>
        <div class="admin-summary">
          <div class="admin-summary-card"><div class="admin-summary-label">출석</div><div class="admin-summary-value" id="adminTotalPresent">0</div></div>
          <div class="admin-summary-card"><div class="admin-summary-label">결석</div><div class="admin-summary-value" id="adminTotalAbsent">0</div></div>
          <div class="admin-summary-card"><div class="admin-summary-label">출석률</div><div class="admin-summary-value" id="adminTotalRate">0%</div></div>
        </div>
        <div class="attendance-table" id="attendanceTable"></div>
      </div>
      <div id="adminNotesTab" class="hidden"><div class="date-section"><input type="date" class="date-input" id="adminNotesDateInput" /></div><div id="notesTable"></div></div>
      <div id="adminSuggestionsTab" class="hidden"><div class="date-section"><input type="date" class="date-input" id="adminSuggestionsDateInput" /></div><div id="suggestionsTable"></div></div>
      <div id="adminMembersTab" class="hidden">
        <div class="date-section">
          <input type="date" id="memberStartDate" class="date-input" style="width:48%"/>
          <input type="date" id="memberEndDate" class="date-input" style="width:48%"/>
          <select id="memberSelect" class="date-input" style="margin-top:10px; width:100%"><option value="">선택</option></select>
        </div>
        <div id="memberResultArea" class="hidden">
          <div class="chart-card"><canvas id="memberChart"></canvas></div>
          <div id="memberHistoryTable" class="attendance-table" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 id="modalSubtitle">비밀번호 입력</h3>
      <input type="password" id="modalPassword" class="date-input" style="margin-top:10px; width:100%" />
      <div id="modalError" style="color:red; font-size:0.8rem; margin-top:5px;" class="hidden">불일치</div>
      <div class="modal-actions">
        <button class="modal-btn" id="modalCancelBtn">취소</button>
        <button class="modal-btn primary" id="modalOkBtn">확인</button>
      </div>
    </div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2W5blwbzQxlJVRe1uVTsgeYk3K9WBl0vQXzADfR_czxL6ztu9r-Liz3MVYGRR5Bi7UQ/exec";
    
    // [TEAMS 데이터 및 비밀번호 데이터 동일하게 유지]
    const TEAMS = [
      { id: 1, name: "권준형 사랑방", leader: "방장: 권준형", members: [{name:"권준형", cohort:"99"},{name:"김시아", cohort:"01"},{name:"김예준", cohort:"06"},{name:"김우주", cohort:"06"},{name:"김해성", cohort:"02"},{name:"맹성원", cohort:"06"},{name:"신재영", cohort:"00"},{name:"오세현", cohort:"01"},{name:"원찬희", cohort:"01"},{name:"윤리경", cohort:"00"},{name:"이민정", cohort:"00"},{name:"이예은", cohort:"00"},{name:"조에녹", cohort:"02"},{name:"차해온", cohort:"00"},{name:"최동하", cohort:"06"},{name:"최서연", cohort:"00"},{name:"황재준", cohort:"03"}] },
      { id: 2, name: "김나림 사랑방", leader: "방장: 김나림", members: [{name:"김나림", cohort:"03"},{name:"강규호", cohort:"06"},{name:"권세영", cohort:"04"},{name:"김새록", cohort:"01"},{name:"김시우", cohort:"01"},{name:"김예진", cohort:"06"},{name:"김유찬", cohort:"06"},{name:"김해민", cohort:"07"},{name:"박윤화", cohort:"07"},{name:"박종은", cohort:"04"},{name:"배수아", cohort:"04"},{name:"심이삭", cohort:"06"},{name:"이래준", cohort:"06"},{name:"이세원", cohort:"04"},{name:"이수현", cohort:"07"},{name:"이하희", cohort:"04"},{name:"이해민", cohort:"07"}] },
      { id: 3, name: "문유안 사랑방", leader: "방장: 문유안", members: [{name:"문유안", cohort:"03"},{name:"고동현", cohort:"06"},{name:"권승지", cohort:"05"},{name:"김도현", cohort:"07"},{name:"김예원", cohort:"05"},{name:"김유경", cohort:"05"},{name:"김하준", cohort:"06"},{name:"박승희", cohort:"03"},{name:"박지성", cohort:"07"},{name:"박혜진", cohort:"02"},{name:"연유나", cohort:"04"},{name:"이성민", cohort:"07"},{name:"이 수", cohort:"06"},{name:"이수빈", cohort:"04"},{name:"이희원", cohort:"05"},{name:"임아현", cohort:"06"},{name:"장혜준", cohort:"03"},{name:"정서연", cohort:"05"}] },
      { id: 4, name: "백에스더 사랑방", leader: "방장: 백에스더", members: [{name:"백에스더", cohort:"02"},{name:"강유나", cohort:"07"},{name:"김동은", cohort:"05"},{name:"마혜리", cohort:"04"},{name:"박서림", cohort:"05"},{name:"백민서", cohort:"05"},{name:"백승우", cohort:"05"},{name:"이동화", cohort:"03"},{name:"이민지", cohort:"04"},{name:"이성준", cohort:"05"},{name:"이서현b", cohort:"07"},{name:"이예진", cohort:"03"},{name:"오하늘", cohort:"04"},{name:"유지혜", cohort:"02"},{name:"장준환", cohort:"01"},{name:"장진우", cohort:"05"},{name:"장하나", cohort:"07"},{name:"천예빈", cohort:"04"},{name:"천유빈", cohort:"07"},{name:"최하은", cohort:"04"}] },
      { id: 5, name: "이예정 사랑방", leader: "방장: 이예정", members: [{name:"이예정", cohort:"98"},{name:"권채민", cohort:"05"},{name:"나예안", cohort:"04"},{name:"마현빈", cohort:"02"},{name:"박규리", cohort:"04"},{name:"박은경", cohort:"01"},{name:"박종운", cohort:"02"},{name:"박태희", cohort:"03"},{name:"양산얼", cohort:"99"},{name:"오성헌", cohort:"99"},{name:"이병헌", cohort:"99"},{name:"이영채", cohort:"06"},{name:"이창호", cohort:"01"},{name:"정다원", cohort:"02"},{name:"정여원", cohort:"05"},{name:"하성민", cohort:"99"}] },
      { id: 6, name: "이지빈 사랑방", leader: "방장: 이지빈", members: [{name:"이지빈", cohort:"03"},{name:"곽채율", cohort:"06"},{name:"권예은", cohort:"06"},{name:"김도영", cohort:"07"},{name:"김승원", cohort:"08"},{name:"김은찬", cohort:"05"},{name:"박수빈", cohort:"03"},{name:"신민규", cohort:"03"},{name:"쏘토", cohort:"03"},{name:"오준환", cohort:"06"},{name:"오지윤", cohort:"06"},{name:"이시헌", cohort:"07"},{name:"장동주", cohort:"05"},{name:"정예원", cohort:"06"},{name:"정하준", cohort:"07"},{name:"최수안", cohort:"06"},{name:"한다연", cohort:"04"},{name:"황윤수", cohort:"03"}] },
      { id: 7, name: "이하은 사랑방", leader: "방장: 이하은", members: [{name:"이하은", cohort:"05"},{name:"김병현", cohort:"04"},{name:"김보은", cohort:"02"},{name:"남하은", cohort:"05"},{name:"박민용", cohort:"01"},{name:"백한나", cohort:"04"},{name:"손상규", cohort:"04"},{name:"소윤아", cohort:"07"},{name:"원찬영", cohort:"02"},{name:"이동인", cohort:"06"},{name:"이민규", cohort:"03"},{name:"이서현a", cohort:"07"},{name:"이세린", cohort:"07"},{name:"장윤진", cohort:"04"},{name:"하지헌", cohort:"05"},{name:"한시현", cohort:"06"},{name:"허시온", cohort:"01"}] },
      { id: 8, name: "이희진 사랑방", leader: "방장: 이희진", members: [{name:"이희진", cohort:"00"},{name:"김시윤", cohort:"07"},{name:"김주아", cohort:"05"},{name:"김지상", cohort:"05"},{name:"노하형", cohort:"04"},{name:"박상호", cohort:"07"},{name:"선민영", cohort:"05"},{name:"심유나", cohort:"02"},{name:"신혜성", cohort:"06"},{name:"윤이안", cohort:"05"},{name:"이상경", cohort:"00"},{name:"이서륜", cohort:"05"},{name:"임평강", cohort:"00"},{name:"장윤성", cohort:"07"},{name:"장해윤", cohort:"02"},{name:"정예흔", cohort:"05"},{name:"정준", cohort:"05"},{name:"조나단", cohort:"06"},{name:"차윤미", cohort:"02"},{name:"천유찬", cohort:"07"},{name:"홍혜원", cohort:"05"}] },
      { id: 9, name: "임사랑 사랑방", leader: "방장: 임사랑", members: [{name:"임사랑", cohort:"01"},{name:"김은성", cohort:"02"},{name:"김제현", cohort:"05"},{name:"김종찬", cohort:"07"},{name:"류영서", cohort:"07"},{name:"박수예", cohort:"07"},{name:"배현아", cohort:"07"},{name:"신영은", cohort:"05"},{name:"안수지", cohort:"07"},{name:"안진주", cohort:"06"},{name:"윤서빈", cohort:"06"},{name:"윤준서", cohort:"03"},{name:"이상혁", cohort:"01"},{name:"이나림", cohort:"03"},{name:"이찬희", cohort:"06"},{name:"이하경", cohort:"02"},{name:"장수환", cohort:"03"},{name:"최가온", cohort:"05"}] },
      { id: 10, name: "장하늘 사랑방", leader: "방장: 장하늘", members: [{name:"장하늘", cohort:"00"},{name:"권준형", cohort:"07"},{name:"김수아a", cohort:"05"},{name:"김수아b", cohort:"05"},{name:"김아인", cohort:"07"},{name:"김은주b", cohort:"07"},{name:"김제민", cohort:"06"},{name:"박정민", cohort:"07"},{name:"박종화", cohort:"05"},{name:"박현진", cohort:"04"},{name:"송예준", cohort:"00"},{name:"송용석", cohort:"02"},{name:"이하준", cohort:"07"},{name:"이한열", cohort:"04"},{name:"이휘수", cohort:"00"},{name:"장석민", cohort:"00"},{name:"정예은a", cohort:"07"},{name:"조준서", cohort:"01"},{name:"최윤수", cohort:"99"}] },
      { id: 11, name: "하재영 사랑방", leader: "방장: 하재영", members: [{name:"하재영", cohort:"00"},{name:"권시훈", cohort:"03"},{name:"김시온", cohort:"03"},{name:"김유나", cohort:"02"},{name:"김은준", cohort:"00"},{name:"김주영", cohort:"07"},{name:"김해림", cohort:"07"},{name:"남훈", cohort:"06"},{name:"류영민", cohort:"02"},{name:"손영지", cohort:"07"},{name:"송가은", cohort:"07"},{name:"송승우", cohort:"05"},{name:"이정한", cohort:"02"},{name:"이한솔", cohort:"07"},{name:"임지민", cohort:"07"},{name:"장하서", cohort:"02"},{name:"조시영", cohort:"07"},{name:"황재윤", cohort:"01"}] },
      { id: 12, name: "Wee팀", leader: "방장: 권하경, 최수인", members: [{name:"권하경", cohort:"03"},{name:"최수인", cohort:"98"},{name:"고보민", cohort:"05"},{name:"김민지", cohort:"99"},{name:"오하진", cohort:"05"},{name:"유예희", cohort:"04"},{name:"유요한", cohort:"03"},{name:"장석범", cohort:"98"}] }
    ];

    const TEAM_PASSWORDS = { 1: "7053", 2: "2580", 3: "0726", 4: "1111", 5: "1218", 6: "4884", 7: "2005", 8: "8888", 9: "1015", 10: "9804", 11: "0831", 12: "1212" };
    const ADMIN_PASSWORD = "6789";

    let selectedTeam = null;
    let attendance = {}; 
    let memberNotes = {};
    let adminAuthed = false;
    let chartInstance = null;

    // 또래 번호 정규화 (예: '5' -> '05')
    function normalizeCohort(value) {
      let s = (value || "").toString().replace(/'/g, "").trim();
      if (/^\d$/.test(s)) s = "0" + s;
      return s;
    }

    function showPage(id) {
      ["homePage","attendancePage","adminDashboard"].forEach(p => document.getElementById(p).classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function showMsg(type, text) {
      const box = document.getElementById("messageBox");
      box.className = "message " + type;
      box.textContent = text;
      box.classList.remove("hidden");
      setTimeout(() => box.classList.add("hidden"), 3000);
    }

    // GET 요청용 (불러오기)
    function jsonp(url, params) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + Math.floor(Math.random()*1000);
        params.callback = cb;
        const query = Object.keys(params).map(k => encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join("&");
        const script = document.createElement("script");
        script.src = url + "?" + query;
        window[cb] = (data) => { delete window[cb]; document.body.removeChild(script); resolve(data); };
        script.onerror = () => { delete window[cb]; if(script.parentNode) document.body.removeChild(script); reject("Network Error"); };
        document.body.appendChild(script);
      });
    }

    // 초기화
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("dateInput").value = today;
    initTeamGrid();

    function initTeamGrid() {
      const grid = document.getElementById("teamGrid");
      TEAMS.forEach(t => {
        const card = document.createElement("div");
        card.className = "team-card";
        card.innerHTML = `
          <div class="team-card-header"><div class="team-number">${t.id}</div><div class="member-count">${t.members.length}명</div></div>
          <div class="team-name">${t.name}</div><div class="team-leader">${t.leader}</div>
        `;
        card.onclick = () => openPasswordModal("team", t);
        grid.appendChild(card);
      });
    }

    const modalState = { type: null, data: null };
    function openPasswordModal(type, data) {
      modalState.type = type; modalState.data = data;
      document.getElementById("passwordModal").classList.remove("hidden");
      document.getElementById("modalPassword").value = "";
      document.getElementById("modalError").classList.add("hidden");
      document.getElementById("modalSubtitle").textContent = type === "admin" ? "관리자 접속" : data.name;
      document.getElementById("modalPassword").focus();
    }

    document.getElementById("modalCancelBtn").onclick = () => document.getElementById("passwordModal").classList.add("hidden");
    document.getElementById("modalOkBtn").onclick = checkPassword;
    document.getElementById("modalPassword").onkeydown = (e) => { if(e.key==="Enter") checkPassword(); };

    function checkPassword() {
      const input = document.getElementById("modalPassword").value;
      const err = document.getElementById("modalError");
      if (modalState.type === "admin") {
        if (input === ADMIN_PASSWORD) { adminAuthed = true; document.getElementById("passwordModal").classList.add("hidden"); showAdminDashboard(); }
        else { err.classList.remove("hidden"); }
      } else {
        if (input === TEAM_PASSWORDS[modalState.data.id]) { document.getElementById("passwordModal").classList.add("hidden"); loadTeamPage(modalState.data); }
        else { err.classList.remove("hidden"); }
      }
    }

    function loadTeamPage(team) {
      selectedTeam = team;
      document.getElementById("selectedTeamName").textContent = team.name;
      document.getElementById("selectedTeamLeader").textContent = team.leader;
      showPage("attendancePage");
      
      attendance = {}; memberNotes = {};
      const list = document.getElementById("memberList");
      list.innerHTML = "";
      
      team.members.forEach(m => {
        const name = m.name.trim();
        const cohort = normalizeCohort(m.cohort);
        const key = name + "||" + cohort;
        
        attendance[key] = false;
        const el = document.createElement("div");
        el.className = "member-item";
        el.dataset.key = key;
        el.innerHTML = `
          <div class="member-header">
            <div><div class="member-name">${name}</div><div class="member-meta">${cohort} 또래</div></div>
            <div class="checkbox"><span class="checkmark">✓</span></div>
          </div>
          <div class="note-section"><input class="note-input" placeholder="특이사항" oninput="saveNote('${key}', this.value)" onclick="event.stopPropagation()"></div>
        `;
        el.onclick = (e) => {
          if (e.target.tagName === "INPUT") return;
          attendance[key] = !attendance[key];
          el.classList.toggle("checked", attendance[key]);
          updateUI();
        };
        list.appendChild(el);
      });
      loadServerAttendance();
    }

    function saveNote(key, val) { memberNotes[key] = val; }
    
    function updateUI() {
      const total = Object.keys(attendance).length;
      const present = Object.values(attendance).filter(Boolean).length;
      document.getElementById("attendanceCount").textContent = `${present} / ${total}`;
      document.getElementById("progressFill").style.width = total ? (present/total*100)+"%" : "0%";
    }

    // ✅ 서버 데이터 불러오기 및 UI 완벽 복원 로직
    async function loadServerAttendance() {
      showMsg("info", "데이터 불러오는 중...");
      try {
        const res = await jsonp(GOOGLE_SCRIPT_URL, { 
          action: "loadAttendance", teamId: selectedTeam.id, date: document.getElementById("dateInput").value 
        });
        
        // 1. 초기화
        const items = document.querySelectorAll(".member-item");
        items.forEach(el => {
          const key = el.dataset.key;
          attendance[key] = false;
          el.classList.remove("checked");
          el.querySelector(".note-input").value = "";
          memberNotes[key] = "";
        });
        document.getElementById("suggestionInput").value = "";

        // 2. 서버 데이터 매칭 및 복원
        if (res.status === "success" && res.data.found) {
          res.data.attendance.forEach(r => {
            const serverName = r.name.trim();
            const serverCohort = normalizeCohort(r.cohort);
            const key = serverName + "||" + serverCohort;
            
            if (attendance.hasOwnProperty(key)) {
              attendance[key] = r.isPresent;
              memberNotes[key] = r.note || "";
              const el = document.querySelector(`.member-item[data-key="${key.replace(/([ #;?%&,.+*~\':"!^$[\]()=>|/@])/g,'\\$1')}"]`);
              if (el) {
                if (r.isPresent) el.classList.add("checked");
                el.querySelector(".note-input").value = r.note || "";
              }
            }
          });
          document.getElementById("suggestionInput").value = res.data.suggestion || "";
          showMsg("success", "이전 데이터를 불러왔습니다.");
        } else {
          showMsg("info", "새로운 출석체크를 시작합니다.");
        }
        updateUI();
      } catch(e) { console.error(e); showMsg("error", "데이터 로드 실패"); }
    }

    // ✅ POST 방식 저장 로직 (데이터 길이 무관)
    document.getElementById("saveBtn").onclick = async () => {
       const btn = document.getElementById("saveBtn");
       btn.textContent = "저장 중..."; btn.disabled = true;
       
       const list = [];
       for(let key in attendance) {
         const [name, cohort] = key.split("||");
         list.push({ name, cohort, isPresent: attendance[key], note: memberNotes[key] || "" });
       }
       
       const payload = {
         action: "saveAttendance",
         teamId: selectedTeam.id,
         teamName: selectedTeam.name,
         leader: selectedTeam.leader,
         date: document.getElementById("dateInput").value,
         suggestion: document.getElementById("suggestionInput").value,
         attendance: list
       };

       try {
         await fetch(GOOGLE_SCRIPT_URL, {
           method: "POST",
           mode: "no-cors",
           cache: "no-cache",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify(payload)
         });
         showMsg("success", "저장 성공");
       } catch(e) { 
         showMsg("error", "저장 실패"); 
       } finally { 
         btn.textContent = "출석 정보 저장"; 
         btn.disabled = false; 
       }
    };

    document.getElementById("teamBackBtn").onclick = () => showPage("homePage");
    document.getElementById("dateInput").onchange = loadServerAttendance;
    document.getElementById("forceLoadBtn").onclick = loadServerAttendance;
    
    document.getElementById("memberSearch").oninput = (e) => {
      const val = e.target.value.toLowerCase();
      document.querySelectorAll(".member-item").forEach(el => el.style.display = el.dataset.key.toLowerCase().includes(val) ? "" : "none");
    };

    // [기타 관리자 기능 스크립트 생략 - 이전과 동일하게 유지]
    document.getElementById("adminBtn").onclick = () => { adminAuthed ? showAdminDashboard() : openPasswordModal("admin"); };
    document.getElementById("adminBackBtn").onclick = () => { adminAuthed = false; showPage("homePage"); };
    function showAdminDashboard() { showPage("adminDashboard"); }
  </script>
</body>
</html>
