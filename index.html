<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>뉴웨이브 청년1부 사랑방 출석체크</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#f9fafb; min-height:100vh; }
    .hidden { display:none !important; }

    .header { background:#fff; border-bottom:1px solid #e5e7eb; padding:1.25rem 1rem; position:sticky; top:0; z-index:100; }
    .header-content { max-width:1200px; margin:0 auto; position:relative; }
    h1 { font-size:1.5rem; color:#111827; }
    .subtitle { color:#6b7280; font-size:0.9rem; font-weight:800; margin-top:0.35rem; }
    .admin-button { position:absolute; top:0; right:0; background:#6b7280; color:#fff; padding:0.5rem 1rem; border-radius:0.85rem; border:none; cursor:pointer; font-size:0.875rem; font-weight:900; }

    .container { max-width:1200px; margin:0 auto; padding:1.5rem 1rem; }

    .team-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1rem; }
    .team-card { background:#fff; padding:1.5rem; border-radius:0.95rem; border:2px solid #e5e7eb; cursor:pointer; transition:all .2s; }
    .team-card:hover { border-color:#2563eb; box-shadow:0 10px 15px -3px rgba(0,0,0,.1); }
    .team-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; }
    .team-number { width:2.5rem; height:2.5rem; background:#dbeafe; border-radius:0.9rem; display:flex; align-items:center; justify-content:center; color:#2563eb; font-weight:950; font-size:1rem; }
    .team-name { font-size:1.65rem; font-weight:950; color:#111827; margin-bottom:.25rem; }
    .team-leader { font-size:.9rem; color:#6b7280; font-weight:800; }
    .member-count { background:#f3f4f6; padding:.25rem .75rem; border-radius:9999px; font-size:.875rem; color:#6b7280; font-weight:900; }

    .back-button { display:flex; align-items:center; gap:.5rem; color:#6b7280; background:none; border:none; cursor:pointer; font-size:1rem; padding:.5rem .25rem; font-weight:900; }

    .date-section { background:#fff; padding:1rem; border-radius:.95rem; border:1px solid #e5e7eb; margin-bottom:1rem; }
    .date-label { font-size:.875rem; font-weight:950; color:#374151; margin-bottom:.5rem; }
    .date-row { display:flex; gap:.5rem; }
    .date-input { flex:1; padding:.75rem 1rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; background:#fff; outline:none; }
    .load-button { background:#4b5563; color:white; border:none; padding:0 1.2rem; border-radius:.9rem; font-weight:900; cursor:pointer; }

    .summary-box { background:#eff6ff; padding:1rem; border-radius:.95rem; border:1px solid #bfdbfe; margin-bottom:1rem; }
    .summary-content { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .summary-title { font-weight:950; color:#111827; }
    .summary-count { font-size:1.5rem; font-weight:950; color:#2563eb; }
    .progress-bar { background:#e5e7eb; border-radius:9999px; height:.5rem; overflow:hidden; }
    .progress-fill { background:#2563eb; height:100%; transition:width .3s; }

    .search-input { width:100%; padding:.65rem .9rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; margin-bottom:1rem; }

    .member-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); gap:.75rem; margin-bottom:1rem; }
    .member-item { background:#fff; padding:.9rem; border-radius:.95rem; border:2px solid #e5e7eb; transition:all .2s; cursor:pointer; }
    .member-item.checked { background:#eff6ff; border-color:#2563eb; }
    .member-header { display:flex; justify-content:space-between; align-items:flex-start; gap:.5rem; }
    .member-name { font-size:1rem; font-weight:950; color:#374151; }
    .member-meta { margin-top:.2rem; font-size:.85rem; font-weight:900; color:#6b7280; }
    .checkbox { width:1.75rem; height:1.75rem; border-radius:9999px; border:2px solid #d1d5db; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:.1rem; }
    .member-item.checked .checkbox { background:#2563eb; border-color:#2563eb; }
    .checkmark { display:none; color:#fff; font-weight:950; font-size:.95rem; }
    .member-item.checked .checkmark { display:block; }
    .note-input { width:100%; padding:.55rem .65rem; border:1px solid #d1d5db; border-radius:.85rem; font-size:14px; margin-top:0.75rem; }
    .suggestion-textarea { width:100%; padding:.75rem; border:1px solid #d1d5db; border-radius:.9rem; font-size:16px; min-height:90px; }

    .save-button { width:100%; background:#2563eb; color:#fff; padding:.95rem; border-radius:.95rem; border:none; font-size:1.05rem; font-weight:950; cursor:pointer; }
    .message { padding:.85rem 1rem; border-radius:.95rem; text-align:center; font-weight:950; margin-top:.75rem; }
    .message.success { background:#f0fdf4; color:#15803d; border:1px solid #bbf7d0; }
    .message.error { background:#fef2f2; color:#b91c1c; border:1px solid #fecaca; }
    .message.info { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }

    /* 관리자 전용 스타일 */
    .dashboard-tabs { display:flex; gap:0.5rem; margin-bottom:1.25rem; border-bottom:2px solid #e5e7eb; overflow-x:auto; }
    .tab-button { padding:0.75rem 1.25rem; font-size:1rem; background:none; border:none; cursor:pointer; color:#6b7280; border-bottom:2px solid transparent; margin-bottom:-2px; font-weight:950; white-space:nowrap; }
    .tab-button.active { color:#2563eb; border-bottom-color:#2563eb; }

    .attendance-table-container { background:#fff; border-radius:.95rem; border:1px solid #e5e7eb; overflow:hidden; }
    .attendance-table { width:100%; border-collapse:collapse; }
    .attendance-table th { background:#f9fafb; padding:1rem; text-align:left; font-size:.95rem; font-weight:950; border-bottom:1px solid #e5e7eb; }
    .attendance-table td { padding:1rem; border-bottom:1px solid #e5e7eb; font-size:.95rem; vertical-align:middle; }

    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 900; }
    .status-submitted { background: #dcfce7; color: #166534; }
    .status-pending { background: #fee2e2; color: #991b1b; }

    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:999; }
    .modal { background:#fff; width:90%; max-width:400px; padding:1.5rem; border-radius:1rem; }
    .modal-actions { display:flex; gap:0.5rem; margin-top:1rem; }
    .modal-btn { flex:1; padding:0.8rem; border-radius:0.5rem; border:none; font-weight:bold; cursor:pointer; }
    .modal-btn.primary { background:#2563eb; color:#fff; }
  </style>
</head>
<body>

  <div id="homePage">
    <div class="header">
      <div class="header-content">
        <button type="button" class="admin-button" id="adminBtn">관리자</button>
        <h1>뉴웨이브 청년1부</h1>
        <p class="subtitle">출석 체크를 위해 사랑방을 선택해주세요</p>
      </div>
    </div>
    <div class="container"><div class="team-grid" id="teamGrid"></div></div>
  </div>

  <div id="attendancePage" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="teamBackBtn">← 뒤로가기</button>
        <h1 id="selectedTeamName"></h1>
        <p class="subtitle" id="selectedTeamLeader"></p>
      </div>
    </div>
    <div class="container">
      <div class="date-section">
        <div class="date-label">날짜 선택</div>
        <div class="date-row">
          <input type="date" class="date-input" id="dateInput" />
          <button type="button" class="load-button" id="forceLoadBtn">불러오기</button>
        </div>
      </div>
      <div class="summary-box">
        <div class="summary-content"><span class="summary-title">오늘의 출석 인원</span><span class="summary-count" id="attendanceCount">0 / 0</span></div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      </div>
      <input id="memberSearch" class="search-input" placeholder="이름으로 검색..." />
      <div class="member-list" id="memberList"></div>
      <div style="margin-bottom:1rem;">
        <div class="date-label">건의사항 및 기타 (선택사항)</div>
        <textarea class="suggestion-textarea" id="suggestionInput" placeholder="공동체에 전달하고 싶은 내용을 입력하세요"></textarea>
      </div>
      <div style="position:sticky; bottom:1rem; background: #f9fafb; padding-top: 10px;">
        <button type="button" class="save-button" id="saveBtn">출석 정보 저장하기</button>
        <div id="messageBox" class="hidden"></div>
      </div>
    </div>
  </div>

  <div id="adminDashboard" class="hidden">
    <div class="header">
      <div class="header-content">
        <button type="button" class="back-button" id="adminBackBtn">← 홈으로</button>
        <h1>관리자 대시보드</h1>
      </div>
    </div>
    <div class="container">
      <div class="dashboard-tabs">
        <button class="tab-button active" data-tab="stats">출석 현황</button>
        <button class="tab-button" data-tab="notes">특이사항</button>
        <button class="tab-button" data-tab="suggestions">건의사항</button> 
        <button class="tab-button" data-tab="members">개인별 조회</button>
      </div>
      <div id="adminStatsTab">
        <div class="date-section"><input type="date" class="date-input" id="adminDateInput" /></div>
        <div class="attendance-table-container" id="attendanceTable"></div>
      </div>
      <div id="adminNotesTab" class="hidden">
        <div class="date-section"><input type="date" class="date-input" id="adminNotesDateInput" /></div>
        <div class="attendance-table-container" id="notesTable"></div>
      </div>
      <div id="adminSuggestionsTab" class="hidden">
        <div class="date-section"><input type="date" class="date-input" id="adminSuggestionsDateInput" /></div>
        <div class="attendance-table-container" id="suggestionsTable"></div>
      </div>
      <div id="adminMembersTab" class="hidden">
        <div class="date-section">
          <div class="date-label">조회 기간</div>
          <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="date" id="memberStartDate" class="date-input" /><input type="date" id="memberEndDate" class="date-input" /></div>
          <select id="memberSelect" class="date-input" style="width:100%"><option value="">방원 선택</option></select>
          <button id="saveToSheetBtn" class="load-button" style="width:100%; margin-top:10px; height:45px;">통계 구글 시트로 저장</button>
        </div>
        <div id="memberResultArea" class="hidden">
          <div style="background:white; padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid #e5e7eb;"><canvas id="memberChart" style="max-height:220px; width:100%;"></canvas></div>
          <div id="memberHistoryTable" class="attendance-table-container"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 id="modalSubtitle">비밀번호 입력</h3>
      <input type="password" id="modalPassword" class="date-input" style="margin-top:10px; width:100%" />
      <div id="modalError" style="color:red; font-size:0.8rem; margin-top:5px;" class="hidden">비밀번호가 틀렸습니다.</div>
      <div class="modal-actions"><button class="modal-btn" id="modalCancelBtn">취소</button><button class="modal-btn primary" id="modalOkBtn">확인</button></div>
    </div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzAVZkfYIhgTLmxdt-iKf5VBfu6AsfpsYKxXe2tiNbItKD7SFDc7dsm07w8z_JtuWteTg/exec";
    const ADMIN_PASSWORD = "6789"; //관리자 비밀번호
    
    const TEAMS = [
  {
    id: 1,
    name: "권준형 사랑방",
    leader: "방장: 권준형",
    members: [
      { name: "권준형", cohort: "99" },
      { name: "김시아", cohort: "01" },
      { name: "김예준", cohort: "06" },
      { name: "김우주", cohort: "06" },
      { name: "김해성", cohort: "02" },
      { name: "맹성원", cohort: "06" },
      { name: "신재영", cohort: "00" },
      { name: "오세현", cohort: "01" },
      { name: "원찬희", cohort: "01" },
      { name: "윤리경", cohort: "00" },
      { name: "이민정", cohort: "00" },
      { name: "이예은", cohort: "00" },
      { name: "조에녹", cohort: "02" },
      { name: "차해온", cohort: "00" },
      { name: "최동하", cohort: "06" },
      { name: "최서연", cohort: "00" },
      { name: "황재준", cohort: "03" },
    ],
  },
  {
    id: 2,
    name: "김나림 사랑방",
    leader: "방장: 김나림",
    members: [
      { name: "김나림", cohort: "03" },
      { name: "강규호", cohort: "06" },
      { name: "권세영", cohort: "04" },
      { name: "김새록", cohort: "01" },
      { name: "김시우", cohort: "01" },
      { name: "김예진", cohort: "06" },
      { name: "김유찬", cohort: "06" },
      { name: "김해민", cohort: "07" },
      { name: "박윤화", cohort: "07" },
      { name: "박종은", cohort: "04" },
      { name: "배수아", cohort: "04" },
      { name: "심이삭", cohort: "06" },
      { name: "이래준", cohort: "06" },
      { name: "이세원", cohort: "04" },
      { name: "이수현", cohort: "07" },
      { name: "이하희", cohort: "04" },
      { name: "이해민", cohort: "07" },
    ],
  },
  {
    id: 3,
    name: "문유안 사랑방",
    leader: "방장: 문유안",
    members: [
      { name: "문유안", cohort: "03" },
      { name: "고동현", cohort: "06" },
      { name: "권승지", cohort: "05" },
      { name: "김도현", cohort: "07" },
      { name: "김예원", cohort: "05" },
      { name: "김유경", cohort: "05" },
      { name: "김하준", cohort: "06" },
      { name: "박승희", cohort: "03" },
      { name: "박지성", cohort: "07" },
      { name: "박혜진", cohort: "02" },
      { name: "연유나", cohort: "04" },
      { name: "이성민", cohort: "07" },
      { name: "이 수", cohort: "06" },
      { name: "이수빈", cohort: "04" },
      { name: "이희원", cohort: "05" },
      { name: "임아현", cohort: "06" },
      { name: "장혜준", cohort: "03" },
      { name: "정서연", cohort: "05" },
    ],
  },
  {
    id: 4,
    name: "백에스더 사랑방",
    leader: "방장: 백에스더",
    members: [
      { name: "백에스더", cohort: "02" },
      { name: "강유나", cohort: "07" },
      { name: "김동은", cohort: "05" },
      { name: "마혜리", cohort: "04" },
      { name: "박서림", cohort: "05" },
      { name: "백민서", cohort: "05" },
      { name: "백승우", cohort: "05" },
      { name: "이동화", cohort: "03" },
      { name: "이민지", cohort: "04" },
      { name: "이성준", cohort: "05" },
      { name: "이서현b", cohort: "07" },
      { name: "이예진", cohort: "03" },
      { name: "오하늘", cohort: "04" },
      { name: "유지혜", cohort: "02" },
      { name: "장준환", cohort: "01" },
      { name: "장진우", cohort: "05" },
      { name: "장하나", cohort: "07" },
      { name: "천예빈", cohort: "04" },
      { name: "천유빈", cohort: "07" },
      { name: "최하은", cohort: "04" },
    ],
  },
  {
    id: 5,
    name: "이예정 사랑방",
    leader: "방장: 이예정",
    members: [
      { name: "이예정", cohort: "98" },
      { name: "권채민", cohort: "05" },
      { name: "나예안", cohort: "04" },
      { name: "마현빈", cohort: "02" },
      { name: "박규리", cohort: "04" },
      { name: "박은경", cohort: "01" },
      { name: "박종운", cohort: "02" },
      { name: "박태희", cohort: "03" },
      { name: "양산얼", cohort: "99" },
      { name: "오성헌", cohort: "99" },
      { name: "이병헌", cohort: "99" },
      { name: "이영채", cohort: "06" },
      { name: "이창호", cohort: "01" },
      { name: "정다원", cohort: "02" },
      { name: "정여원", cohort: "05" },
      { name: "하성민", cohort: "99" },
    ],
  },
  {
    id: 6,
    name: "이지빈 사랑방",
    leader: "방장: 이지빈",
    members: [
      { name: "이지빈", cohort: "03" },
      { name: "곽채율", cohort: "06" },
      { name: "권예은", cohort: "06" },
      { name: "김도영", cohort: "07" },
      { name: "김승원", cohort: "08" },
      { name: "김은찬", cohort: "05" },
      { name: "박수빈", cohort: "03" },
      { name: "신민규", cohort: "03" },
      { name: "쏘토", cohort: "03" },
      { name: "오준환", cohort: "06" },
      { name: "오지윤", cohort: "06" },
      { name: "이시헌", cohort: "07" },
      { name: "장동주", cohort: "05" },
      { name: "정예원", cohort: "06" },
      { name: "정하준", cohort: "07" },
      { name: "최수안", cohort: "06" },
      { name: "한다연", cohort: "04" },
      { name: "황윤수", cohort: "03" }
    ]
  },
  {
    id: 7,
    name: "이하은 사랑방",
    leader: "방장: 이하은",
    members: [
      { name: "이하은", cohort: "05" },
      { name: "김병현", cohort: "04" },
      { name: "김보은", cohort: "02" },
      { name: "남하은", cohort: "05" },
      { name: "박민용", cohort: "01" },
      { name: "백한나", cohort: "04" },
      { name: "손상규", cohort: "04" },
      { name: "소윤아", cohort: "07" },
      { name: "원찬영", cohort: "02" },
      { name: "이동인", cohort: "06" },
      { name: "이민규", cohort: "03" },
      { name: "이서현a", cohort: "07" },
      { name: "이세린", cohort: "07" },
      { name: "장윤진", cohort: "04" },
      { name: "하지헌", cohort: "05" },
      { name: "한시현", cohort: "06" },
      { name: "허시온", cohort: "01" }
    ]
  },
  {
    id: 8,
    name: "이희진 사랑방",
    leader: "방장: 이희진",
    members: [
      { name: "이희진", cohort: "00" },
      { name: "김시윤", cohort: "07" },
      { name: "김주아", cohort: "05" },
      { name: "김지상", cohort: "05" },
      { name: "노하형", cohort: "04" },
      { name: "박상호", cohort: "07" },
      { name: "선민영", cohort: "05" },
      { name: "심유나", cohort: "02" },
      { name: "신혜성", cohort: "06" },
      { name: "윤이안", cohort: "05" },
      { name: "이상경", cohort: "00" },
      { name: "이서륜", cohort: "05" },
      { name: "임평강", cohort: "00" },
      { name: "장윤성", cohort: "07" },
      { name: "장해윤", cohort: "02" },
      { name: "정예흔", cohort: "05" },
      { name: "정준", cohort: "05" },
      { name: "조나단", cohort: "06" },
      { name: "차윤미", cohort: "02" },
      { name: "천유찬", cohort: "07" },
      { name: "홍혜원", cohort: "05" }
    ]
  },
  {
    id: 9,
    name: "임사랑 사랑방",
    leader: "방장: 임사랑",
    members: [
      { name: "임사랑", cohort: "01" },
      { name: "김은성", cohort: "02" },
      { name: "김제현", cohort: "05" },
      { name: "김종찬", cohort: "07" },
      { name: "류영서", cohort: "07" },
      { name: "박수예", cohort: "07" },
      { name: "배현아", cohort: "07" },
      { name: "신영은", cohort: "05" },
      { name: "안수지", cohort: "07" },
      { name: "안진주", cohort: "06" },
      { name: "윤서빈", cohort: "06" },
      { name: "윤준서", cohort: "03" },
      { name: "이상혁", cohort: "01" },
      { name: "이나림", cohort: "03" },
      { name: "이찬희", cohort: "06" },
      { name: "이하경", cohort: "02" },
      { name: "장수환", cohort: "03" },
      { name: "최가온", cohort: "05" }
    ]
  },
  {
    id: 10,
    name: "장하늘 사랑방",
    leader: "방장: 장하늘",
    members: [
      { name: "장하늘", cohort: "00" },
      { name: "권준형", cohort: "07" },
      { name: "김수아a", cohort: "05" },
      { name: "김수아b", cohort: "05" },
      { name: "김아인", cohort: "07" },
      { name: "김은주b", cohort: "07" },
      { name: "김제민", cohort: "06" },
      { name: "박정민", cohort: "07" },
      { name: "박종화", cohort: "05" },
      { name: "박현진", cohort: "04" },
      { name: "송예준", cohort: "00" },
      { name: "송용석", cohort: "02" },
      { name: "이하준", cohort: "07" },
      { name: "이한열", cohort: "04" },
      { name: "이휘수", cohort: "00" },
      { name: "장석민", cohort: "00" },
      { name: "정예은a", cohort: "07" },
      { name: "조준서", cohort: "01" },
      { name: "최윤수", cohort: "99" }
    ]
  },
  {
    id: 11,
    name: "하재영 사랑방",
    leader: "방장: 하재영",
    members: [
      { name: "하재영", cohort: "00" },
      { name: "권시훈", cohort: "03" },
      { name: "김시온", cohort: "03" },
      { name: "김유나", cohort: "02" },
      { name: "김은준", cohort: "00" },
      { name: "김주영", cohort: "07" },
      { name: "김해림", cohort: "07" },
      { name: "남훈", cohort: "06" },
      { name: "류영민", cohort: "02" },
      { name: "손영지", cohort: "07" },
      { name: "송가은", cohort: "07" },
      { name: "송승우", cohort: "05" },
      { name: "이정한", cohort: "02" },
      { name: "이한솔", cohort: "07" },
      { name: "임지민", cohort: "07" },
      { name: "장하서", cohort: "02" },
      { name: "조시영", cohort: "07" },
      { name: "황재윤", cohort: "01" }
    ]
  },
  {
    id: 12,
    name: "Wee팀",
    leader: "방장: 권하경, 최수인",
    members: [
      { name: "권하경", cohort: "03" },
      { name: "최수인", cohort: "98" },
      { name: "고보민", cohort: "05" },
      { name: "김민지", cohort: "99" },
      { name: "오하진", cohort: "05" },
      { name: "유예희", cohort: "04" },
      { name: "유요한", cohort: "03" },
      { name: "장석범", cohort: "98" }
    ]
  }
];

    const TEAM_PASSWORDS = { 1: "7053", 2: "2580", 3: "0726", 4: "1111", 5: "1218", 6: "4884", 7: "2005", 8: "8888", 9: "1015", 10: "9804", 11: "0831", 12: "1212" };

    let selectedTeam = null;
    let attendance = {};
    let memberNotes = {};
    let adminAuthed = false;
    let chartInstance = null;

    // ✅ 또래 정규화 (한 자리 숫자는 자동으로 0을 붙임)
    function normalizeCohort(value) {
        let cohortStr = (value || "").toString().trim();
        cohortStr = cohortStr.replace(/'/g, ""); // 따옴표 제거
        
        // 한 자리 숫자(0~9)인 경우 앞에 0을 붙여 00~09로 정규화
        if (/^\d$/.test(cohortStr)) {
            return '0' + cohortStr;
        }
        return cohortStr;
    }

    function showPage(id) {
      ["homePage","attendancePage","adminDashboard"].forEach(p => document.getElementById(p).classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function showMsg(type, text) {
      const box = document.getElementById("messageBox");
      box.className = "message " + type;
      box.textContent = text;
      box.classList.remove("hidden");
      setTimeout(() => box.classList.add("hidden"), 2500);
    }

    function jsonp(url, params) {
      return new Promise((resolve, reject) => {
        const callbackName = "cb_" + Date.now() + Math.floor(Math.random()*1000);
        params.callback = callbackName;
        const query = Object.keys(params).map(k => encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join("&");
        const script = document.createElement("script");
        script.src = url + "?" + query;
        window[callbackName] = (data) => {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        script.onerror = () => {
          delete window[callbackName];
          if (script.parentNode) document.body.removeChild(script);
          reject(new Error("Request Failed"));
        };
        document.body.appendChild(script);
      });
    }

    // 홈 - 팀 카드 렌더
    document.getElementById("dateInput").value = new Date().toISOString().split("T")[0];
    const teamGrid = document.getElementById("teamGrid");
    TEAMS.forEach(team => {
      const card = document.createElement("div");
      card.className = "team-card";
      card.innerHTML = `
        <div class="team-card-header">
          <div class="team-number">${team.id}</div>
          <div class="member-count">${team.members.length}명</div>
        </div>
        <div class="team-name">${team.name}</div>
        <div class="team-leader">${team.leader}</div>
      `;
      card.onclick = () => openPasswordModal("team", team);
      teamGrid.appendChild(card);
    });

    // 비밀번호 모달
    const modalState = { type:null, data:null };
    function openPasswordModal(type, data) {
      modalState.type = type;
      modalState.data = data || null;
      document.getElementById("passwordModal").classList.remove("hidden");
      document.getElementById("modalPassword").value = "";
      document.getElementById("modalError").classList.add("hidden");
      document.getElementById("modalSubtitle").textContent = type === "admin" ? "관리자 대시보드" : data.name;
      document.getElementById("modalPassword").focus();
    }
    document.getElementById("modalCancelBtn").onclick = () => document.getElementById("passwordModal").classList.add("hidden");
    document.getElementById("modalOkBtn").onclick = checkPassword;
    document.getElementById("modalPassword").onkeydown = (e) => { if(e.key==="Enter") checkPassword(); };

    function checkPassword() {
      const input = document.getElementById("modalPassword").value;
      if(modalState.type === "admin") {
        if(input === ADMIN_PASSWORD) {
          adminAuthed = true;
          document.getElementById("passwordModal").classList.add("hidden");
          showAdminDashboard();
        } else {
          document.getElementById("modalError").classList.remove("hidden");
        }
      } else {
        const team = modalState.data;
        if(input === TEAM_PASSWORDS[team.id]) {
          document.getElementById("passwordModal").classList.add("hidden");
          loadTeamPage(team);
        } else {
          document.getElementById("modalError").classList.remove("hidden");
        }
      }
    }

    // 팀 페이지 로드
    function loadTeamPage(team) {
      selectedTeam = team;
      attendance = {};
      memberNotes = {};

      document.getElementById("selectedTeamName").textContent = team.name;
      document.getElementById("selectedTeamLeader").textContent = team.leader;

      const list = document.getElementById("memberList");
      list.innerHTML = "";

      team.members.forEach(m => {
        const name = (m.name || "").toString().trim(); 
        const cohort = normalizeCohort(m.cohort); 
        const key = name + "||" + cohort; 
        
        attendance[key] = false;
        const el = document.createElement("div");
        el.className = "member-item";
        el.dataset.key = key;
        el.innerHTML = `
          <div class="member-header">
            <div>
              <div class="member-name">${m.name}</div>
              <div class="member-meta">${m.cohort} 또래</div>
            </div>
            <div class="checkbox"><span class="checkmark">✓</span></div>
          </div>
          <input type="text" class="note-input" placeholder="특이사항 입력" onclick="event.stopPropagation()">
        `;
        el.onclick = (e) => {
          if(e.target.tagName === "INPUT") return;
          attendance[key] = !attendance[key];
          el.classList.toggle("checked", attendance[key]);
          updateUI();
        };
        el.querySelector(".note-input").oninput = (e) => memberNotes[key] = e.target.value;
        list.appendChild(el);
      });

      showPage("attendancePage");
      updateUI();
      loadServerAttendance();
    }

    function updateUI() {
      const total = Object.keys(attendance).length;
      const present = Object.values(attendance).filter(v => v === true).length;
      document.getElementById("attendanceCount").textContent = `${present} / ${total}`;
      document.getElementById("progressFill").style.width = total > 0 ? (present/total*100)+"%" : "0%";
    }

    async function loadServerAttendance() {
      showMsg("info", "데이터 불러오는 중...");
      try {
        const res = await jsonp(GOOGLE_SCRIPT_URL, { 
          action: "loadAttendance", teamId: selectedTeam.id, date: document.getElementById("dateInput").value 
        });
        
        const items = document.querySelectorAll(".member-item");
        items.forEach(el => { 
            attendance[el.dataset.key] = false;
            memberNotes[el.dataset.key] = "";
            el.classList.remove("checked"); 
            const noteInput = el.querySelector(".note-input");
            if (noteInput) noteInput.value = ""; 
        });
        
        if (res.status === "success" && res.data.found) {
          res.data.attendance.forEach(r => {
            const nameFromServer = (r.name || "").toString().trim();
            const cohortFromServer = normalizeCohort(r.cohort); 
            const key = nameFromServer + "||" + cohortFromServer; 
            
            if (attendance.hasOwnProperty(key)) { 
               attendance[key] = r.isPresent; 
               memberNotes[key] = r.note || "";
               
               const selectorKey = key.replace(/([ #;?%&,.+*~\':"!^$[\]()=>|/@])/g, '\\$1');
               const el = document.querySelector(`.member-item[data-key="${selectorKey}"]`);
               if (el) { 
                   if(r.isPresent) el.classList.add("checked"); 
                   const noteInput = el.querySelector(".note-input");
                   if (noteInput) noteInput.value = r.note || ""; 
               }
            }
          });
          document.getElementById("suggestionInput").value = res.data.suggestion || "";
          showMsg("success", "불러오기 완료");
        } else {
          document.getElementById("suggestionInput").value = "";
          showMsg("info", "저장된 데이터가 없습니다.");
        }
        updateUI();
      } catch(e) { console.error(e); showMsg("error", "불러오기 실패"); }
    }
    
    document.getElementById("saveBtn").onclick = async () => {
       const btn = document.getElementById("saveBtn");
       btn.textContent = "저장 중..."; btn.disabled = true;
       const list = [];
       for(let key in attendance) {
         const [name, cohort] = key.split("||"); 
         list.push({ name, cohort, isPresent: attendance[key], note: memberNotes[key] || "" });
       }
       try {
         await jsonp(GOOGLE_SCRIPT_URL, {
           action: "saveAttendance", teamId: selectedTeam.id, teamName: selectedTeam.name, leader: selectedTeam.leader,
           date: document.getElementById("dateInput").value, suggestion: document.getElementById("suggestionInput").value, attendance: JSON.stringify(list)
         });
         showMsg("success", "저장되었습니다!");
       } catch(e) { showMsg("error", "저장 실패"); }
       finally { btn.textContent = "출석 정보 저장하기"; btn.disabled = false; }
    };

    document.getElementById("forceLoadBtn").onclick = loadServerAttendance;
    document.getElementById("dateInput").onchange = loadServerAttendance;
    document.getElementById("teamBackBtn").onclick = () => showPage("homePage");
    document.getElementById("memberSearch").oninput = (e) => {
      const val = e.target.value.toLowerCase();
      document.querySelectorAll(".member-item").forEach(el => el.style.display = el.dataset.key.toLowerCase().includes(val) ? "" : "none");
    };

    document.getElementById("adminBtn").onclick = () => adminAuthed ? showAdminDashboard() : openPasswordModal("admin");
    document.getElementById("adminBackBtn").onclick = () => { adminAuthed = false; showPage("homePage"); };

    function showAdminDashboard() {
      showPage("adminDashboard");
      const today = new Date().toISOString().split("T")[0];
      ["adminDateInput", "adminNotesDateInput", "adminSuggestionsDateInput", "memberStartDate", "memberEndDate"].forEach(id => {
        if(!document.getElementById(id).value) document.getElementById(id).value = today;
      });
      refreshAdminStats(); loadMemberListForAdmin();
    }

    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        ["adminStatsTab", "adminNotesTab", "adminSuggestionsTab", "adminMembersTab"].forEach(t => document.getElementById(t).classList.add("hidden"));
        const target = btn.dataset.tab;
        if(target==="stats") { document.getElementById("adminStatsTab").classList.remove("hidden"); refreshAdminStats(); }
        else if(target==="notes") { document.getElementById("adminNotesTab").classList.remove("hidden"); refreshAdminNotes(); }
        else if(target==="suggestions") { document.getElementById("adminSuggestionsTab").classList.remove("hidden"); refreshAdminSuggestions(); }
        else { document.getElementById("adminMembersTab").classList.remove("hidden"); }
      };
    });

    async function refreshAdminStats() {
      const res = await jsonp(GOOGLE_SCRIPT_URL, { action: "getStatsByDate", date: document.getElementById("adminDateInput").value });
      let html = `<table class="attendance-table"><thead><tr><th>사랑방</th><th>현황</th><th>출석</th><th>결석</th><th>비율</th></tr></thead><tbody>`;
      TEAMS.forEach(t => {
        const stat = (res.data && res.data.teamStats) ? res.data.teamStats.find(x => String(x.teamId) === String(t.id)) : null;
        const present = stat ? Number(stat.present) || 0 : 0;
        const absent = stat ? Number(stat.absent) || 0 : 0;
        const submitted = stat ? !!stat.submitted : false;
        const total = present + absent;
        const badge = submitted ? '<span class="status-badge status-submitted">제출</span>' : '<span class="status-badge status-pending">미제출</span>';
        html += `<tr onclick="toggleDetail('${t.id}')" style="cursor:pointer"><td>${t.name}</td><td>${badge}</td><td>${present}</td><td>${absent}</td><td>${total>0?((present/total)*100).toFixed(0):0}%</td></tr><tr id="detail-${t.id}" class="hidden"><td colspan="5" id="content-${t.id}" style="background:#f9fafb; padding:15px; font-size:0.85rem;">로딩 중...</td></tr>`;
      });
      document.getElementById("attendanceTable").innerHTML = html + `</tbody></table>`;
    }

    window.toggleDetail = async (id) => {
      const row = document.getElementById(`detail-${id}`);
      if(!row.classList.contains("hidden")) { row.classList.add("hidden"); return; }
      row.classList.remove("hidden");
      const content = document.getElementById(`content-${id}`);
      try {
        const res = await jsonp(GOOGLE_SCRIPT_URL, { action: "loadAttendance", teamId: id, date: document.getElementById("adminDateInput").value });
        if(!res.data.found) { content.innerHTML = "제출된 데이터가 없습니다."; return; }
        const p = res.data.attendance.filter(a=>a.isPresent).map(a=>`<span style="display:inline-block; background:#dbeafe; color:#2563eb; padding:2px 8px; border-radius:15px; margin:2px;">${a.name}</span>`).join(" ");
        const ab = res.data.attendance.filter(a=>!a.isPresent).map(a=>`<span style="display:inline-block; background:#fee2e2; color:#b91c1c; padding:2px 8px; border-radius:15px; margin:2px;">${a.name}</span>`).join(" ");
        content.innerHTML = `<div><strong>출석:</strong> ${p||"없음"}</div><div style="margin-top:8px;"><strong>결석:</strong> ${ab||"없음"}</div>`;
      } catch(e) { content.innerHTML = "오류 발생"; }
    };

    async function refreshAdminNotes() {
      const res = await jsonp(GOOGLE_SCRIPT_URL, { action: "getNotesByDate", date: document.getElementById("adminNotesDateInput").value });
      let html = `<table class="attendance-table"><thead><tr><th>사랑방</th><th>이름</th><th>내용</th></tr></thead><tbody>`;
      if(!res.data || res.data.length===0) html += `<tr><td colspan="3" style="text-align:center; color:#9ca3af;">내역이 없습니다.</td></tr>`;
      else res.data.forEach(n => { html += `<tr><td>${n.teamName}</td><td>${n.name}</td><td>${n.note}</td></tr>`; });
      document.getElementById("notesTable").innerHTML = html + "</tbody></table>";
    }

    async function refreshAdminSuggestions() {
      const res = await jsonp(GOOGLE_SCRIPT_URL, { action: "getSuggestionsByDate", date: document.getElementById("adminSuggestionsDateInput").value });
      let html = `<table class="attendance-table"><thead><tr><th>사랑방</th><th>건의사항</th></tr></thead><tbody>`;
      if(!res.data || res.data.length===0) html += `<tr><td colspan="2" style="text-align:center; color:#9ca3af;">내역이 없습니다.</td></tr>`;
      else res.data.forEach(s => { html += `<tr><td>${s.teamName}</td><td>${s.suggestion}</td></tr>`; });
      document.getElementById("suggestionsTable").innerHTML = html + "</tbody></table>";
    }

    async function loadMemberListForAdmin() {
      const res = await jsonp(GOOGLE_SCRIPT_URL, { action: "getAllMembers" });
      const sel = document.getElementById("memberSelect");
      sel.innerHTML = `<option value="">방원 선택</option>`;
      (res.data || []).forEach(m => {
        const cohort = normalizeCohort(m.cohort);
        const opt = document.createElement("option");
        opt.value = m.name + "||" + cohort;
        opt.textContent = `${m.name} (${cohort})`;
        sel.appendChild(opt);
      });
    }

    document.getElementById("memberSelect").onchange = async () => {
      const val = document.getElementById("memberSelect").value;
      if(!val) return;
      const [name, cohort] = val.split("||");
      const res = await jsonp(GOOGLE_SCRIPT_URL, { action: "getMemberHistory", name, cohort, startDate: document.getElementById("memberStartDate").value, endDate: document.getElementById("memberEndDate").value });
      document.getElementById("memberResultArea").classList.remove("hidden");
      renderChart(res.data.monthly);
      let html = `<table class="attendance-table"><thead><tr><th>날짜</th><th>결과</th><th>특이사항</th></tr></thead><tbody>`;
      res.data.sessions.forEach(s => { html += `<tr><td>${s.date}</td><td>${s.isPresent?"✅ 출석":"❌ 결석"}</td><td>${s.note||"-"}</td></tr>`; });
      document.getElementById("memberHistoryTable").innerHTML = html + "</tbody></table>";
    };

    function renderChart(monthlyData) {
      const ctx = document.getElementById('memberChart').getContext('2d');
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: monthlyData.map(d=>d.month), datasets: [{ label: '월별 출석률 (%)', data: monthlyData.map(d=>parseFloat(d.rate)), backgroundColor: '#3b82f6', borderRadius: 5 }] },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    document.getElementById("saveToSheetBtn").onclick = async () => {
      const btn = document.getElementById("saveToSheetBtn");
      const startDate = document.getElementById("memberStartDate").value;
      const endDate = document.getElementById("memberEndDate").value;
      if (!startDate || !endDate) {
        alert("시작일과 종료일을 모두 선택해주세요.");
        return;
      }
      if (!confirm(`${startDate}부터 ${endDate}까지의 통계를 구글 스프레드시트의 새 탭으로 저장하시겠습니까?`)) return;
      btn.disabled = true;
      btn.textContent = "저장 중... (잠시만 기다려주세요)";
      try {
        const res = await jsonp(GOOGLE_SCRIPT_URL, { action: "saveSummaryToSheet", startDate, endDate });
        if (res.status === "success") alert("성공!\n" + res.message);
        else alert("오류: " + res.message);
      } catch(e) {
        alert("저장 중 오류가 발생했습니다.");
      }
      btn.disabled = false;
      btn.textContent = "통계 구글 시트로 저장";
    };

    ["adminDateInput", "adminNotesDateInput", "adminSuggestionsDateInput"].forEach(id => {
      document.getElementById(id).onchange = () => {
        if(id==="adminDateInput") refreshAdminStats();
        else if(id==="adminNotesDateInput") refreshAdminNotes();
        else refreshAdminSuggestions();
      };
    });
  </script>
</body>
</html>
