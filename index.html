<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>뉴웨이브 청1 사랑방 출석체크</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #f9fafb; min-height: 100vh; }

    .header { background: white; border-bottom: 1px solid #e5e7eb; padding: 1.5rem 1rem; position: sticky; top: 0; z-index: 100; }
    .header-content { max-width: 1200px; margin: 0 auto; position: relative; }
    .header-title { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    h1 { font-size: 1.5rem; color: #111827; }
    .subtitle { color: #6b7280; font-size: 0.875rem; }

    .admin-button { position: absolute; top: 0; right: 0; background: #6b7280; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: 0.875rem; }
    .admin-button:hover { background: #4b5563; }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }

    /* 홈 팀 카드 */
    .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .team-card { background: white; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s; }
    .team-card:hover { border-color: #2563eb; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .team-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .team-number { width: 3rem; height: 3rem; background: #dbeafe; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: #2563eb; font-weight: bold; font-size: 1.25rem; }
    .team-card:hover .team-number { background: #2563eb; color: white; }
    .member-count { background: #f3f4f6; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; color: #6b7280; }
    .team-name { font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 0.25rem; }

    .back-button { display: flex; align-items: center; gap: 0.5rem; color: #6b7280; background: none; border: none; cursor: pointer; font-size: 1rem; margin-bottom: 1rem; padding: 0.5rem; }
    .back-button:hover { color: #111827; }

    /* 날짜/요약 */
    .date-section { background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1.25rem; }
    .date-label { font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
    .date-input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 16px; } /* iOS 확대 방지 */

    .summary-box { background: #eff6ff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #bfdbfe; margin-bottom: 1rem; }
    .summary-content { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .summary-count { font-size: 1.5rem; font-weight: bold; color: #2563eb; }
    .progress-bar { background: #e5e7eb; border-radius: 9999px; height: 0.5rem; overflow: hidden; }
    .progress-fill { background: #2563eb; height: 100%; transition: width 0.3s; }

    /* 검색 + 그리드 */
    .search-section { background: white; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1rem; }
    .search-input { width: 100%; padding: 0.65rem 0.9rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 16px; }

    .member-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    @media (min-width: 768px) {
      .member-list { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    }

    .member-item { background: white; padding: 0.85rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; transition: all 0.2s; }
    .member-item.checked { background: #eff6ff; border-color: #2563eb; }

    .member-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; gap: 0.5rem; }
    .member-name { font-size: 1rem; font-weight: 800; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .checkbox { width: 1.75rem; height: 1.75rem; border-radius: 9999px; border: 2px solid #d1d5db; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .member-item.checked .checkbox { background: #2563eb; border-color: #2563eb; }
    .checkmark { display: none; color: white; font-weight: bold; font-size: 0.95rem; }
    .member-item.checked .checkmark { display: block; }

    /* 특이사항 (아래) */
    .note-section { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; }
    .note-label { font-size: 0.8rem; font-weight: 800; color: #6b7280; margin-bottom: 0.35rem; }
    .note-input { width: 100%; padding: 0.55rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 16px; }

    /* 건의사항 */
    .suggestion-section { background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
    .suggestion-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 16px; min-height: 80px; }

    /* 하단 저장바 */
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    .sticky-actions {
      position: sticky;
      bottom: 0;
      background: rgba(249, 250, 251, 0.95);
      border-top: 1px solid #e5e7eb;
      padding: 0.75rem 0 calc(0.75rem + var(--safe-bottom)) 0;
      backdrop-filter: blur(6px);
    }
    .save-button { width: 100%; background: #2563eb; color: white; padding: 0.95rem; border-radius: 0.5rem; border: none; font-size: 1.05rem; font-weight: 900; cursor: pointer; }
    .save-button:hover { background: #1d4ed8; }

    .message { padding: 0.85rem 1rem; border-radius: 0.5rem; text-align: center; font-weight: 800; margin-top: 0.75rem; }
    .message.success { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
    .message.error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .message.info { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }

    /* 관리자 */
    .dashboard-tabs { display: flex; gap: 1rem; margin-bottom: 1.25rem; border-bottom: 2px solid #e5e7eb; }
    .tab-button { padding: 0.75rem 1.5rem; background: none; border: none; cursor: pointer; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px; font-weight: 800; }
    .tab-button.active { color: #2563eb; border-bottom-color: #2563eb; }

    .admin-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
    }
    @media (max-width: 640px) {
      .dashboard-tabs { flex-wrap: wrap; gap: 0.5rem; border-bottom: 1px solid #e5e7eb; }
      .tab-button { flex: 1 1 140px; text-align: center; padding: 0.65rem 0.75rem; }
      .admin-summary { grid-template-columns: 1fr; }
      .container { padding: 1rem 1rem; }
      .header { padding: 1rem 1rem; }
    }

    .admin-summary-card { background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
    .admin-summary-label { font-size: 0.875rem; color: #6b7280; font-weight: 800; margin-bottom: 0.25rem; }
    .admin-summary-value { font-size: 1.6rem; font-weight: 950; color: #111827; }
    .admin-summary-note { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }

    .attendance-table, .notes-table { background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb; overflow-x: auto; }
    .attendance-table table, .notes-table table { width: 100%; border-collapse: collapse; }
    .attendance-table th, .notes-table th { background: #f9fafb; padding: 0.75rem; text-align: left; font-size: 0.875rem; font-weight: 900; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
    .attendance-table td, .notes-table td { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; vertical-align: top; }

    .suggestion-list { background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb; padding: 1rem; }
    .suggestion-item { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
    .suggestion-team { font-weight: 950; color: #111827; }

    .hidden { display: none; }

    /* 비밀번호 모달 */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 999;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      background: white;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    .modal-header { padding: 1rem 1rem 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; }
    .modal-title { font-size: 1.1rem; font-weight: 950; color: #111827; }
    .modal-subtitle { margin-top: 0.25rem; font-size: 0.9rem; color: #6b7280; }
    .modal-body { padding: 1rem; }
    .modal-input { width: 100%; padding: 0.8rem 0.9rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 16px; }
    .modal-error { margin-top: 0.75rem; color: #b91c1c; font-weight: 800; font-size: 0.9rem; }
    .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; padding: 0 1rem 1rem 1rem; }
    .modal-btn { border: none; border-radius: 0.5rem; padding: 0.85rem 0.9rem; font-weight: 950; cursor: pointer; font-size: 0.95rem; }
    .modal-btn.primary { background: #2563eb; color: white; }
    .modal-btn.primary:hover { background: #1d4ed8; }
    .modal-btn.ghost { background: #f3f4f6; color: #111827; }
    .modal-btn.ghost:hover { background: #e5e7eb; }
  </style>
</head>

<body>
  <!-- 홈 -->
  <div id="homePage">
    <div class="header">
      <div class="header-content">
        <button class="admin-button" onclick="openAdminPassword()">관리자</button>
        <div class="header-title"><h1>사랑방 출석체크</h1></div>
        <p class="subtitle">사랑방을 선택해주세요</p>
      </div>
    </div>
    <div class="container">
      <div class="team-grid" id="teamGrid"></div>
    </div>
  </div>

  <!-- 출석 페이지 -->
  <div id="attendancePage" class="hidden">
    <div class="header">
      <div class="header-content">
        <button class="back-button" onclick="goHome()">← 돌아가기</button>
        <h1 id="selectedTeamName"></h1>
        <p class="subtitle" id="selectedTeamLeader"></p>
      </div>
    </div>

    <div class="container">
      <div class="date-section">
        <div class="date-label">날짜 선택</div>
        <input type="date" class="date-input" id="dateInput" />
      </div>

      <div class="summary-box">
        <div class="summary-content">
          <span>출석 현황</span>
          <span class="summary-count" id="attendanceCount">0 / 0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="search-section">
        <input id="memberSearch" class="search-input" placeholder="이름 검색 (예: 홍길동)" />
      </div>

      <div class="member-list" id="memberList"></div>

      <div class="suggestion-section">
        <div class="date-label">건의사항 (선택)</div>
        <textarea class="suggestion-textarea" id="suggestionInput" placeholder="건의사항을 작성해주세요"></textarea>
      </div>

      <div class="sticky-actions">
        <button class="save-button" onclick="saveAttendance()">출석 정보 저장</button>
        <div id="messageBox" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- 관리자 대시보드 -->
  <div id="adminDashboard" class="hidden">
    <div class="header">
      <div class="header-content">
        <button class="back-button" onclick="goHome()">← 돌아가기</button>
        <h1>관리자 대시보드</h1>
      </div>
    </div>

    <div class="container">
      <div class="dashboard-tabs">
        <button class="tab-button active" onclick="switchAdminTab('stats')">출석 현황</button>
        <button class="tab-button" onclick="switchAdminTab('notes')">특이사항</button>
        <button class="tab-button" onclick="switchAdminTab('suggestions')">건의사항</button>
      </div>

      <div id="adminStatsTab">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminDateInput" />
        </div>

        <div class="admin-summary">
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 출석</div>
            <div class="admin-summary-value" id="adminTotalPresent">0명</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 결석</div>
            <div class="admin-summary-value" id="adminTotalAbsent">0명</div>
          </div>
          <div class="admin-summary-card">
            <div class="admin-summary-label">전체 출석률</div>
            <div class="admin-summary-value" id="adminTotalRate">0%</div>
          </div>
        </div>
        <div class="admin-summary-note" id="adminSummaryNote"></div>

        <div class="attendance-table" id="attendanceTable"></div>
      </div>

      <div id="adminNotesTab" class="hidden">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminNotesDateInput" />
        </div>
        <div class="notes-table" id="notesTable"></div>
      </div>

      <div id="adminSuggestionsTab" class="hidden">
        <div class="date-section">
          <div class="date-label">주차 선택</div>
          <input type="date" class="date-input" id="adminSugDateInput" />
        </div>
        <div class="suggestion-list" id="suggestionsList"></div>
      </div>
    </div>
  </div>

  <!-- 비밀번호 모달 -->
  <div id="passwordModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">비밀번호 입력</div>
        <div class="modal-subtitle" id="modalSubtitle"></div>
      </div>
      <div class="modal-body">
        <input type="password" id="modalPassword" class="modal-input" placeholder="비밀번호" />
        <div id="modalError" class="modal-error hidden"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn ghost" onclick="closePasswordModal()">취소</button>
        <button class="modal-btn primary" onclick="submitPasswordModal()">확인</button>
      </div>
    </div>
  </div>

  <script>
    /*****************
     * Apps Script URL
     *****************/
    var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxC4ZzJh1wS4N6KvWEx9oMzvYxqm0_c2ZrMoqoipJsBNAvlHLsUqV4IhQnFvDSbbh8EtQ/exec';

    /*****************
     * Team definition
     *****************/
    var TEAMS = [
      {id:1,name:'권준형 사랑방',leader:'방장: 권준형',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:2,name:'김나림 사랑방',leader:'방장: 김나림',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:3,name:'문유안 사랑방',leader:'방장: 문유안',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:4,name:'벡에스더 사랑방',leader:'방장: 벡에스더',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:5,name:'이예정 사랑방',leader:'방장: 이예정',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:6,name:'이지빈 사랑방',leader:'방장: 이지빈',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:7,name:'이하은 사랑방',leader:'방장: 이하은',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:8,name:'이희진 사랑방',leader:'방장: 이희진',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:9,name:'임사랑 사랑방',leader:'방장: 임사랑',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:10,name:'장하늘 사랑방',leader:'방장: 장하늘',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:11,name:'하재영 사랑방',leader:'방장: 하재영',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']},
      {id:12,name:'Wee팀',leader:'방장: 권하경, 최수인',members:['방원1','방원2','방원3','방원4','방원5','방원6','방원7','방원8','방원9','방원10','방원11','방원12','방원13','방원14','방원15','방원16','방원17','방원18','방원19','방원20']}
    ];

    /*****************
     * State
     *****************/
    var selectedTeam = null;
    var attendance = {};
    var memberNotes = {};
    var isLoadingFromServer = false;

    // date defaults
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').value = today;
    document.getElementById('adminDateInput').value = today;
    document.getElementById('adminNotesDateInput').value = today;
    document.getElementById('adminSugDateInput').value = today;

    /*****************
     * Token storage
     *****************/
    function tokenKeyTeam(teamId){ return 'nw_team_token:' + teamId; }
    function tokenKeyAdmin(){ return 'nw_admin_token'; }

    function getTeamToken(teamId){ return localStorage.getItem(tokenKeyTeam(teamId)) || ''; }
    function setTeamToken(teamId, token){ localStorage.setItem(tokenKeyTeam(teamId), token); }
    function clearTeamToken(teamId){ localStorage.removeItem(tokenKeyTeam(teamId)); }

    function getAdminToken(){ return localStorage.getItem(tokenKeyAdmin()) || ''; }
    function setAdminToken(token){ localStorage.setItem(tokenKeyAdmin(), token); }
    function clearAdminToken(){ localStorage.removeItem(tokenKeyAdmin()); }

    /*****************
     * JSONP helper (CORS 우회 GET)
     *****************/
    function jsonp(url, params){
      return new Promise(function(resolve, reject){
        var cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
        params = params || {};
        params.callback = cb;

        var qs = Object.keys(params).map(function(k){
          return encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
        }).join('&');

        var script = document.createElement('script');
        script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + qs;

        var timeout = setTimeout(function(){
          cleanup();
          reject(new Error('JSONP timeout'));
        }, 12000);

        function cleanup(){
          clearTimeout(timeout);
          if (script && script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        }

        window[cb] = function(data){
          cleanup();
          resolve(data);
        };

        script.onerror = function(){
          cleanup();
          reject(new Error('JSONP network error'));
        };

        document.body.appendChild(script);
      });
    }

    function apiGet(action, params){
      params = params || {};
      params.action = action;
      return jsonp(GOOGLE_SCRIPT_URL, params);
    }

    /*****************
     * UI helpers
     *****************/
    function cssEsc(v) { if (window.CSS && CSS.escape) return CSS.escape(v); return String(v).replace(/["\\]/g, '\\$&'); }

    function showMsg(type, text) {
      var box = document.getElementById('messageBox');
      box.className = 'message ' + (type || '');
      box.textContent = text || '';
      box.classList.remove('hidden');
      setTimeout(function(){ box.classList.add('hidden'); }, 2500);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    /*****************
     * Password modal
     *****************/
    var modalState = { mode: null, team: null };

    function openPasswordModal(opts) {
      modalState.mode = opts.mode || null;
      modalState.team = opts.team || null;

      document.getElementById('modalTitle').textContent = opts.title || '비밀번호 입력';
      document.getElementById('modalSubtitle').textContent = opts.subtitle || '';
      document.getElementById('modalPassword').value = '';
      document.getElementById('modalError').classList.add('hidden');
      document.getElementById('modalError').textContent = '';
      document.getElementById('passwordModal').classList.remove('hidden');

      setTimeout(function(){ document.getElementById('modalPassword').focus(); }, 0);
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.add('hidden');
      modalState.mode = null;
      modalState.team = null;
    }

    function setModalError(msg) {
      var el = document.getElementById('modalError');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    async function submitPasswordModal() {
      var pw = document.getElementById('modalPassword').value || '';

      try {
        if (modalState.mode === 'admin') {
          var resA = await apiGet('authAdmin', { password: pw });
          if (!resA || !resA.ok) {
            setModalError((resA && resA.error) ? resA.error : '비밀번호가 틀렸습니다.');
            return;
          }
          setAdminToken(resA.token);
          closePasswordModal();
          showAdminDashboard();
          return;
        }

        if (modalState.mode === 'team' && modalState.team) {
          var teamId = String(modalState.team.id);
          var resT = await apiGet('authTeam', { teamId: teamId, password: pw });
          if (!resT || !resT.ok) {
            setModalError((resT && resT.error) ? resT.error : '비밀번호가 틀렸습니다.');
            return;
          }
          setTeamToken(teamId, resT.token);
          closePasswordModal();
          selectTeam(modalState.team);
          return;
        }
      } catch (e) {
        setModalError('서버 연결에 실패했습니다. 네트워크를 확인해주세요.');
      }
    }

    document.getElementById('modalPassword').addEventListener('keydown', function(e){
      if (e.key === 'Enter') submitPasswordModal();
      if (e.key === 'Escape') closePasswordModal();
    });

    document.getElementById('passwordModal').addEventListener('click', function(e){
      if (e.target.id === 'passwordModal') closePasswordModal();
    });

    /*****************
     * Navigation
     *****************/
    function hideAll(){
      document.getElementById('homePage').classList.add('hidden');
      document.getElementById('attendancePage').classList.add('hidden');
      document.getElementById('adminDashboard').classList.add('hidden');
    }

    function goHome(){
      hideAll();
      document.getElementById('homePage').classList.remove('hidden');
      selectedTeam = null;
    }

    /*****************
     * Home grid
     *****************/
    function initTeamGrid(){
      var g = document.getElementById('teamGrid');
      g.innerHTML = '';
      TEAMS.forEach(function(t){
        var c = document.createElement('div');
        c.className = 'team-card';
        c.onclick = function(){ attemptEnterTeam(t); };
        c.innerHTML =
          '<div class="team-card-header">' +
            '<div class="team-number">' + t.id + '</div>' +
            '<div class="member-count">' + t.members.length + '명</div>' +
          '</div>' +
          '<div class="team-name">' + t.name + '</div>' +
          '<p style="font-size:0.875rem;color:#6b7280;">' + t.leader + '</p>';
        g.appendChild(c);
      });
    }

    function openAdminPassword(){
      openPasswordModal({
        mode: 'admin',
        title: '관리자 탭 비밀번호',
        subtitle: '관리자 대시보드에 प्रवेश하려면 비밀번호를 입력하세요.'
      });
    }

    function attemptEnterTeam(team){
      var token = getTeamToken(String(team.id));
      if (token) {
        // 토큰이 만료되었으면 서버 호출 시 걸러짐 → 그때 다시 비번 요구
        selectTeam(team);
        return;
      }
      openPasswordModal({
        mode: 'team',
        team: team,
        title: team.name + ' 비밀번호',
        subtitle: '해당 사랑방장만 출석/특이사항을 수정할 수 있습니다.'
      });
    }

    /*****************
     * Attendance page render
     *****************/
    function buildMemberList(team){
      var m = document.getElementById('memberList');
      m.innerHTML = '';

      team.members.forEach(function(n){
        var item = document.createElement('div');
        item.className = 'member-item';
        item.setAttribute('data-name', n);

        item.innerHTML =
          '<div class="member-header" data-name="'+ escapeHtml(n) +'">' +
            '<span class="member-name">'+ escapeHtml(n) +'</span>' +
            '<div class="checkbox"><span class="checkmark">✓</span></div>' +
          '</div>' +
          '<div class="note-section">' +
            '<div class="note-label">특이사항</div>' +
            '<input type="text" class="note-input" data-name="'+ escapeHtml(n) +'" placeholder="특이사항 입력" />' +
          '</div>';

        m.appendChild(item);
      });
    }

    function resetAttendanceState(team){
      attendance = {};
      memberNotes = {};
      document.getElementById('suggestionInput').value = '';
      team.members.forEach(function(n){ attendance[n] = false; memberNotes[n] = ''; });
    }

    function updateCount(){
      var c = 0;
      for (var k in attendance) if (attendance[k]) c++;
      var t = selectedTeam ? selectedTeam.members.length : 0;
      document.getElementById('attendanceCount').textContent = c + ' / ' + t;
      document.getElementById('progressFill').style.width = (t > 0 ? (c / t) * 100 : 0) + '%';
    }

    function applyMemberFilter(q){
      q = (q || '').trim().toLowerCase();
      var items = document.querySelectorAll('#memberList .member-item');
      for (var i=0; i<items.length; i++){
        var name = (items[i].getAttribute('data-name') || '').toLowerCase();
        items[i].style.display = name.indexOf(q) >= 0 ? '' : 'none';
      }
    }

    function paintStateToUI(team){
      team.members.forEach(function(n){
        var item = document.querySelector('.member-item[data-name="' + cssEsc(n) + '"]');
        if (!item) return;

        item.classList.toggle('checked', !!attendance[n]);
        var input = item.querySelector('.note-input');
        if (input) input.value = memberNotes[n] || '';
      });
      updateCount();
    }

    async function loadFromServer(team, date){
      var token = getTeamToken(String(team.id));
      if (!token) return false;

      try {
        isLoadingFromServer = true;
        var res = await apiGet('getTeamSubmission', { teamId: String(team.id), date: date, token: token });
        if (!res || !res.ok) {
          // 토큰 만료/무효 등
          if (res && (res.error || '').toLowerCase().indexOf('token') >= 0) {
            clearTeamToken(String(team.id));
            showMsg('error', '인증이 만료되었습니다. 비밀번호를 다시 입력해주세요.');
            attemptEnterTeam(team);
          } else {
            showMsg('error', '데이터를 불러오지 못했습니다.');
          }
          return false;
        }

        if (!res.found) {
          // 서버에 없음 → 초기화
          resetAttendanceState(team);
          paintStateToUI(team);
          return true;
        }

        var sub = res.submission || {};
        resetAttendanceState(team);

        // attendance 배열 기반 복원
        var arr = Array.isArray(sub.attendance) ? sub.attendance : [];
        arr.forEach(function(r){
          if (!r || !r.name) return;
          attendance[r.name] = !!r.present;
          memberNotes[r.name] = (r.note || '').toString();
        });

        document.getElementById('suggestionInput').value = (sub.suggestion || '').toString();
        paintStateToUI(team);
        return true;

      } catch(e) {
        showMsg('error', '서버 연결에 실패했습니다.');
        return false;
      } finally {
        isLoadingFromServer = false;
      }
    }

    function selectTeam(team){
      selectedTeam = team;

      document.getElementById('selectedTeamName').textContent = team.name;
      document.getElementById('selectedTeamLeader').textContent = team.leader;

      buildMemberList(team);
      document.getElementById('memberSearch').value = '';

      // 초기 상태
      resetAttendanceState(team);
      paintStateToUI(team);

      hideAll();
      document.getElementById('attendancePage').classList.remove('hidden');

      // 서버에서 해당 날짜 데이터 복원
      var date = document.getElementById('dateInput').value || today;
      showMsg('info', '데이터를 불러오는 중입니다...');
      loadFromServer(team, date).then(function(){
        applyMemberFilter(document.getElementById('memberSearch').value);
      });
    }

    /*****************
     * Toggle / input events
     *****************/
    document.getElementById('memberList').addEventListener('click', function(e){
      if (e.target && e.target.classList.contains('note-input')) return;
      var header = e.target.closest('.member-header');
      if (!header || !selectedTeam) return;
      var name = header.getAttribute('data-name');
      attendance[name] = !attendance[name];

      var item = document.querySelector('.member-item[data-name="' + cssEsc(name) + '"]');
      if (item) item.classList.toggle('checked', !!attendance[name]);

      updateCount();
    });

    document.getElementById('memberList').addEventListener('input', function(e){
      if (!e.target.classList.contains('note-input')) return;
      if (!selectedTeam) return;
      var name = e.target.getAttribute('data-name');
      memberNotes[name] = e.target.value || '';
    });

    document.getElementById('memberSearch').addEventListener('input', function(){
      applyMemberFilter(this.value);
    });

    document.getElementById('dateInput').addEventListener('change', function(){
      if (!selectedTeam) return;
      var date = this.value || today;
      showMsg('info', '데이터를 불러오는 중입니다...');
      loadFromServer(selectedTeam, date);
    });

    /*****************
     * Submit (POST to Apps Script)
     *****************/
    async function saveAttendance(){
      if (!selectedTeam) return;

      var teamId = String(selectedTeam.id);
      var token = getTeamToken(teamId);
      if (!token) {
        showMsg('error', '인증이 필요합니다. 비밀번호를 다시 입력해주세요.');
        attemptEnterTeam(selectedTeam);
        return;
      }

      var dateVal = document.getElementById('dateInput').value || today;

      var payload = {
        action: 'submit',
        teamId: teamId,
        token: token,
        date: dateVal,
        teamName: selectedTeam.name,
        leader: selectedTeam.leader,
        suggestion: document.getElementById('suggestionInput').value || '',
        attendance: selectedTeam.members.map(function(m){
          return { name: m, present: !!attendance[m], note: (memberNotes[m] || '') };
        })
      };

      try {
        // no-cors에서는 응답을 읽지 못하지만, 서버에는 정상 기록됩니다.
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        showMsg('success', '저장되었습니다!');
        // 저장 직후 서버에서 다시 읽어 화면 정합성 확보
        loadFromServer(selectedTeam, dateVal);
      } catch(e) {
        showMsg('error', '저장에 실패했습니다. 네트워크를 확인해주세요.');
      }
    }

    /*****************
     * Admin dashboard
     *****************/
    function showAdminDashboard(){
      hideAll();
      document.getElementById('adminDashboard').classList.remove('hidden');
      loadAdminData();
    }

    function switchAdminTab(tab){
      var buttons = document.querySelectorAll('.tab-button');
      for (var i=0; i<buttons.length; i++) buttons[i].classList.remove('active');

      if (tab === 'stats') buttons[0].classList.add('active');
      if (tab === 'notes') buttons[1].classList.add('active');
      if (tab === 'suggestions') buttons[2].classList.add('active');

      document.getElementById('adminStatsTab').classList.toggle('hidden', tab !== 'stats');
      document.getElementById('adminNotesTab').classList.toggle('hidden', tab !== 'notes');
      document.getElementById('adminSuggestionsTab').classList.toggle('hidden', tab !== 'suggestions');

      loadAdminData();
    }

    async function loadAdminData(){
      var token = getAdminToken();
      if (!token) {
        // 관리자 토큰 없으면 다시 비번 요청
        openAdminPassword();
        return;
      }

      var date = document.getElementById('adminDateInput').value || today;
      var dateNotes = document.getElementById('adminNotesDateInput').value || today;
      var dateSug = document.getElementById('adminSugDateInput').value || today;

      // 탭별 날짜가 다를 수 있어서 각각 요청(하지만 서버 부담 줄이려면 동일 날짜로 맞추는 것도 가능)
      await renderAdminStats(date, token);
      await renderAdminNotes(dateNotes, token);
      await renderAdminSuggestions(dateSug, token);
    }

    async function fetchAdminByDate(date, token){
      var res = await apiGet('getSubmissionsByDate', { date: date, token: token });
      if (!res || !res.ok) {
        // 토큰 만료/무효
        clearAdminToken();
        showMsg('error', '관리자 인증이 만료되었습니다. 다시 입력해주세요.');
        openAdminPassword();
        return null;
      }
      return res;
    }

    async function renderAdminStats(date, token){
      var data = await fetchAdminByDate(date, token);
      if (!data) return;

      // 서버는 제출된 팀만 data.teams로 반환. → 프론트에서 전체 TEAMS에 맞춰 미제출 표시
      var submittedMap = {};
      (data.teams || []).forEach(function(t){ submittedMap[String(t.teamId)] = t; });

      var submittedCount = 0;
      var totalPresent = 0;
      var totalMembers = 0;

      var rows = '';
      TEAMS.forEach(function(team){
        var key = String(team.id);
        var sub = submittedMap[key];

        if (sub) {
          submittedCount++;
          totalPresent += Number(sub.present || 0);
          totalMembers += Number(sub.total || 0);

          var rate = (sub.total > 0) ? (Number(sub.present)/Number(sub.total))*100 : 0;
          rows += '<tr>' +
            '<td>' + escapeHtml(team.name) + '</td>' +
            '<td>' + escapeHtml(team.leader) + '</td>' +
            '<td>' + Number(sub.present || 0) + '</td>' +
            '<td>' + Number(sub.absent || 0) + '</td>' +
            '<td>' + rate.toFixed(1) + '%</td>' +
            '<td>제출</td>' +
          '</tr>';
        } else {
          rows += '<tr>' +
            '<td>' + escapeHtml(team.name) + '</td>' +
            '<td>' + escapeHtml(team.leader) + '</td>' +
            '<td>-</td><td>-</td><td>-</td>' +
            '<td style="color:#b91c1c;font-weight:800;">미제출</td>' +
          '</tr>';
        }
      });

      var totalAbsent = totalMembers - totalPresent;
      var totalRate = totalMembers > 0 ? (totalPresent / totalMembers) * 100 : 0;

      document.getElementById('adminTotalPresent').textContent = totalPresent + '명';
      document.getElementById('adminTotalAbsent').textContent = totalAbsent + '명';
      document.getElementById('adminTotalRate').textContent = totalRate.toFixed(1) + '%';
      document.getElementById('adminSummaryNote').textContent =
        '집계 기준: ' + date + ' / 제출 ' + submittedCount + '개 사랑방 / 집계 인원 ' + totalMembers + '명 (미제출은 집계에서 제외)';

      document.getElementById('attendanceTable').innerHTML =
        '<table>' +
          '<thead><tr><th>사랑방</th><th>방장</th><th>출석</th><th>결석</th><th>출석률</th><th>상태</th></tr></thead>' +
          '<tbody>' + rows + '</tbody>' +
        '</table>';
    }

    async function renderAdminNotes(date, token){
      var data = await fetchAdminByDate(date, token);
      if (!data) return;

      var rows = '';
      var notesFlat = data.notesFlat || [];
      // notesFlat: [{teamName, member, note}]
      notesFlat.forEach(function(n){
        rows += '<tr>' +
          '<td>' + escapeHtml(n.teamName || '') + '</td>' +
          '<td>' + escapeHtml(n.member || '') + '</td>' +
          '<td style="white-space:pre-wrap;">' + escapeHtml(n.note || '') + '</td>' +
        '</tr>';
      });

      document.getElementById('notesTable').innerHTML =
        '<table>' +
          '<thead><tr><th>사랑방</th><th>방원</th><th>특이사항</th></tr></thead>' +
          '<tbody>' +
            (rows || '<tr><td colspan="3" style="text-align:center;color:#6b7280;">특이사항이 없습니다.</td></tr>') +
          '</tbody>' +
        '</table>';
    }

    async function renderAdminSuggestions(date, token){
      var data = await fetchAdminByDate(date, token);
      if (!data) return;

      var items = [];
      (data.suggestions || []).forEach(function(s){
        items.push(
          '<div class="suggestion-item">' +
            '<div class="suggestion-team">' + escapeHtml(s.teamName || '') + ' (' + escapeHtml(s.leader || '') + ')</div>' +
            '<div style="margin-top:0.5rem; color:#374151; white-space:pre-wrap;">' + escapeHtml(s.suggestion || '') + '</div>' +
          '</div>'
        );
      });

      document.getElementById('suggestionsList').innerHTML =
        items.length ? items.join('') : '<div style="text-align:center;color:#6b7280;padding:2rem;">건의사항이 없습니다.</div>';
    }

    document.getElementById('adminDateInput').addEventListener('change', loadAdminData);
    document.getElementById('adminNotesDateInput').addEventListener('change', loadAdminData);
    document.getElementById('adminSugDateInput').addEventListener('change', loadAdminData);

    /*****************
     * Init
     *****************/
    initTeamGrid();
  </script>
</body>
</html>
